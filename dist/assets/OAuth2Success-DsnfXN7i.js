import{_ as T,r as i,D as V,c as l,d as v,o as c,a as e,g,t as h,f as D,h as j,x as E,m as z,U as R,i as J}from"./index-DQ4OBKkW.js";const X={key:0,class:"modal fade show d-block",tabindex:"-1",style:{"background-color":"rgba(0,0,0,0.5)","z-index":"1050"}},q={class:"modal-dialog modal-dialog-centered"},H={class:"modal-content"},Q={class:"modal-header"},F={class:"modal-title"},G={key:0,class:"fab fa-google text-danger me-2"},K={key:1,class:"fab fa-facebook text-primary me-2"},W={class:"modal-body"},Y={class:"text-center mb-4"},Z=["src"],ee={class:"row mb-3"},se={class:"col-8"},te={class:"row mb-3"},ne={class:"col-8"},oe={key:0,class:"alert alert-info"},ae={key:1,class:"alert alert-success"},re={class:"modal-footer"},ie=["disabled"],le={key:0,class:"spinner-border spinner-border-sm me-2",role:"status"},ce={__name:"OAuthConfirmDialog",props:{show:{type:Boolean,default:!1},userInfo:{type:Object,default:()=>({})},provider:{type:String,default:"google"},isNewUser:{type:Boolean,default:!1}},emits:["confirm","cancel"],setup(n,{emit:o}){const m=n,f=o,u=i(!1),b=()=>{u.value=!0,f("confirm",{userInfo:m.userInfo,isNewUser:m.isNewUser,provider:m.provider})},y=()=>{f("cancel")};return V(()=>m.show,p=>{p||(u.value=!1)}),(p,a)=>n.show?(c(),l("div",X,[e("div",q,[e("div",H,[e("div",Q,[e("h5",F,[n.provider==="google"?(c(),l("i",G)):v("",!0),n.provider==="facebook"?(c(),l("i",K)):v("",!0),g(" Xác nhận "+h(n.isNewUser?"đăng ký":"đăng nhập"),1)]),e("button",{type:"button",class:"btn-close",onClick:y})]),e("div",W,[e("div",Y,[e("img",{src:n.userInfo.avatar,class:"rounded-circle",width:"80",height:"80",alt:"Avatar"},null,8,Z)]),e("div",{class:D(["alert",n.isNewUser?"alert-warning":"alert-info"])},[e("i",{class:D([n.isNewUser?"fas fa-user-plus":"fas fa-sign-in-alt","me-2"])},null,2),e("strong",null,h(n.isNewUser?"Đăng ký tài khoản mới":"Đăng nhập vào tài khoản hiện có"),1)],2),e("div",ee,[a[0]||(a[0]=e("div",{class:"col-4 text-muted"},"Tên:",-1)),e("div",se,h(n.userInfo.name),1)]),e("div",te,[a[1]||(a[1]=e("div",{class:"col-4 text-muted"},"Email:",-1)),e("div",ne,h(n.userInfo.email),1)]),n.isNewUser?(c(),l("div",oe,a[2]||(a[2]=[e("i",{class:"fas fa-info-circle me-2"},null,-1),g(" Bằng cách tiếp tục, bạn đồng ý với "),e("a",{href:"#",class:"alert-link"},"điều khoản sử dụng",-1),g(" của EasyMart. ")]))):(c(),l("div",ae,a[3]||(a[3]=[e("i",{class:"fas fa-check-circle me-2"},null,-1),g(" Tài khoản đã tồn tại. Bạn sẽ được đăng nhập ngay. ")])))]),e("div",re,[e("button",{type:"button",class:"btn btn-secondary",onClick:y}," Hủy "),e("button",{type:"button",class:"btn btn-primary",onClick:b,disabled:u.value},[u.value?(c(),l("span",le)):v("",!0),g(" "+h(u.value?"Đang xử lý...":n.isNewUser?"Xác nhận đăng ký":"Xác nhận đăng nhập"),1)],8,ie)])])])])):v("",!0)}},ue=T(ce,[["__scopeId","data-v-302d1f8c"]]),de={class:"d-flex justify-content-center align-items-center",style:{"min-height":"80vh",background:"#f8fafc"}},ge={class:"card shadow p-4 border-0",style:{"max-width":"400px",width:"100%","border-radius":"1.5rem"}},he={class:"text-center"},me={key:0,class:"mb-4"},fe={class:"mt-3 text-primary"},ve={key:1,class:"mb-4"},pe={class:"mt-3 text-success"},ye={key:2,class:"mb-4"},be={class:"text-muted mb-3"},ke={__name:"OAuth2Success",setup(n){const o=z(),{forceReloadUser:m}=E(),f=i(!0),u=i(!1),b=i(!1),y=i("Đang xử lý đăng nhập OAuth2..."),p=i(""),a=i(""),k=i(!1),O=i({}),C=i("google"),A=i(!1);j(async()=>{try{y.value="Đang xử lý thông tin đăng nhập...";const r=new URLSearchParams(window.location.search),s=r.get("success"),w=r.get("token"),t=r.get("email"),x=r.get("role"),S=r.get("userId");if(s==="true"&&w){const d=t||"";if(d)try{const{checkEmailDuplicate:U}=E(),$=await U(d);if($.success&&$.result.exists){const _={name:t?t.split("@")[0]:"OAuth User",email:d,avatar:`https://ui-avatars.com/api/?name=${encodeURIComponent(t?t.split("@")[0]:"OAuth User")}&background=007bff&color=fff`};O.value=_,C.value="google",A.value=!1,k.value=!0,f.value=!1;return}else{const _={name:t?t.split("@")[0]:"OAuth User",email:d,avatar:`https://ui-avatars.com/api/?name=${encodeURIComponent(t?t.split("@")[0]:"OAuth User")}&background=007bff&color=fff`};sessionStorage.setItem("pending-oauth-user-info",JSON.stringify(_)),window.history.replaceState({},document.title,"/oauth2/success"),o.push("/register?oauth=pending");return}}catch(U){console.error("Error checking user existence:",U)}const N={id:S||null,name:t?t.split("@")[0]:"OAuth User",email:t||"",phone:"",avatar:`https://ui-avatars.com/api/?name=${encodeURIComponent(t?t.split("@")[0]:"OAuth User")}&background=007bff&color=fff`,joinDate:new Date().toISOString().split("T")[0],totalOrders:0,totalSpent:0,role:x||"USER",loginMethod:"google"};R(w),localStorage.setItem("easymart-user",JSON.stringify(N)),m(),f.value=!1,u.value=!0,p.value=`Chào mừng ${N.name}!`;const I=sessionStorage.getItem("oauth2-frontend-redirect")||localStorage.getItem("easymart-redirect-after-login")||"/";sessionStorage.removeItem("oauth2-frontend-redirect"),localStorage.removeItem("easymart-redirect-after-login"),window.history.replaceState({},document.title,"/oauth2/success"),setTimeout(()=>{I.includes("/login")||I.includes("/register")?o.push("/"):o.push(I)},2e3)}else throw console.error("❌ OAuth2 Login failed"),new Error("OAuth2 đăng nhập thất bại hoặc thiếu thông tin")}catch(r){console.error("OAuth2 Success page error:",r),f.value=!1,b.value=!0,a.value=r.message||"Đăng nhập OAuth2 thất bại"}});const B=()=>{o.push("/login")},M=()=>{o.push("/register?oauth=pending")},P=r=>{const{userInfo:s,isNewUser:w,provider:t}=r;if(w)sessionStorage.setItem("pending-oauth-user-info",JSON.stringify(s)),o.push("/register?oauth=pending");else{const x={id:null,name:s.name,email:s.email,phone:"",avatar:s.avatar,joinDate:new Date().toISOString().split("T")[0],totalOrders:0,totalSpent:0,role:"USER",loginMethod:t},S=new URLSearchParams(window.location.search).get("token");S&&(R(S),localStorage.setItem("easymart-user",JSON.stringify(x)),m()),k.value=!1,u.value=!0,p.value=`Chào mừng ${x.name}! Đăng nhập thành công.`,setTimeout(()=>{const d=sessionStorage.getItem("oauth2-frontend-redirect")||localStorage.getItem("easymart-redirect-after-login")||"/";sessionStorage.removeItem("oauth2-frontend-redirect"),localStorage.removeItem("easymart-redirect-after-login"),d.includes("/login")||d.includes("/register")?o.push("/"):o.push(d)},2e3)}},L=()=>{k.value=!1,o.push("/login")};return(r,s)=>(c(),l("div",null,[e("div",de,[e("div",ge,[e("div",he,[f.value?(c(),l("div",me,[s[0]||(s[0]=e("div",{class:"spinner-border text-primary",role:"status",style:{width:"3rem",height:"3rem"}},[e("span",{class:"visually-hidden"},"Đang xử lý...")],-1)),e("h3",fe,h(y.value),1),s[1]||(s[1]=e("p",{class:"text-muted"},"Vui lòng đợi...",-1))])):v("",!0),u.value?(c(),l("div",ve,[s[2]||(s[2]=e("i",{class:"fas fa-check-circle text-success",style:{"font-size":"3rem"}},null,-1)),e("h3",pe,h(p.value),1),s[3]||(s[3]=e("p",{class:"text-muted"},"Đang chuyển hướng...",-1))])):v("",!0),b.value?(c(),l("div",ye,[s[6]||(s[6]=e("i",{class:"fas fa-exclamation-triangle text-warning",style:{"font-size":"3rem"}},null,-1)),s[7]||(s[7]=e("h3",{class:"mt-3 text-warning"},"Cần đăng ký tài khoản",-1)),e("p",be,h(a.value),1),s[8]||(s[8]=e("div",{class:"alert alert-info"},[e("i",{class:"fas fa-info-circle me-2"}),g(" Bạn sẽ được chuyển hướng đến trang đăng ký để hoàn tất quá trình. ")],-1)),e("button",{onClick:B,class:"btn btn-secondary me-2"},s[4]||(s[4]=[e("i",{class:"fas fa-arrow-left me-2"},null,-1),g(" Quay lại đăng nhập ")])),e("button",{onClick:M,class:"btn btn-primary"},s[5]||(s[5]=[e("i",{class:"fas fa-user-plus me-2"},null,-1),g(" Đăng ký ngay ")]))])):v("",!0)])])]),J(ue,{show:k.value,"user-info":O.value,provider:C.value,"is-new-user":A.value,onConfirm:P,onCancel:L},null,8,["show","user-info","provider","is-new-user"])]))}},xe=T(ke,[["__scopeId","data-v-da7d3c0c"]]);export{xe as default};
