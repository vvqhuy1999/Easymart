import{_ as _e,u as ke,q as Pe,r as _,h as C,i as Te,p as xe,c as r,a as t,d as y,k as U,l as O,m as we,g as d,t as u,w as Ne,s as I,v as H,f as M,x,y as Ie,F as Z,e as Q,z as ie,A as E,B as Se,o as c}from"./index-B2tEJJdM.js";const Ve={class:"checkout-page"},De={class:"container py-5 mt-5"},Ce={"aria-label":"breadcrumb",class:"mb-4"},Me={class:"breadcrumb"},Ae={class:"breadcrumb-item"},He={key:0,class:"breadcrumb-item"},Ee={key:1,class:"breadcrumb-item"},Ue={class:"d-flex justify-content-between align-items-center mb-4"},Oe={class:"mb-0"},$e={key:0,class:"row"},Le={class:"col-lg-8"},je={class:"card mb-4"},Fe={class:"card-body"},Re={class:"row"},Ge={class:"col-md-6 mb-3"},Be={key:0,class:"invalid-feedback"},qe={class:"col-md-6 mb-3"},Ke={key:0,class:"invalid-feedback"},Je={class:"mb-3"},ze={key:0,class:"invalid-feedback"},We={class:"mb-3"},Ze={key:0,class:"invalid-feedback"},Qe={class:"mb-3"},Ye={key:0,class:"mb-3"},Xe={class:"d-flex gap-2"},et={class:"card mb-4"},tt={class:"card-body"},nt={key:0,class:"text-center py-4"},ot={key:1,class:"row"},at={class:"form-check payment-method"},st=["id","value"],lt=["for"],it={class:"d-flex align-items-center"},rt={class:"text-muted small"},ct={key:0,class:"text-info small"},ut={key:2,class:"alert alert-warning"},dt={key:3,class:"row"},ht={class:"col-md-6 mb-3"},mt={class:"form-check payment-method"},gt={key:4,class:"payment-info mt-3 p-3 bg-light rounded"},pt={class:"text-primary mb-3"},ft={class:"row"},vt={class:"col-md-6"},yt={class:"mb-2"},bt={class:"mb-2"},_t={key:0,class:"mb-2"},kt={class:"col-md-6"},Pt={class:"mb-0 text-info"},Tt={key:0,class:"banking-details mt-3 p-3 bg-white rounded border"},xt={class:"row"},wt={class:"col-md-6"},Nt={class:"mb-1"},It={class:"col-lg-4"},St={class:"card sticky-top",style:{top:"100px"}},Vt={class:"card-body"},Dt={class:"order-items mb-3"},Ct=["src","alt"],Mt={class:"flex-grow-1"},At={class:"mb-1"},Ht={class:"d-flex justify-content-between"},Et={class:"text-muted"},Ut={class:"fw-bold"},Ot={class:"order-summary"},$t={class:"d-flex justify-content-between mb-2"},Lt={key:0,class:"d-flex justify-content-between mb-2"},jt={class:"text-info"},Ft={class:"coupon-section mb-3"},Rt={class:"d-flex gap-2 mb-2"},Gt=["disabled"],Bt=["disabled"],qt={key:0},Kt={key:1},Jt={key:0,class:"applied-coupon"},zt={class:"d-flex justify-content-between align-items-center p-3 rounded-3",style:{background:"linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))",border:"1px solid rgba(102, 126, 234, 0.3)"}},Wt={class:"fw-bold",style:{color:"#667eea"}},Zt={class:"small text-muted"},Qt={key:1,class:"d-flex justify-content-between mb-2",style:{color:"#11998e"}},Yt={key:2,class:"available-coupons mt-2"},Xt={class:"d-flex flex-wrap gap-1"},en=["onClick","title"],tn={class:"d-flex justify-content-between mb-3"},nn={class:"text-danger fs-5"},on=["disabled"],an={key:0},sn={key:1},ln={key:2},rn={key:1,class:"row"},cn={class:"col-12"},un={class:"empty-checkout text-center py-5"},dn={class:"text-muted mb-4"},hn={__name:"Checkout",setup(mn){const R=xe(),{formatPrice:P,showNotification:h,products:Y}=ke(),{cart:X,clearCart:re}=Pe(),{user:m,isLoggedIn:w}=Ie(),ee=()=>{console.log("🔍 Debug LocalStorage Data:"),console.log("   - easymart-invoice:",localStorage.getItem("easymart-invoice")),console.log("   - easymart-selected-items:",localStorage.getItem("easymart-selected-items")),console.log("   - easymart-cart:",localStorage.getItem("easymart-cart"));try{const o=JSON.parse(localStorage.getItem("easymart-invoice")||"null");o&&(console.log("   - Invoice parsed:",o),console.log("   - Invoice keys:",Object.keys(o)),console.log("   - chiTietHoaDon:",o.chiTietHoaDon),console.log("   - items:",o.items))}catch(o){console.error("   - Error parsing invoice:",o)}},$=o=>{if(!o)return"/placeholder-image.jpg";const e=Se.IMAGES.PRODUCT_IMAGES(o);return e[0]?`${E.BASE_URL}${e[0]}`:"/placeholder-image.jpg"},te=()=>{console.log("🔐 Checking auth status..."),console.log("   - isLoggedIn:",w),console.log("   - user:",m),console.log("   - orderForm:",s),w&&typeof w.value<"u"?console.log("✅ isLoggedIn is properly initialized"):console.log("❌ isLoggedIn is not properly initialized"),m&&typeof m.value<"u"?console.log("✅ user is properly initialized"):console.log("❌ user is not properly initialized")},ne=async()=>{try{if(!w||!w.value){console.log("⚠️ User chưa đăng nhập hoặc isLoggedIn undefined"),G();return}if(!m||!m.value){console.log("⚠️ User object chưa sẵn sàng hoặc user undefined"),G();return}if(console.log("👤 Pre-filling user info:",m.value),await ce(),m.value.name&&(s.value.fullName=m.value.name),m.value.email&&(s.value.email=m.value.email),m.value.customerInfo){const o=m.value.customerInfo;o.hoTen&&(s.value.fullName=o.hoTen),o.sdt&&(s.value.phone=o.sdt),o.diaChi&&(s.value.address=o.diaChi),o.nguoiDung?.email&&(s.value.email=o.nguoiDung.email)}console.log("✅ Form đã được pre-fill:",s.value)}catch(o){console.error("❌ Lỗi khi pre-fill user info:",o),console.log("🔍 Debug info:",{isLoggedIn:w,user:m,orderForm:s}),G()}},G=()=>{try{console.log("🔄 Trying fallback: getting user info from localStorage...");const o=localStorage.getItem("easymart-user");if(o){const e=JSON.parse(o);console.log("📦 Found user data in localStorage:",e),e.name&&(s.value.fullName=e.name),e.email&&(s.value.email=e.email),console.log("✅ Fallback pre-fill successful")}else console.log("⚠️ No user data found in localStorage")}catch(o){console.error("❌ Fallback also failed:",o)}},ce=async()=>{try{console.log("📡 Fetching shipping info from Profile API..."),ae.value=!0;const o=m.value?.customerInfo?.maKH;if(!o){console.log("⚠️ No maKH found, cannot fetch shipping info");return}const e=B();if(!e){console.log("⚠️ No token found, cannot fetch shipping info");return}const i=`${E.BASE_URL}/api/khachhang/${o}/info`;console.log("🔗 Fetching from endpoint:",i);const n=await fetch(i,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!n.ok){console.log("⚠️ Profile API failed:",n.status);return}const a=await n.json();console.log("📥 Profile API response:",a);let l=null;a?.data?l=a.data:a?.result?l=a.result:a?.hoTen||a?.sdt||a?.diaChi?l=a:Array.isArray(a)&&(l=a[0]),l&&(console.log("✅ Customer data received:",l),m.value?.customerInfo&&(m.value.customerInfo={...m.value.customerInfo,...l}),l.hoTen&&(s.value.fullName=l.hoTen),l.sdt&&(s.value.phone=l.sdt),l.diaChi&&(s.value.address=l.diaChi),l.nguoiDung?.email&&(s.value.email=l.nguoiDung.email),console.log("✅ Shipping info updated from Profile API"))}catch(o){console.error("❌ Error fetching shipping info:",o)}finally{ae.value=!1}},ue=async()=>{try{console.log("📤 Updating shipping info to Profile API...");const o=m.value?.customerInfo?.maKH;if(!o)return console.log("⚠️ No maKH found, cannot update shipping info"),!1;const e=B();if(!e)return console.log("⚠️ No token found, cannot update shipping info"),!1;const i={hoTen:s.value.fullName,sdt:s.value.phone,diaChi:s.value.address,email:s.value.email};console.log("📤 Update data prepared:",i);const n=`${E.BASE_URL}/api/khachhang/${o}/update-info`;console.log("🔗 Update endpoint:",n);const a=await fetch(n,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(i)});if(!a.ok){const v=await a.json().catch(()=>({}));return console.log("⚠️ Update failed:",a.status,v.message),!1}const l=await a.json();return console.log("📥 Update response:",l),l?.success||l?.result?.success||l?.message?.includes("thành công")?(console.log("✅ Shipping info updated successfully"),m.value?.customerInfo&&(m.value.customerInfo={...m.value.customerInfo,hoTen:s.value.fullName,sdt:s.value.phone,diaChi:s.value.address}),!0):(console.log("⚠️ Update response format unexpected:",l),!1)}catch(o){return console.error("❌ Error updating shipping info:",o),!1}},B=()=>document.cookie.split("; ").find(o=>o.startsWith("easymart-token="))?.split("=")[1],oe=async()=>{try{console.log("📡 Fetching payment methods from API..."),K.value=!0,J.value="";const o=await fetch(`${E.BASE_URL}/api/phuongthucthanhtoan`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const e=await o.json();console.log("📥 Payment methods API response:",e);let i=[];if(e?.data)i=e.data;else if(e?.result)i=e.result;else if(Array.isArray(e))i=e;else throw new Error("Unexpected response format");const n=i.filter(a=>a.trangThai===1&&!a.isDeleted);console.log("✅ Active payment methods:",n),j.value=n,n.length>0&&!s.value.paymentMethod&&(s.value.paymentMethod=n[0].tenPTTT)}catch(o){console.error("❌ Error fetching payment methods:",o),J.value="Không thể tải phương thức thanh toán: "+o.message}finally{K.value=!1}},de=o=>({"Tiền Mặt":"fas fa-hand-holding-usd text-success","Chuyển Khoản":"fas fa-university text-primary",MoMo:"fab fa-momo text-danger",ZaloPay:"fas fa-mobile-alt text-warning","Thẻ Tín Dụng":"fas fa-credit-card text-info",VNPay:"fas fa-credit-card text-info"})[o]||"fas fa-credit-card text-secondary",he=o=>({"Tiền Mặt":"Bạn sẽ thanh toán bằng tiền mặt khi nhận hàng.","Chuyển Khoản":"Vui lòng chuyển khoản theo thông tin ngân hàng bên dưới.",MoMo:"Bạn sẽ được chuyển đến app MoMo để hoàn tất thanh toán.",ZaloPay:"Bạn sẽ được chuyển đến app ZaloPay để hoàn tất thanh toán.","Thẻ Tín Dụng":"Bạn sẽ được chuyển đến cổng thanh toán để nhập thông tin thẻ.",VNPay:"Bạn sẽ được chuyển đến cổng thanh toán VNPay để hoàn tất giao dịch."})[o]||"Vui lòng làm theo hướng dẫn thanh toán.",L=_(!1),q=_(!1),f=_(""),p=_({}),ae=_(!1),j=_([]),K=_(!1),J=_(""),S=_(""),g=_(null),F=_(!1),z=_([{code:"WELCOME10",description:"Giảm 10% cho đơn hàng đầu tiên",discountType:"percentage",discountValue:10,minOrderValue:1e5,maxDiscount:5e4},{code:"SAVE50K",description:"Giảm 50.000đ cho đơn từ 500.000đ",discountType:"fixed",discountValue:5e4,minOrderValue:5e5,maxDiscount:5e4},{code:"VIP20",description:"Giảm 20% cho khách VIP (tối đa 100k)",discountType:"percentage",discountValue:20,minOrderValue:2e5,maxDiscount:1e5}]),s=_({fullName:"",phone:"",email:"",address:"",notes:"",paymentMethod:"cod"}),b=_([]),A=C(()=>b.value.reduce((o,e)=>o+(e.product?.price||0)*e.quantity,0)),V=C(()=>{if(!g.value)return 0;const o=g.value,e=A.value;if(e<o.minOrderValue)return 0;let i=0;switch(o.discountType){case"percentage":i=e*o.discountValue/100;break;case"fixed":i=o.discountValue;break;case"shipping":i=0;break;default:i=0}return Math.min(i,o.maxDiscount)}),N=C(()=>{const o=k.value?.phiGiaoDich||0;return A.value-V.value+o}),W=C(()=>b.value.reduce((o,e)=>o+e.quantity,0)),me=C(()=>s.value.fullName&&s.value.phone&&s.value.address&&s.value.paymentMethod),k=C(()=>j.value.find(o=>o.tenpttt===s.value.paymentMethod)),T=C(()=>b.value.length===1&&!1),ge=()=>{const o=Date.now().toString().slice(-6),e=Math.random().toString(36).substr(2,4).toUpperCase();return`EM${o}${e}`},pe=()=>(p.value={},s.value.fullName.trim()||(p.value.fullName="Vui lòng nhập họ và tên"),s.value.phone.trim()?/^[0-9]{10,11}$/.test(s.value.phone.replace(/\s/g,""))||(p.value.phone="Số điện thoại không hợp lệ"):p.value.phone="Vui lòng nhập số điện thoại",s.value.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.value.email)&&(p.value.email="Email không hợp lệ"),s.value.address.trim()||(p.value.address="Vui lòng nhập địa chỉ giao hàng"),Object.keys(p.value).length===0),se=async()=>{if(S.value.trim()){F.value=!0;try{await new Promise(e=>setTimeout(e,1e3));const o=z.value.find(e=>e.code.toLowerCase()===S.value.trim().toLowerCase());if(!o){h("Mã khuyến mãi không hợp lệ!","error");return}if(A.value<o.minOrderValue){h(`Đơn hàng tối thiểu ${P(o.minOrderValue)} để áp dụng mã này!`,"warning");return}g.value=o,h(`Áp dụng mã ${o.code} thành công!`,"success")}catch{h("Có lỗi xảy ra khi áp dụng mã khuyến mãi!","error")}finally{F.value=!1}}},fe=()=>{g.value=null,S.value="",h("Đã xóa mã khuyến mãi!","info")},ve=o=>{S.value=o,se()},le=async()=>{if(!pe()){h("Vui lòng kiểm tra lại thông tin đơn hàng","error");return}L.value=!0;try{w&&w.value&&m.value?.customerInfo?.maKH&&(console.log("🔄 Auto-updating shipping info to Profile..."),await ue()?h("Thông tin giao hàng đã được cập nhật vào Profile!","success"):console.log("⚠️ Failed to update shipping info to Profile, continuing with order..."));const o=localStorage.getItem("easymart-invoice");let e;if(o){const i=JSON.parse(o);console.log("📋 Cập nhật thông tin giao hàng cho hóa đơn:",i.maHD),await new Promise(n=>setTimeout(n,1e3)),e={orderCode:`HD${i.maHD}`,invoiceId:i.maHD,customer:{...s.value},items:b.value,summary:{subtotal:A.value,couponDiscount:V.value,total:N.value,itemsCount:W.value},coupon:g.value?{code:g.value.code,description:g.value.description,discountType:g.value.discountType,discountValue:V.value}:null,createdAt:i.ngayLap||new Date().toISOString()}}else console.log("⚠️ Không có hóa đơn, tạo đơn hàng mới"),await new Promise(i=>setTimeout(i,2e3)),e={orderCode:f.value,customer:{...s.value},items:b.value,summary:{subtotal:A.value,couponDiscount:V.value,total:N.value,itemsCount:W.value},coupon:g.value?{code:g.value.code,description:g.value.description,discountType:g.value.discountType,discountValue:V.value}:null,createdAt:new Date().toISOString()};console.log("🧹 Clearing cart after successful checkout...");try{await re(),console.log("✅ Backend cart cleared successfully")}catch(i){console.warn("⚠️ Failed to clear backend cart:",i)}localStorage.removeItem("easymart-selected-items"),console.log("🧹 localStorage cleared"),await ye(e)}catch{h("Có lỗi xảy ra khi đặt hàng. Vui lòng thử lại!","error")}finally{L.value=!1}},ye=async o=>{const e=s.value.paymentMethod;switch(localStorage.setItem("easymart-last-order",JSON.stringify(o)),e){case"Tiền Mặt":h(`Đặt hàng thành công! Mã đơn hàng: ${f.value}. Bạn sẽ thanh toán khi nhận hàng.`,"success");break;case"Chuyển Khoản":h(`Đặt hàng thành công! Mã đơn hàng: ${f.value}. Vui lòng chuyển khoản theo thông tin đã cung cấp.`,"success");break;case"MoMo":h("Đang chuyển đến MoMo để thanh toán...","info"),setTimeout(()=>{h(`Thanh toán MoMo thành công! Mã đơn hàng: ${f.value}`,"success")},1500);break;case"ZaloPay":h("Đang chuyển đến ZaloPay để thanh toán...","info"),setTimeout(()=>{h(`Thanh toán ZaloPay thành công! Mã đơn hàng: ${f.value}`,"success")},1500);break;case"Thẻ Tín Dụng":h("Đang chuyển đến cổng thanh toán...","info"),setTimeout(()=>{h(`Thanh toán thẻ tín dụng thành công! Mã đơn hàng: ${f.value}`,"success")},1500);break;case"VNPay":try{q.value=!0,h("Đang chuyển đến VNPay để thanh toán...","info");const i=B();if(!i){h("Vui lòng đăng nhập để thanh toán qua VNPay!","error");return}const n={vnp_OrderInfo:`Thanh toán đơn hàng ${f.value}`,ordertype:"other",amount:Math.round(N.value).toString(),maHD:f.value.replace(/^(HD|EM)/,""),language:"vn",txt_billing_mobile:"0905123456",txt_billing_email:"nguyenvana@example.com",txt_billing_fullname:"Nguyen Van A",txt_inv_addr1:"123 Duong So 1, Quan 1, TP.HCM"};if(Object.keys(n).forEach(D=>{(n[D]===void 0||n[D]===null)&&(n[D]="")}),console.log("💳 Amount conversion:",{original:N.value,converted:n.amount,originalType:typeof N.value,convertedType:typeof n.amount}),console.log("📋 API Format Comparison:",{expected:{amount:"100000",amountType:"string"},actual:{amount:n.amount,amountType:typeof n.amount},match:typeof n.amount=="string"}),console.log("📋 Form Data vs Default Template:",{template:{txt_billing_mobile:"0905123456",txt_billing_email:"nguyenvana@example.com",txt_billing_fullname:"Nguyen Van A",txt_inv_addr1:"123 Duong So 1, Quan 1, TP.HCM"},actual:{txt_billing_mobile:n.txt_billing_mobile,txt_billing_email:n.txt_billing_email,txt_billing_fullname:n.txt_billing_fullname,txt_inv_addr1:n.txt_inv_addr1},note:"Using default values as per API template"}),console.log("🔍 Pre-validation check:",{txt_billing_mobile:n.txt_billing_mobile,txt_billing_fullname:n.txt_billing_fullname,txt_inv_addr1:n.txt_inv_addr1,amount:n.amount,maHD:n.maHD,maHDType:typeof n.maHD,maHDLength:n.maHD?n.maHD.length:"N/A"}),console.log("🔍 Validating txt_billing_mobile:",n.txt_billing_mobile,"Result:",!!n.txt_billing_mobile),!n.txt_billing_mobile||!n.txt_billing_fullname||!n.txt_inv_addr1)throw new Error("Thông tin giao hàng không đầy đủ để thanh toán VNPay");if(console.log("🔍 Validating amount:",n.amount,"Result:",!!(n.amount&&Number(n.amount)>0)),!n.amount||Number(n.amount)<=0)throw new Error("Số tiền thanh toán không hợp lệ");if(console.log("🔍 Validating maHD:",n.maHD,"Result:",!!(n.maHD&&n.maHD!=="NEW")),!n.maHD||n.maHD==="NEW")throw new Error("Mã hóa đơn không hợp lệ. Vui lòng thử lại!");console.log("💳 VNPay payment data:",n),console.log("💳 Original orderCode:",f.value),console.log("💳 Extracted maHD:",n.maHD),console.log("💳 Amount type:",typeof n.amount,"Value:",n.amount),console.log("💳 VNPay API endpoint:",`${E.BASE_URL}/api/thanhtoan/vnpay`),console.log("💳 VNPay token:",i?"Present":"Missing"),console.log("💳 Request body:",JSON.stringify(n,null,2));const a=await fetch(`${E.BASE_URL}/api/thanhtoan/vnpay`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(n)});if(!a.ok){const D=await a.json().catch(()=>({})),be=D.message||D.error||"Unknown error";throw console.error("❌ VNPay API error response:",D),new Error(`VNPay API error: ${a.status} - ${be}`)}const l=await a.json();console.log("💳 VNPay API response:",l),console.log("💳 VNPay response keys:",Object.keys(l)),console.log("💳 VNPay response data:",l.data),console.log("💳 VNPay response type:",typeof l),console.log("💳 VNPay data type:",typeof l.data),console.log("💳 VNPay data starts with http:",l.data&&typeof l.data=="string"?l.data.startsWith("http"):"N/A");let v=null;if(l?.data&&typeof l.data=="string"&&l.data.startsWith("http")?v=l.data:l?.data?.paymentUrl?v=l.data.paymentUrl:l?.paymentUrl?v=l.paymentUrl:l?.url?v=l.url:l?.vnp_PayUrl?v=l.vnp_PayUrl:l?.redirectUrl?v=l.redirectUrl:typeof l=="string"&&l.startsWith("http")&&(v=l),console.log("💳 Extracted payment URL:",v),v)console.log("🔄 Redirecting to VNPay:",v),h("Chuyển hướng đến VNPay...","success"),setTimeout(()=>{window.location.href=v},1e3);else throw new Error("Không nhận được URL thanh toán từ VNPay API")}catch(i){console.error("❌ VNPay payment error:",i),h(`Lỗi thanh toán VNPay: ${i.message}`,"error"),setTimeout(()=>{h(`Thanh toán VNPay thành công! Mã đơn hàng: ${f.value}`,"success"),R.push({name:"PaymentSuccess",query:{orderCode:f.value,total:N.value,paymentMethod:e}})},2e3)}finally{q.value=!1}return;default:h(`Đặt hàng thành công! Mã đơn hàng: ${f.value}`,"success")}e!=="VNPay"&&setTimeout(()=>{R.push({name:"PaymentSuccess",query:{orderCode:f.value,total:N.value,paymentMethod:e}})},3e3)};return Te(async()=>{console.log("🚀 Checkout page mounted"),await oe(),ee();const o=localStorage.getItem("easymart-invoice"),e=localStorage.getItem("easymart-selected-items");if(o&&e){const i=JSON.parse(o),n=JSON.parse(e);console.log("📋 Nhận hóa đơn:",i),console.log("🛒 Selected items:",n),console.log("🔍 Invoice structure:",Object.keys(i)),f.value=`HD${i.maHD||i.orderId||"NEW"}`,i.chiTietHoaDon&&i.chiTietHoaDon.length>0?(console.log("✅ Sử dụng chiTietHoaDon từ Orders.vue"),b.value=i.chiTietHoaDon.map(a=>({productId:a.maSP||a.productId,quantity:a.soLuong||a.quantity,product:{id:a.maSP||a.productId,name:a.tenSP||a.productName,price:a.donGiaBan||a.donGia||a.productPrice,image:$(a.maSP||a.productId)}}))):i.items&&i.items.length>0?(console.log("✅ Sử dụng items từ Cart.vue/ProductDetail"),b.value=i.items.map(a=>({productId:a.maSP||a.productId,quantity:a.soLuong||a.quantity,product:{id:a.maSP||a.productId,name:a.tenSP||a.productName,price:a.donGiaBan||a.donGia||a.productPrice,image:$(a.maSP||a.productId)}}))):(console.log("⚠️ Không có items trong hóa đơn, thử fallback..."),b.value=X.value.filter(a=>n.includes(a.productId)).map(a=>{const l=Y.value.find(v=>v.id===a.productId);return l&&(l.image=$(a.productId)),{...a,product:l}}).filter(a=>a.product)),te(),await ne()}else{if(f.value=ge(),e){const i=JSON.parse(e);b.value=X.value.filter(n=>i.includes(n.productId)).map(n=>{const a=Y.value.find(l=>l.id===n.productId);return a&&(a.image=$(n.productId)),{...n,product:a}}).filter(n=>n.product)}te(),await ne()}console.log("📊 Final selectedItems state:"),console.log("   - Length:",b.value.length),console.log("   - Items:",b.value),console.log("   - Invoice data:",o?JSON.parse(o):"None"),console.log("   - Stored selected items:",e),b.value.length===0?(console.warn("⚠️ No selected items found, redirecting to cart..."),h("Vui lòng chọn sản phẩm từ giỏ hàng để thanh toán","warning"),setTimeout(()=>{R.push("/cart")},2e3)):console.log("✅ Selected items loaded successfully, staying on checkout page")}),(o,e)=>{const i=we("router-link");return c(),r("div",Ve,[t("div",De,[t("nav",Ce,[t("ol",Me,[t("li",Ae,[U(i,{to:"/",class:"text-decoration-none"},{default:O(()=>e[8]||(e[8]=[t("i",{class:"fas fa-home"},null,-1),d(" Trang chủ ")])),_:1,__:[8]})]),T.value?y("",!0):(c(),r("li",He,[U(i,{to:"/cart",class:"text-decoration-none"},{default:O(()=>e[9]||(e[9]=[t("i",{class:"fas fa-shopping-cart"},null,-1),d(" Giỏ hàng ")])),_:1,__:[9]})])),T.value?(c(),r("li",Ee,e[10]||(e[10]=[t("span",{class:"text-muted"},[t("i",{class:"fas fa-bolt"}),d(" Mua ngay ")],-1)]))):y("",!0),e[11]||(e[11]=t("li",{class:"breadcrumb-item active","aria-current":"page"},[t("i",{class:"fas fa-credit-card"}),d(" Thanh toán ")],-1))])]),t("div",Ue,[t("h2",Oe,[e[12]||(e[12]=t("i",{class:"fas fa-credit-card text-primary me-2"},null,-1)),d(" "+u(T.value?"Thanh toán mua ngay":"Thanh toán đơn hàng"),1)]),t("div",{class:"d-flex gap-2"},[t("button",{onClick:ee,class:"btn btn-outline-warning btn-sm",title:"Debug localStorage data"},e[13]||(e[13]=[t("i",{class:"fas fa-bug me-1"},null,-1),d("Debug Data ")]))])]),b.value.length>0?(c(),r("div",$e,[t("div",Le,[t("div",je,[e[21]||(e[21]=t("div",{class:"card-header bg-primary text-white"},[t("h5",{class:"mb-0"},[t("i",{class:"fas fa-truck me-2"}),d(" Thông tin giao hàng ")])],-1)),t("div",Fe,[t("form",{onSubmit:Ne(le,["prevent"])},[t("div",Re,[t("div",Ge,[e[14]||(e[14]=t("label",{for:"fullName",class:"form-label"},"Họ và tên *",-1)),I(t("input",{type:"text",class:M(["form-control",{"is-invalid":p.value.fullName}]),id:"fullName","onUpdate:modelValue":e[0]||(e[0]=n=>s.value.fullName=n),required:""},null,2),[[H,s.value.fullName]]),p.value.fullName?(c(),r("div",Be,u(p.value.fullName),1)):y("",!0)]),t("div",qe,[e[15]||(e[15]=t("label",{for:"phone",class:"form-label"},"Số điện thoại *",-1)),I(t("input",{type:"tel",class:M(["form-control",{"is-invalid":p.value.phone}]),id:"phone","onUpdate:modelValue":e[1]||(e[1]=n=>s.value.phone=n),required:""},null,2),[[H,s.value.phone]]),p.value.phone?(c(),r("div",Ke,u(p.value.phone),1)):y("",!0)])]),t("div",Je,[e[16]||(e[16]=t("label",{for:"email",class:"form-label"},"Email",-1)),I(t("input",{type:"email",class:M(["form-control",{"is-invalid":p.value.email}]),id:"email","onUpdate:modelValue":e[2]||(e[2]=n=>s.value.email=n)},null,2),[[H,s.value.email]]),p.value.email?(c(),r("div",ze,u(p.value.email),1)):y("",!0)]),t("div",We,[e[17]||(e[17]=t("label",{for:"address",class:"form-label"},"Địa chỉ giao hàng *",-1)),I(t("textarea",{class:M(["form-control",{"is-invalid":p.value.address}]),id:"address",rows:"3","onUpdate:modelValue":e[3]||(e[3]=n=>s.value.address=n),placeholder:"Số nhà, tên đường, phường/xã, quận/huyện, tỉnh/thành phố",required:""},null,2),[[H,s.value.address]]),p.value.address?(c(),r("div",Ze,u(p.value.address),1)):y("",!0)]),t("div",Qe,[e[18]||(e[18]=t("label",{for:"notes",class:"form-label"},"Ghi chú đơn hàng",-1)),I(t("textarea",{class:"form-control",id:"notes",rows:"2","onUpdate:modelValue":e[4]||(e[4]=n=>s.value.notes=n),placeholder:"Ghi chú về đơn hàng, ví dụ: thời gian hay chỉ dẫn địa điểm giao hàng chi tiết hơn."},null,512),[[H,s.value.notes]])]),x(w)?(c(),r("div",Ye,[t("div",Xe,[U(i,{to:"/profile",class:"btn btn-outline-info btn-sm",title:"Chuyển đến trang Profile để cập nhật thông tin"},{default:O(()=>e[19]||(e[19]=[t("i",{class:"fas fa-user-edit me-2"},null,-1),d(" Cập nhật thông tin từ Profile ")])),_:1,__:[19]})]),e[20]||(e[20]=t("div",{class:"mt-2"},[t("small",{class:"text-muted"},[t("i",{class:"fas fa-info-circle me-1"}),d(" Thông tin giao hàng sẽ tự động được đồng bộ với Profile khi đặt hàng ")])],-1))])):y("",!0)],32)])]),t("div",et,[e[36]||(e[36]=t("div",{class:"card-header bg-success text-white"},[t("h5",{class:"mb-0"},[t("i",{class:"fas fa-money-bill-wave me-2"}),d(" Phương thức thanh toán ")])],-1)),t("div",tt,[K.value?(c(),r("div",nt,e[22]||(e[22]=[t("div",{class:"spinner-border text-success",role:"status"},[t("span",{class:"visually-hidden"},"Đang tải...")],-1),t("p",{class:"mt-2 text-muted"},"Đang tải phương thức thanh toán...",-1)]))):j.value.length>0?(c(),r("div",ot,[(c(!0),r(Z,null,Q(j.value,n=>(c(),r("div",{key:n.maPTTT,class:"col-md-6 mb-3"},[t("div",at,[I(t("input",{class:"form-check-input",type:"radio",name:"paymentMethod",id:n.maPTTT,value:n.tenPTTT,"onUpdate:modelValue":e[5]||(e[5]=a=>s.value.paymentMethod=a)},null,8,st),[[ie,s.value.paymentMethod]]),t("label",{class:"form-check-label w-100",for:n.maPTTT},[t("div",it,[t("i",{class:M([de(n.tenPTTT),"me-3 fs-4"])},null,2),t("div",null,[t("strong",null,u(n.tenPTTT),1),t("div",rt,u(n.moTa),1),n.phiGiaoDich>0?(c(),r("div",ct," Phí giao dịch: "+u(x(P)(n.phiGiaoDich)),1)):y("",!0)])])],8,lt)])]))),128))])):J.value?(c(),r("div",ut,[e[24]||(e[24]=t("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),e[25]||(e[25]=d(" Không thể tải phương thức thanh toán. Vui lòng thử lại sau. ")),t("button",{onClick:oe,class:"btn btn-sm btn-outline-warning ms-2"},e[23]||(e[23]=[t("i",{class:"fas fa-redo me-1"},null,-1),d("Thử lại ")]))])):(c(),r("div",dt,[t("div",ht,[t("div",mt,[I(t("input",{class:"form-check-input",type:"radio",name:"paymentMethod",id:"cod",value:"cod","onUpdate:modelValue":e[6]||(e[6]=n=>s.value.paymentMethod=n)},null,512),[[ie,s.value.paymentMethod]]),e[26]||(e[26]=t("label",{class:"form-check-label w-100",for:"cod"},[t("div",{class:"d-flex align-items-center"},[t("i",{class:"fas fa-hand-holding-usd text-success me-3 fs-4"}),t("div",null,[t("strong",null,"Thanh toán khi nhận hàng (COD)"),t("div",{class:"text-muted small"},"Thanh toán bằng tiền mặt khi nhận hàng")])])],-1))])])])),s.value.paymentMethod&&k.value?(c(),r("div",gt,[t("h6",pt,[e[27]||(e[27]=t("i",{class:"fas fa-info-circle me-2"},null,-1)),d(" Thông tin "+u(k.value.tenPTTT),1)]),t("div",ft,[t("div",vt,[t("p",yt,[e[28]||(e[28]=t("strong",null,"Số tiền:",-1)),d(" "+u(x(P)(N.value)),1)]),t("p",bt,[e[29]||(e[29]=t("strong",null,"Mã đơn hàng:",-1)),d(" "+u(f.value),1)]),k.value.phiGiaoDich>0?(c(),r("p",_t,[e[30]||(e[30]=t("strong",null,"Phí giao dịch:",-1)),d(" "+u(x(P)(k.value.phiGiaoDich)),1)])):y("",!0)]),t("div",kt,[t("p",Pt,[t("small",null,[e[31]||(e[31]=t("strong",null,"Hướng dẫn:",-1)),d(" "+u(he(k.value.tenPTTT)),1)])])])]),k.value.tenPTTT==="Chuyển Khoản"?(c(),r("div",Tt,[e[35]||(e[35]=t("h6",{class:"text-primary mb-2"},"Thông tin chuyển khoản",-1)),t("div",xt,[e[34]||(e[34]=t("div",{class:"col-md-6"},[t("p",{class:"mb-1"},[t("strong",null,"Ngân hàng:"),d(" Vietcombank")]),t("p",{class:"mb-1"},[t("strong",null,"Số tài khoản:"),d(" 1234567890")]),t("p",{class:"mb-1"},[t("strong",null,"Chủ tài khoản:"),d(" EASYMART COMPANY")])],-1)),t("div",wt,[t("p",Nt,[e[32]||(e[32]=t("strong",null,"Nội dung:",-1)),d(" THANHTOAN "+u(f.value),1)]),e[33]||(e[33]=t("p",{class:"mb-0 text-danger"},[t("small",null,[t("strong",null,"Lưu ý:"),d(" Vui lòng chuyển khoản đúng nội dung để đơn hàng được xử lý nhanh chóng.")])],-1))])])])):y("",!0)])):y("",!0)])])]),t("div",It,[t("div",St,[e[46]||(e[46]=t("div",{class:"card-header bg-warning text-dark"},[t("h5",{class:"mb-0"},[t("i",{class:"fas fa-receipt me-2"}),d(" Đơn hàng của bạn ")])],-1)),t("div",Vt,[t("div",Dt,[(c(!0),r(Z,null,Q(b.value,n=>(c(),r("div",{key:n.productId,class:"order-item d-flex align-items-center mb-3 pb-3 border-bottom"},[t("img",{src:n.product?.image,alt:n.product?.name,class:"order-item-image me-3"},null,8,Ct),t("div",Mt,[t("h6",At,u(n.product?.name),1),t("div",Ht,[t("span",Et,u(x(P)(n.product?.price||0))+" x "+u(n.quantity),1),t("span",Ut,u(x(P)((n.product?.price||0)*n.quantity)),1)])])]))),128))]),t("div",Ot,[t("div",$t,[t("span",null,"Tạm tính ("+u(W.value)+" sản phẩm):",1),t("span",null,u(x(P)(A.value)),1)]),k.value&&k.value.phiGiaoDich>0?(c(),r("div",Lt,[t("span",null,"Phí giao dịch ("+u(k.value.tenPTTT)+"):",1),t("span",jt,u(x(P)(k.value.phiGiaoDich)),1)])):y("",!0),t("div",Ft,[t("div",Rt,[I(t("input",{type:"text",class:"form-control form-control-sm",placeholder:"Nhập mã khuyến mãi","onUpdate:modelValue":e[7]||(e[7]=n=>S.value=n),disabled:g.value},null,8,Gt),[[H,S.value]]),t("button",{class:"btn btn-outline-primary btn-sm",onClick:se,disabled:!S.value.trim()||g.value||F.value},[F.value?(c(),r("span",qt,e[37]||(e[37]=[t("i",{class:"fas fa-spinner fa-spin"},null,-1)]))):(c(),r("span",Kt,u(g.value?"Đã áp dụng":"Áp dụng"),1))],8,Bt)]),g.value?(c(),r("div",Jt,[t("div",zt,[t("div",null,[t("small",Wt,[e[38]||(e[38]=t("i",{class:"fas fa-ticket-alt me-1"},null,-1)),d(" "+u(g.value.code),1)]),t("div",Zt,u(g.value.description),1)]),t("button",{class:"btn btn-sm",style:{background:"linear-gradient(135deg, #ff6b6b, #ee5a5a)",color:"white",border:"none"},onClick:fe,title:"Xóa mã khuyến mãi"},e[39]||(e[39]=[t("i",{class:"fas fa-times"},null,-1)]))])])):y("",!0),V.value>0?(c(),r("div",Qt,[t("span",null,"Giảm giá ("+u(g.value?.code)+"):",1),t("span",null,"-"+u(x(P)(V.value)),1)])):y("",!0),!g.value&&z.value.length>0?(c(),r("div",Yt,[e[40]||(e[40]=t("small",{class:"text-muted d-block mb-2"},"Mã khuyến mãi có sẵn:",-1)),t("div",Xt,[(c(!0),r(Z,null,Q(z.value,n=>(c(),r("button",{key:n.code,class:"btn btn-sm",style:{background:"linear-gradient(135deg, #667eea, #764ba2)",color:"white",border:"none"},onClick:a=>ve(n.code),title:n.description},u(n.code),9,en))),128))])])):y("",!0)]),e[45]||(e[45]=t("hr",null,null,-1)),t("div",tn,[e[41]||(e[41]=t("strong",{class:"fs-5"},"Tổng cộng:",-1)),t("strong",nn,u(x(P)(N.value)),1)]),t("button",{type:"button",class:"btn btn-primary w-100 mb-2 py-2",onClick:le,disabled:L.value||!me.value},[L.value?(c(),r("span",an,e[42]||(e[42]=[t("i",{class:"fas fa-spinner fa-spin me-2"},null,-1),d(" Đang xử lý... ")]))):q.value?(c(),r("span",sn,e[43]||(e[43]=[t("i",{class:"fas fa-spinner fa-spin me-2"},null,-1),d(" Đang chuyển đến VNPay... ")]))):(c(),r("span",ln,e[44]||(e[44]=[t("i",{class:"fas fa-check me-2"},null,-1),d(" Đặt hàng ")])))],8,on),U(i,{to:T.value?"/":"/cart",class:"btn btn-outline-secondary w-100"},{default:O(()=>[t("i",{class:M([T.value?"fas fa-home":"fas fa-arrow-left","me-2"])},null,2),d(" "+u(T.value?"Về trang chủ":"Quay lại giỏ hàng"),1)]),_:1},8,["to"])])])])])])):(c(),r("div",rn,[t("div",cn,[t("div",un,[e[47]||(e[47]=t("div",{class:"empty-checkout-icon mb-4"},[t("i",{class:"fas fa-exclamation-triangle fa-5x text-warning"})],-1)),e[48]||(e[48]=t("h3",{class:"text-muted mb-3"},"Không có sản phẩm để thanh toán",-1)),t("p",dn,u(T.value?"Vui lòng quay lại trang sản phẩm để mua hàng":"Vui lòng quay lại giỏ hàng và chọn sản phẩm để thanh toán"),1),U(i,{to:T.value?"/":"/cart",class:"btn btn-primary btn-lg"},{default:O(()=>[t("i",{class:M([T.value?"fas fa-home":"fas fa-arrow-left","me-2"])},null,2),d(" "+u(T.value?"Về trang chủ":"Quay lại giỏ hàng"),1)]),_:1},8,["to"])])])]))])])}}},pn=_e(hn,[["__scopeId","data-v-421d7619"]]);export{pn as default};
