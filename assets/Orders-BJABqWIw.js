import{_ as L,x as M,r as h,R as U,p as E,q as R,h as B,m as V,c as l,b as F,l as f,a as s,g as i,t as a,F as S,e as w,i as $,j as z,k as q,S as J,A as K,o as r,f as X,d as y,z as Q}from"./index-BtdpkZHo.js";const W={class:"orders-page"},Y={key:0,class:"container"},Z={key:1,class:"container"},ss={class:"row justify-content-center"},ts={class:"col-md-8"},es={class:"alert alert-danger",role:"alert"},ns={key:2,class:"container"},os={class:"row"},as={class:"col-12"},ls={class:"orders-list"},rs={class:"order-header p-3 bg-light rounded-top"},is={class:"row align-items-center"},cs={class:"col-md-6"},ds={class:"mb-1"},us={class:"text-muted"},ms={class:"col-md-6 text-md-end"},gs={class:"mt-2"},hs={class:"text-success"},fs={class:"order-items p-3"},ys={class:"row"},vs={class:"col-md-8"},ps={class:"mb-3"},_s={key:0,class:"items-list"},bs={class:"item-image me-3"},xs=["src","alt"],Hs={class:"item-details flex-grow-1"},ks={class:"fw-bold"},Cs={class:"text-muted"},Ss={class:"text-muted"},ws={class:"item-total text-end"},Ks={class:"col-md-4"},Ds={class:"order-summary"},Ts={class:"summary-item d-flex justify-content-between mb-2"},Ps={key:0,class:"summary-item d-flex justify-content-between mb-2 text-success"},Is={key:1,class:"summary-item d-flex justify-content-between mb-2 text-info"},As={class:"summary-item d-flex justify-content-between mb-2 fw-bold"},Ns={class:"text-success"},Os={key:2,class:"summary-item d-flex justify-content-between mb-2 text-muted"},js={class:"order-footer p-3 bg-light rounded-bottom"},Gs={class:"row align-items-center"},Ls={class:"col-md-6"},Ms={class:"text-muted"},Us={class:"text-muted"},Es={class:"col-md-6 text-md-end"},Rs=["onClick"],Bs=["onClick"],Vs={key:3,class:"container"},Fs={class:"row justify-content-center"},$s={class:"col-md-8 text-center"},zs={class:"empty-state"},qs={__name:"Orders",setup(Js){const p=V();let H,k;try{const e=M();H=e.user,k=e.isAuthenticated,console.log("✅ useAuth initialized successfully")}catch(e){console.error("❌ useAuth failed:",e),H=h(null),k=h(!1)}let u,_,v,b;try{const e=U();u=e.orders,_=e.loading,v=e.error,b=e.loadCustomerOrders,console.log("✅ useOrders initialized successfully")}catch(e){console.error("❌ useOrders failed:",e),u=h([]),_=h(!1),v=h(null),b=async()=>({success:!1,error:"useOrders not available"})}let m;try{m=E(),console.log("✅ useCart initialized successfully"),console.log("🔍 Initial cart state:",{maKH:m.maKH,isResolved:m.isResolved,hasMaKH:!!m.maKH})}catch(e){console.error("❌ useCart failed:",e),m={maKH:null,isResolved:!1}}const d=h(null);R(()=>u.value.length>0);const x=async()=>{try{console.log("🔄 Loading orders...");let e=m?.maKH||d.value?.khachHang?.maKH||d.value?.maKH||d.value?.customer?.maKH;if(!e)if(console.log("🔄 No maKH found, trying API..."),e=await G(),e)console.log("✅ Got maKH from API:",e),d.value||(d.value={}),d.value.maKH=e;else{console.error("❌ Could not get maKH from any source");return}console.log("🔄 Loading orders for customer:",e),await b(e),console.log("✅ Orders loaded successfully, count:",u.value?.length)}catch(e){console.error("❌ Error loading orders:",e)}},D=e=>{if(!e)return"/placeholder-image.jpg";const t=Q.IMAGES.PRODUCT_IMAGES(e);return t[0]?`${K.BASE_URL}${t[0]}`:"/placeholder-image.jpg"},T=e=>{e.target.src="/placeholder-image.jpg"},P=e=>{if(!e)return"N/A";try{return new Date(e).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return e}},g=e=>e==null?"0 ₫":new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e),I=e=>({0:"badge bg-warning text-dark",1:"badge bg-success",2:"badge bg-info",3:"badge bg-danger",4:"badge bg-secondary"})[e]||"badge bg-secondary",A=e=>({0:"Chờ thanh toán",1:"Đã thanh toán",2:"Đang xử lý",3:"Đã hủy",4:"Hoàn trả"})[e]||"Không xác định",N=e=>{console.log("👁️ Viewing order details:",e)},O=async e=>{if(confirm("Bạn có chắc chắn muốn hủy đơn hàng này?"))try{console.log("❌ Cancelling order:",e),await x(),alert("Đã hủy đơn hàng thành công!")}catch(t){console.error("❌ Error cancelling order:",t),alert("Có lỗi xảy ra khi hủy đơn hàng!")}},j=()=>{console.log("🔍 Checking user login status...");const e=localStorage.getItem("easymart-user"),t=C();return console.log("   - localStorage easymart-user:",e?"Present":"Missing"),console.log("   - Cookie token:",t?"Present":"Missing"),e&&t?(console.log("✅ User appears to be logged in (has user data and token)"),!0):(console.log("❌ User not logged in (missing user data or token)"),!1)},C=()=>J(),G=async()=>{try{console.log("🔍 Getting maKH from API...");const e=JSON.parse(localStorage.getItem("easymart-user"));console.log("🔍 User data from localStorage:",e);const t=e?.id||e?.maNguoiDung||e?.userId;if(!t)return console.error("❌ No user ID found in user data"),console.log("🔍 Available fields:",Object.keys(e||{})),console.log("�� Using hardcoded maKH: KHC86D136D"),"KHC86D136D";console.log("🔍 User ID:",t);const c=C(),n=await fetch(`${K.BASE_URL}/api/khachhang/by-nguoidung/${t}`,{method:"GET",headers:{Authorization:`Bearer ${c}`,"Content-Type":"application/json"},credentials:"include"});if(n.ok){const o=await n.json();return console.log("✅ Customer data from API:",o),o?.maKH?(console.log("✅ Found maKH from API:",o.maKH),o.maKH):(console.log("❌ No maKH in customer data"),null)}else return console.error("❌ API Error:",n.statusText),null}catch(e){return console.error("❌ Error getting maKH from API:",e),console.log("🔄 API failed, using hardcoded maKH: KHC86D136D"),"KHC86D136D"}};return B(async()=>{if(console.log("🚀 Orders page mounted"),!j()){console.log("⚠️ User not logged in, redirecting to login"),p.push("/login");return}let t=null;try{const c=localStorage.getItem("easymart-user");if(c)t=JSON.parse(c),console.log("✅ User data loaded from localStorage");else{console.error("❌ No user data in localStorage"),p.push("/login");return}}catch(c){console.error("❌ Error parsing user data:",c),p.push("/login");return}d.value=t,await x()}),(e,t)=>{const c=q("router-link");return r(),l("div",W,[t[24]||(t[24]=F('<div class="container mt-5 pt-5" data-v-a802543d><div class="row" data-v-a802543d><div class="col-12" data-v-a802543d><h1 class="text-primary mb-4" data-v-a802543d><i class="fas fa-box me-3" data-v-a802543d></i>Đơn hàng của tôi </h1></div></div></div>',1)),f(_)?(r(),l("div",Y,t[0]||(t[0]=[s("div",{class:"row justify-content-center"},[s("div",{class:"col-md-8 text-center"},[s("div",{class:"spinner-border text-primary",role:"status"},[s("span",{class:"visually-hidden"},"Đang tải...")]),s("p",{class:"mt-3 text-muted"},"Đang tải danh sách đơn hàng...")])],-1)]))):f(v)?(r(),l("div",Z,[s("div",ss,[s("div",ts,[s("div",es,[t[2]||(t[2]=s("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),t[3]||(t[3]=s("strong",null,"Lỗi:",-1)),i(" "+a(f(v))+" ",1),s("button",{onClick:x,class:"btn btn-outline-danger btn-sm ms-3"},t[1]||(t[1]=[s("i",{class:"fas fa-redo me-1"},null,-1),i("Thử lại ")]))])])])])):f(u).length>0?(r(),l("div",ns,[s("div",os,[s("div",as,[s("div",ls,[(r(!0),l(S,null,w(f(u),n=>(r(),l("div",{key:n.maHD,class:"order-card mb-4"},[s("div",rs,[s("div",is,[s("div",cs,[s("h5",ds,[t[4]||(t[4]=s("i",{class:"fas fa-receipt me-2 text-primary"},null,-1)),i(" Hóa đơn #"+a(n.maHD),1)]),s("small",us,[t[5]||(t[5]=s("i",{class:"fas fa-calendar me-1"},null,-1)),i(" "+a(P(n.ngayLap)),1)])]),s("div",ms,[s("span",{class:X(I(n.trangThai))},a(A(n.trangThai)),3),s("div",gs,[s("strong",hs,a(g(n.tongTien)),1)])])])]),s("div",fs,[s("div",ys,[s("div",vs,[s("h6",ps,[t[6]||(t[6]=s("i",{class:"fas fa-shopping-bag me-2 text-info"},null,-1)),i(" Sản phẩm đã đặt ("+a(n.chiTietHoaDon?.length||0)+") ",1)]),n.chiTietHoaDon?(r(),l("div",_s,[(r(!0),l(S,null,w(n.chiTietHoaDon,o=>(r(),l("div",{key:o.maCTHD,class:"item-row d-flex align-items-center py-2 border-bottom"},[s("div",bs,[s("img",{src:D(o.sanPham?.maSP||o.maSP),alt:o.sanPham?.tenSP||o.tenSP||"Sản phẩm",class:"rounded",style:{width:"50px",height:"50px","object-fit":"cover"},onError:T},null,40,xs)]),s("div",Hs,[s("div",ks,a(o.sanPham?.tenSP||o.tenSP||"Tên sản phẩm"),1),s("small",Cs," Mã SP: "+a(o.sanPham?.maSP||o.maSP||"N/A"),1),t[7]||(t[7]=s("br",null,null,-1)),s("small",Ss," Số lượng: "+a(o.soLuong)+" x "+a(g(o.donGiaBan||o.donGia)),1)]),s("div",ws,[s("strong",null,a(g(o.thanhTienSauGiam||o.thanhTien||(o.donGiaBan||o.donGia)*o.soLuong)),1)])]))),128))])):y("",!0)]),s("div",Ks,[s("div",Ds,[t[13]||(t[13]=s("h6",{class:"mb-3"},[s("i",{class:"fas fa-calculator me-2 text-warning"}),i(" Tổng quan ")],-1)),s("div",Ts,[t[8]||(t[8]=s("span",null,"Tổng tiền hàng:",-1)),s("span",null,a(g(n.tongTienHang)),1)]),n.tienGiamGia>0?(r(),l("div",Ps,[t[9]||(t[9]=s("span",null,"Giảm giá:",-1)),s("span",null,"-"+a(g(n.tienGiamGia)),1)])):y("",!0),n.khuyenMai?(r(),l("div",Is,[t[10]||(t[10]=s("span",null,"Khuyến mãi:",-1)),s("span",null,a(n.khuyenMai.tenChuongTrinh),1)])):y("",!0),t[14]||(t[14]=s("hr",null,null,-1)),s("div",As,[t[11]||(t[11]=s("span",null,"Tổng thanh toán:",-1)),s("span",Ns,a(g(n.tongTien)),1)]),n.diemTichLuy?(r(),l("div",Os,[t[12]||(t[12]=s("small",null,"Điểm tích lũy:",-1)),s("small",null,"+"+a(n.diemTichLuy)+" điểm",1)])):y("",!0)])])])]),s("div",js,[s("div",Gs,[s("div",Ls,[s("small",Ms,[t[15]||(t[15]=s("i",{class:"fas fa-user me-1"},null,-1)),i(" "+a(n.khachHang?.hoTen||"Khách hàng"),1)]),t[17]||(t[17]=s("br",null,null,-1)),s("small",Us,[t[16]||(t[16]=s("i",{class:"fas fa-map-marker-alt me-1"},null,-1)),i(" "+a(n.khachHang?.diaChi||"Địa chỉ giao hàng"),1)])]),s("div",Es,[s("button",{onClick:o=>N(n.maHD),class:"btn btn-outline-primary btn-sm me-2"},t[18]||(t[18]=[s("i",{class:"fas fa-eye me-1"},null,-1),i("Xem chi tiết ")]),8,Rs),n.trangThai===0?(r(),l("button",{key:0,onClick:o=>O(n.maHD),class:"btn btn-outline-danger btn-sm"},t[19]||(t[19]=[s("i",{class:"fas fa-times me-1"},null,-1),i("Hủy đơn ")]),8,Bs)):y("",!0)])])])]))),128))])])])])):(r(),l("div",Vs,[s("div",Fs,[s("div",$s,[s("div",zs,[t[21]||(t[21]=s("i",{class:"fas fa-box-open fa-4x text-muted mb-4"},null,-1)),t[22]||(t[22]=s("h3",{class:"text-muted"},"Chưa có đơn hàng nào",-1)),t[23]||(t[23]=s("p",{class:"text-muted mb-4"}," Bạn chưa có đơn hàng nào. Hãy mua sắm và tạo đơn hàng đầu tiên! ",-1)),$(c,{to:"/",class:"btn btn-primary"},{default:z(()=>t[20]||(t[20]=[s("i",{class:"fas fa-shopping-cart me-2"},null,-1),i("Mua sắm ngay ")])),_:1,__:[20]})])])])]))])}}},Qs=L(qs,[["__scopeId","data-v-a802543d"]]);export{Qs as default};
