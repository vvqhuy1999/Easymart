import{_ as Me,u as De,q as He,r as A,h as V,i as xe,p as Ke,s as Ne,c as m,a as n,d as S,k as F,l as q,m as Ee,g as y,t as h,w as $e,v as G,x as L,f as R,y as N,F as ue,e as de,z as ge,A as B,B as v,C as Ue,o as f}from"./index-pi3KkAaC.js";const Ge={class:"checkout-page"},Ve={class:"container py-5 mt-5"},Re={"aria-label":"breadcrumb",class:"mb-4"},Le={class:"breadcrumb"},Be={class:"breadcrumb-item"},Oe={key:0,class:"breadcrumb-item"},je={key:1,class:"breadcrumb-item"},Fe={class:"d-flex justify-content-between align-items-center mb-4"},qe={class:"mb-0"},ze={key:0,class:"row"},Je={class:"col-lg-8"},We={class:"card mb-4"},Qe={class:"card-body"},Ze={class:"row"},Ye={class:"col-md-6 mb-3"},Xe={key:0,class:"invalid-feedback"},eo={class:"col-md-6 mb-3"},oo={key:0,class:"invalid-feedback"},no={class:"mb-3"},to={key:0,class:"invalid-feedback"},ao={class:"mb-3"},so={key:0,class:"invalid-feedback"},lo={class:"mb-3"},io={key:0,class:"mb-3"},ro={class:"d-flex gap-2"},co={class:"card mb-4"},uo={class:"card-body"},go={key:0,class:"text-center py-4"},po={key:1,class:"row"},ho={class:"form-check payment-method"},mo=["id","value"],fo=["for"],vo={class:"d-flex align-items-center"},yo={class:"text-muted small"},ko={key:0,class:"text-info small"},To={key:2,class:"alert alert-warning"},bo={key:3,class:"row"},Io={class:"col-md-6 mb-3"},Po={class:"form-check payment-method"},_o={key:4,class:"payment-info mt-3 p-3 bg-light rounded"},wo={class:"text-primary mb-3"},Co={class:"row"},Ao={class:"col-md-6"},So={class:"mb-2"},Mo={class:"mb-2"},Do={key:0,class:"mb-2"},Ho={class:"col-md-6"},xo={class:"mb-0 text-info"},Ko={key:0,class:"banking-details mt-3 p-3 bg-white rounded border"},No={class:"row"},Eo={class:"col-md-6"},$o={class:"mb-1"},Uo={class:"col-lg-4"},Go={class:"card sticky-top",style:{top:"100px"}},Vo={class:"card-body"},Ro={class:"order-items mb-3"},Lo=["src","alt"],Bo={class:"flex-grow-1"},Oo={class:"mb-1"},jo={class:"d-flex justify-content-between"},Fo={class:"text-muted"},qo={class:"fw-bold"},zo={class:"order-summary"},Jo={class:"d-flex justify-content-between mb-2"},Wo={key:0,class:"d-flex justify-content-between mb-2"},Qo={class:"text-info"},Zo={class:"coupon-section mb-3"},Yo={class:"d-flex gap-2 mb-2"},Xo=["disabled"],en=["disabled"],on={key:0},nn={key:1},tn={key:0,class:"applied-coupon"},an={class:"d-flex justify-content-between align-items-center p-3 rounded-3",style:{background:"linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))",border:"1px solid rgba(102, 126, 234, 0.3)"}},sn={class:"fw-bold",style:{color:"#667eea"}},ln={class:"small text-muted"},rn={key:1,class:"d-flex justify-content-between mb-2",style:{color:"#11998e"}},cn={class:"d-flex justify-content-between mb-3"},un={class:"text-danger fs-5"},dn=["disabled"],gn={key:0},pn={key:1},hn={key:2},mn={key:1,class:"row"},fn={class:"col-12"},vn={class:"empty-checkout text-center py-5"},yn={class:"text-muted mb-4"},kn={__name:"Checkout",setup(Tn){const E=Ke(),pe=t=>{try{if(!t)return null;const e=JSON.parse(atob(t.split(".")[1]));return{email:e.sub,issuer:e.iss,role:e.role,exp:e.exp,iat:e.iat,raw:e}}catch(e){return console.error("Error decoding token:",e),null}},he=(t,e)=>t?.maKH?t.maKH:t?.customer?.maKH?t.customer.maKH:t?.result?.maKH?t.result.maKH:t?.data?.maKH?t.data.maKH:null,O=async()=>{try{console.log("üîç === GETTING MAKH FROM API (Checkout) ===");const t=B();if(!t)return console.log("‚ùå No token available"),null;const e=pe(t);if(!e?.email)return console.log("‚ùå No email found in token"),null;const a=e.email;console.log("üìß User email from token:",a),console.log("üë§ Step 1: Getting maNguoiDung from email API...");const o=await fetch(`${v.BASE_URL}/api/nguoidung/email/${encodeURIComponent(a)}`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},credentials:"include"});if(!o.ok)return console.log("‚ö†Ô∏è User email API failed with status:",o.status),null;const s=(await o.json()).maNguoiDung;console.log("‚úÖ Got real maNguoiDung:",s),console.log("üë§ Step 2: Getting customer info with maNguoiDung...");const l=await fetch(`${v.BASE_URL}/api/khachhang/by-nguoidung/${s}`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},credentials:"include"});if(!l.ok)return console.log("‚ö†Ô∏è Customer API failed with status:",l.status),null;const g=await l.json();console.log("‚úÖ Customer data from API:",g);const u=he(g,"Customer API");return u?(console.log("‚úÖ Found maKH from API:",u),u):(console.log("‚ùå No maKH found in customer data"),null)}catch(t){return console.error("‚ùå Error getting maKH from API:",t),null}},{formatPrice:M,showNotification:p,products:ae}=De(),{cart:D,clearCart:me}=He(),{user:c,isLoggedIn:z}=Ne(),J=t=>{if(!t)return"/placeholder-image.jpg";const e=Ue.IMAGES.PRODUCT_IMAGES(t);return e[0]?`${v.BASE_URL}${e[0]}`:"/placeholder-image.jpg"},se=async()=>{try{if(!B()){console.log("‚ö†Ô∏è No token found, user not logged in"),Y();return}console.log("üë§ Pre-filling user info...");let e=D?.maKH||c.value?.customerInfo?.maKH||c.value?.maKH||c.value?.khachHang?.maKH;if(!e){console.log("üîç No maKH found, getting from API first...");const a=await O();if(a)e=a,c.value&&(c.value.customerInfo||(c.value.customerInfo={}),c.value.customerInfo.maKH=a,c.value.maKH=a,c.value.khachHang={maKH:a}),console.log("‚úÖ Got maKH from API, now fetching shipping info");else{console.log("‚ùå Could not get maKH, using fallback"),Y();return}}if(await ce(),c.value.name&&(i.value.fullName=c.value.name),c.value.email&&(i.value.email=c.value.email),c.value.customerInfo){const a=c.value.customerInfo;a.hoTen&&(i.value.fullName=a.hoTen),a.sdt&&(i.value.phone=a.sdt),a.diaChi&&(i.value.address=a.diaChi),a.nguoiDung?.email&&(i.value.email=a.nguoiDung.email)}console.log("‚úÖ Form ƒë√£ ƒë∆∞·ª£c pre-fill:",i.value)}catch(t){console.error("‚ùå L·ªói khi pre-fill user info:",t),console.log("üîç Debug info:",{isLoggedIn:z,user:c,orderForm:i}),Y()}},Y=()=>{try{console.log("üîÑ Trying fallback: getting user info from localStorage...");const t=localStorage.getItem("easymart-user");if(t){const e=JSON.parse(t);console.log("üì¶ Found user data in localStorage:",e),e.name&&(i.value.fullName=e.name),e.email&&(i.value.email=e.email),console.log("‚úÖ Fallback pre-fill successful")}else console.log("‚ö†Ô∏è No user data found in localStorage")}catch(t){console.error("‚ùå Fallback also failed:",t)}},fe=async()=>{try{console.log("üì§ Updating shipping info to Shipping API...");let t=D?.maKH||c.value?.customerInfo?.maKH||c.value?.maKH||c.value?.khachHang?.maKH;if(!t){const l=await O();if(l)t=l,console.log("‚úÖ Got maKH from API for update:",t);else return console.log("‚ö†Ô∏è No maKH found, cannot update shipping info"),p("Kh√¥ng th·ªÉ x√°c ƒë·ªãnh th√¥ng tin kh√°ch h√†ng!","error"),!1}const e=B();if(!e)return console.log("‚ö†Ô∏è No token found, cannot update shipping info"),!1;const a={hoTen:i.value.fullName,sdt:i.value.phone,diaChi:i.value.address,email:i.value.email};console.log("üì§ Update data prepared:",a);const o=`${v.BASE_URL}/api/khachhang/${t}/shipping-info`;console.log("üîó Update Shipping API endpoint:",o);const r=await fetch(o,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(a)});if(!r.ok){const l=await r.json().catch(()=>({}));return console.log("‚ö†Ô∏è Shipping API update failed:",r.status,l.message),!1}const s=await r.json();return console.log("üì• Shipping API update response:",s),s?.success||s?.result?.success||s?.message?.includes("th√†nh c√¥ng")?(console.log("‚úÖ Shipping info updated successfully"),c.value?.customerInfo&&(c.value.customerInfo={...c.value.customerInfo,hoTen:i.value.fullName,sdt:i.value.phone,diaChi:i.value.address}),!0):(console.log("‚ö†Ô∏è Shipping API update response format unexpected:",s),!1)}catch(t){return console.error("‚ùå Error updating shipping info:",t),!1}},$=()=>{const t=document.cookie.split("; ").find(e=>e.startsWith("easymart-token="))?.split("=")[1];return console.log("üç™ Token from cookie:",t?"Present":"Missing"),console.log("üç™ All cookies:",document.cookie),t},ve=t=>{try{if(!t)return!0;const e=JSON.parse(atob(t.split(".")[1]));return Math.floor(Date.now()/1e3)>=e.exp}catch(e){return console.error("Error checking token expiration:",e),!0}},X=()=>{const t=B();return t?ve(t)?(console.log("‚ùå Token expired"),localStorage.removeItem("easymart-token"),!1):(console.log("‚úÖ Token valid"),!0):(console.log("‚ùå No token found"),!1)},le=async()=>{try{console.log("üì° Fetching payment methods from API..."),oe.value=!0,ne.value="";const t=await fetch(`${v.BASE_URL}/api/phuongthucthanhtoan`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const e=await t.json();console.log("üì• Payment methods API response:",e);let a=[];if(e?.data)a=e.data;else if(e?.result)a=e.result;else if(Array.isArray(e))a=e;else throw new Error("Unexpected response format");const o=a.filter(r=>r.trangThai===1&&!r.isDeleted);if(console.log("‚úÖ Active payment methods:",o),Q.value=o,o.length>0&&!i.value.paymentMethod){const r=o.find(s=>s.tenPTTT==="Ti·ªÅn M·∫∑t"||s.tenPTTT.toLowerCase().includes("ti·ªÅn m·∫∑t")||s.tenPTTT.toLowerCase().includes("cod"));r?(i.value.paymentMethod=r.tenPTTT,console.log("üí∞ Set default payment method to:",r.tenPTTT)):(i.value.paymentMethod=o[0].tenPTTT,console.log("üí∞ Set default payment method to:",o[0].tenPTTT))}}catch(t){console.error("‚ùå Error fetching payment methods:",t),ne.value="Kh√¥ng th·ªÉ t·∫£i ph∆∞∆°ng th·ª©c thanh to√°n: "+t.message}finally{oe.value=!1}},ye=t=>({"Ti·ªÅn M·∫∑t":"fas fa-hand-holding-usd text-success","Chuy·ªÉn Kho·∫£n":"fas fa-university text-primary",MoMo:"fab fa-momo text-danger",ZaloPay:"fas fa-mobile-alt text-warning","Th·∫ª T√≠n D·ª•ng":"fas fa-credit-card text-info",VNPay:"fas fa-credit-card text-info"})[t]||"fas fa-credit-card text-secondary",ke=t=>({"Ti·ªÅn M·∫∑t":"B·∫°n s·∫Ω thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng.","Chuy·ªÉn Kho·∫£n":"Vui l√≤ng chuy·ªÉn kho·∫£n theo th√¥ng tin ng√¢n h√†ng b√™n d∆∞·ªõi.",MoMo:"B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn app MoMo ƒë·ªÉ ho√†n t·∫•t thanh to√°n.",ZaloPay:"B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn app ZaloPay ƒë·ªÉ ho√†n t·∫•t thanh to√°n.","Th·∫ª T√≠n D·ª•ng":"B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn c·ªïng thanh to√°n ƒë·ªÉ nh·∫≠p th√¥ng tin th·∫ª.",VNPay:"B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn c·ªïng thanh to√°n VNPay ƒë·ªÉ ho√†n t·∫•t giao d·ªãch."})[t]||"Vui l√≤ng l√†m theo h∆∞·ªõng d·∫´n thanh to√°n.",W=A(!1),ee=A(!1),I=A(""),P=A({}),ie=A(!1),Q=A([]),oe=A(!1),ne=A(""),H=A(""),d=A(null),Z=A(!1);A([]);const i=A({fullName:"",phone:"",email:"",address:"",notes:"",paymentMethod:"Ti·ªÅn M·∫∑t"}),w=A([]),U=V(()=>w.value.reduce((t,e)=>t+(e.product?.price||0)*e.quantity,0)),_=V(()=>{if(!d.value)return 0;const t=d.value,e=U.value;if(e<t.minOrderValue)return 0;let a=0;switch(t.discountType){case"percentage":a=e*t.discountValue/100;break;case"fixed":a=t.discountValue;break;case"shipping":a=0;break;default:a=0}return Math.min(a,t.maxDiscount)}),b=V(()=>{const t=x.value?.phiGiaoDich||0;return U.value-_.value+t}),te=V(()=>w.value.reduce((t,e)=>t+e.quantity,0)),Te=V(()=>i.value.fullName&&i.value.phone&&i.value.address&&i.value.paymentMethod),x=V(()=>Q.value.find(t=>t.tenpttt===i.value.paymentMethod)),K=V(()=>w.value.length===1&&!1),be=()=>{const t=Date.now().toString().slice(-6),e=Math.random().toString(36).substr(2,4).toUpperCase();return`EM${t}${e}`},Ie=()=>(P.value={},i.value.fullName.trim()||(P.value.fullName="Vui l√≤ng nh·∫≠p h·ªç v√† t√™n"),i.value.phone.trim()?/^[0-9]{10,11}$/.test(i.value.phone.replace(/\s/g,""))||(P.value.phone="S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá"):P.value.phone="Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i",i.value.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i.value.email)&&(P.value.email="Email kh√¥ng h·ª£p l·ªá"),i.value.address.trim()||(P.value.address="Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng"),Object.keys(P.value).length===0),Pe=async()=>{if(H.value.trim()){Z.value=!0;try{const t=B();if(!t){p("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng m√£ khuy·∫øn m√£i!","error");return}console.log("üîß API Config:",{BASE_URL:v.BASE_URL,fullEndpoint:`${v.BASE_URL}/api/khuyenmai`,couponCode:H.value.trim()}),console.log("üîó Calling promotions API:",`${v.BASE_URL}/api/khuyenmai`),console.log("üîë Token present:",!!t);const e=await fetch(`${v.BASE_URL}/api/khuyenmai`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});console.log("üì° Response status:",e.status),console.log("üì° Response headers:",Object.fromEntries(e.headers.entries()));const a=e.headers.get("content-type");if(!a||!a.includes("application/json")){const u=await e.text();throw console.error("‚ùå Non-JSON response received:",u.substring(0,200)),new Error("Server tr·∫£ v·ªÅ l·ªói. Vui l√≤ng th·ª≠ l·∫°i sau!")}if(!e.ok){const u=await e.json().catch(()=>({})),k=u.message||u.error||`L·ªói ${e.status}: Kh√¥ng th·ªÉ t·∫£i danh s√°ch khuy·∫øn m√£i`;throw new Error(k)}const o=await e.json();console.log("üì• Promotions API response:",o);let r=[];if(o?.data)r=o.data;else if(o?.result)r=o.result;else if(Array.isArray(o))r=o;else throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c danh s√°ch khuy·∫øn m√£i h·ª£p l·ªá");const s=r.filter(u=>u.trangThai===1&&!u.isDeleted);console.log("‚úÖ Active promotions found:",s.length);const l=s.find(u=>u.couponCode&&u.couponCode.toLowerCase()===H.value.trim().toLowerCase()||u.maKM&&u.maKM.toLowerCase()===H.value.trim().toLowerCase());if(!l)throw new Error("M√£ khuy·∫øn m√£i kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ h·∫øt h·∫°n");console.log("üéØ Found matching coupon:",l);const g={code:l.couponCode||l.maKM,description:l.moTa||l.tenKM||"M√£ khuy·∫øn m√£i",discountType:we(l.loaiKM),discountValue:l.giaTriKM||0,minOrderValue:0,maxDiscount:(l.giaTriKM||0)*1e3,isActive:Ce(l),startDate:new Date(l.ngayBatDau),endDate:new Date(l.ngayKetThuc),remainingQuantity:(l.soLuongToiDa||0)-(l.daSuDung||0),totalQuantity:l.soLuongToiDa||0,usedQuantity:l.daSuDung||0};if(!g.isActive)throw new Error("M√£ khuy·∫øn m√£i ƒë√£ h·∫øt h·∫°n ho·∫∑c kh√¥ng c√≤n hi·ªáu l·ª±c");if(!g.code)throw new Error("M√£ khuy·∫øn m√£i kh√¥ng h·ª£p l·ªá");if(U.value<g.minOrderValue){p(`ƒê∆°n h√†ng t·ªëi thi·ªÉu ${M(g.minOrderValue)} ƒë·ªÉ √°p d·ª•ng m√£ n√†y!`,"warning");return}d.value=g,p(`√Åp d·ª•ng m√£ ${g.code} th√†nh c√¥ng!`,"success")}catch(t){if(console.error("‚ùå Error applying coupon:",t),t.message.includes("Server tr·∫£ v·ªÅ l·ªói")||t.message.includes("fetch")?p("M√°y ch·ªß ƒëang g·∫∑p s·ª± c·ªë. Vui l√≤ng th·ª≠ l·∫°i sau!","error"):p(`L·ªói khi √°p d·ª•ng m√£ khuy·∫øn m√£i: ${t.message}`,"error"),t.message.includes("Server tr·∫£ v·ªÅ l·ªói")){console.log("üîÑ Trying fallback test coupon...");try{const e={code:H.value.trim(),description:"M√£ khuy·∫øn m√£i test (API kh√¥ng kh·∫£ d·ª•ng)",discountType:"percentage",discountValue:10,minOrderValue:0,maxDiscount:5e4,isActive:!0};U.value>=e.minOrderValue&&(d.value=e,p(`√Åp d·ª•ng m√£ test ${e.code} (API offline)`,"warning"))}catch(e){console.error("‚ùå Fallback also failed:",e)}}}finally{Z.value=!1}}},_e=()=>{d.value=null,H.value="",p("ƒê√£ x√≥a m√£ khuy·∫øn m√£i!","info")},we=t=>({PhanTram:"percentage",TienMat:"fixed",Diem:"points",MuaXTangY:"buyXGetY",GiamGia:"discount"})[t]||"discount",Ce=t=>{const e=new Date,a=new Date(t.ngayBatDau),o=new Date(t.ngayKetThuc);return e>=a&&e<=o&&t.trangThai===1&&!t.isDeleted&&(t.daSuDung||0)<(t.soLuongToiDa||0)},re=async()=>{if(!Ie()){p("Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin ƒë∆°n h√†ng","error");return}W.value=!0;try{z&&z.value&&c.value?.customerInfo?.maKH&&(console.log("üîÑ Auto-updating shipping info to Profile..."),await fe()?p("Th√¥ng tin giao h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√†o Profile!","success"):console.log("‚ö†Ô∏è Failed to update shipping info to Profile, continuing with order..."));const t=localStorage.getItem("easymart-invoice");let e;if(t){const a=JSON.parse(t);console.log("üìã C·∫≠p nh·∫≠t th√¥ng tin giao h√†ng cho h√≥a ƒë∆°n:",a.maHD),await new Promise(o=>setTimeout(o,1e3)),e={orderCode:`HD${a.maHD}`,invoiceId:a.maHD,customer:{...i.value},items:w.value,summary:{subtotal:U.value,couponDiscount:_.value,total:b.value,itemsCount:te.value},coupon:d.value?{code:d.value.code,description:d.value.description,discountType:d.value.discountType,discountValue:_.value,tienGiamGia:_.value,tongTienSauGiamGia:b.value}:null,maKM:d.value?.code||null,tienGiamGia:_.value,tongTienSauGiamGia:b.value,createdAt:a.ngayLap||new Date().toISOString()},console.log("üìã Created order with invoice:",{orderCode:e.orderCode,invoiceId:e.invoiceId,coupon:e.coupon,couponDiscount:e.summary.couponDiscount,total:e.summary.total,appliedCoupon:d.value,maKM:e.maKM,tienGiamGia:e.tienGiamGia,tongTienSauGiamGia:e.tongTienSauGiamGia})}else console.log("‚ö†Ô∏è Kh√¥ng c√≥ h√≥a ƒë∆°n, t·∫°o ƒë∆°n h√†ng m·ªõi"),await new Promise(a=>setTimeout(a,2e3)),e={orderCode:I.value,invoiceId:null,customer:{...i.value},items:w.value,summary:{subtotal:U.value,couponDiscount:_.value,total:b.value,itemsCount:te.value},coupon:d.value?{code:d.value.code,description:d.value.description,discountType:d.value.discountType,discountValue:_.value,tienGiamGia:_.value,tongTienSauGiamGia:b.value}:null,maKM:d.value?.code||null,tienGiamGia:_.value,tongTienSauGiamGia:b.value,createdAt:new Date().toISOString()},console.log("üìã Created new order:",{orderCode:e.orderCode,invoiceId:e.invoiceId,coupon:e.coupon,couponDiscount:e.summary.couponDiscount,total:e.summary.total,appliedCoupon:d.value,maKM:e.maKM,tienGiamGia:e.tienGiamGia,tongTienSauGiamGia:e.tongTienSauGiamGia});if(d.value&&e.invoiceId)try{console.log("üé´ Updating invoice with coupon information..."),console.log("üîç Applied coupon:",d.value),console.log("üîç Invoice ID:",e.invoiceId),console.log("üîç Coupon discount:",_.value),console.log("üîç Total after discount:",b.value);const a=$();if(a){console.log("üîë Token found for invoice update:",a?"Present":"Missing"),console.log("üé´ Getting coupon details from API...");let o=null;try{const u=await fetch(`${v.BASE_URL}/api/khuyenmai/coupon/${d.value.code}`,{method:"GET",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(console.log("üì° Coupon API response status:",u.status),u.ok){const k=u.headers.get("content-type");if(console.log("üì° Response content-type:",k),k&&k.includes("application/json")){const T=await u.json();console.log("üì• Coupon API response:",T),T?.khuyenMai?(o=T.khuyenMai,console.log("‚úÖ Found khuyenMai object:",o)):T?.data?o=T.data:T?.result?o=T.result:T?.maKM&&(o=T),console.log("‚úÖ Coupon details retrieved:",o)}else{console.log("‚ö†Ô∏è Response is not JSON, content-type:",k);const T=await u.text();console.log("üìÑ Text response (first 200 chars):",T.substring(0,200))}}else{console.log("‚ö†Ô∏è Coupon API failed:",u.status);const k=await u.text();console.log("‚ùå Coupon API error:",k)}}catch(u){console.error("‚ùå Error getting coupon details:",u)}if(!o){console.log("üîÑ Trying alternative coupon API...");try{const u=await fetch(`${v.BASE_URL}/api/khuyenmai`,{method:"GET",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(u.ok){const k=await u.json();console.log("üì• Alternative coupon API response:",k);let T=[];k?.data?T=k.data:k?.result?T=k.result:Array.isArray(k)&&(T=k);const j=T.find(C=>C.couponCode&&C.couponCode.toLowerCase()===d.value.code.toLowerCase()||C.maKM&&C.maKM.toLowerCase()===d.value.code.toLowerCase()||C.tenKM&&C.tenKM.toLowerCase().includes(d.value.code.toLowerCase())||C.khuyenMai?.couponCode&&C.khuyenMai.couponCode.toLowerCase()===d.value.code.toLowerCase());j?(o=j,console.log("‚úÖ Found promotion in alternative API:",j)):console.log("‚ö†Ô∏è Promotion not found in alternative API")}}catch(u){console.log("‚ö†Ô∏è Alternative coupon API also failed:",u)}}let r=D?.maKH||c.value?.customerInfo?.maKH||c.value?.maKH||c.value?.khachHang?.maKH;if(!r){console.log("üîç No maKH found, trying to get from API...");try{const u=await O();u&&(r=u,console.log("‚úÖ Got maKH from API:",r))}catch(u){console.log("‚ö†Ô∏è Failed to get maKH from API:",u)}}r||(r="KH001",console.log("‚ö†Ô∏è Using fallback maKH:",r));const s=o?.maKM;console.log("üéØ Real maKM from API:",s),console.log("üéØ Coupon code used:",d.value.code);const l={maHD:e.invoiceId,maKH:r,maNVLap:c.value?.maNhanVien||"NV001",khuyenMai:{maKM:s||d.value.code},tongTienHang:U.value,tienGiamGia:_.value,tongTienSauGiamGia:b.value,ghiChu:`√Åp d·ª•ng m√£ khuy·∫øn m√£i: ${d.value.code} - Gi·∫£m: ${M(_.value)}`};console.log("üì§ Invoice update data with real maKM:",l),console.log("üîç Coupon details used:",{couponCode:d.value.code,realMaKM:s,fallbackMaKM:d.value.code,couponDetailsFound:!!o}),console.log("üì§ Invoice update data:",l),console.log("üîç Data sources:",{cartMaKH:D?.maKH,userCustomerInfoMaKH:c.value?.customerInfo?.maKH,userMaKH:c.value?.maKH,finalMaKH:l.maKH,maNVLap:l.maNVLap}),console.log("üîó API endpoint:",`${v.BASE_URL}/api/hoadon/${e.invoiceId}`),console.log("üîó Full API URL:",`${v.BASE_URL}/api/hoadon/${e.invoiceId}`),console.log("üîë Full Authorization header:",`Bearer ${a}`),console.log("üì§ Full request body:",JSON.stringify(l,null,2)),console.log("üîç Testing if API endpoint exists...");try{const u=await fetch(`${v.BASE_URL}/api/hoadon/${e.invoiceId}`,{method:"GET",headers:{Authorization:`Bearer ${a}`}});if(console.log("üîç GET test response status:",u.status),u.ok){const k=await u.json().catch(()=>({}));console.log("üîç GET test response data:",k)}}catch(u){console.log("üîç GET test failed:",u)}const g=await fetch(`${v.BASE_URL}/api/hoadon/${e.invoiceId}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(l)});if(console.log("üì° Invoice update response status:",g.status),console.log("üì° Invoice update response headers:",Object.fromEntries(g.headers.entries())),g.ok){const u=await g.json().catch(()=>({}));console.log("‚úÖ Invoice updated with coupon information successfully"),console.log("üì• Update response:",u),p("Th√¥ng tin khuy·∫øn m√£i ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√†o h√≥a ƒë∆°n!","success")}else{console.log("‚ö†Ô∏è Failed to update invoice with coupon info, but order was created successfully");const u=await g.text();console.log("‚ùå Status:",g.status),console.log("‚ùå Status text:",g.statusText),console.log("‚ùå Error response:",u),console.log("üîÑ Trying fallback: update invoice status first...");try{const k=await fetch(`${v.BASE_URL}/api/hoadon/${e.invoiceId}/trangthai/1`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(k.ok){console.log("‚úÖ Status update successful"),console.log("üîÑ Now trying to update coupon info...");try{const T=await fetch(`${v.BASE_URL}/api/hoadon/${e.invoiceId}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({maKM:s||d.value.code,tienGiamGia:_.value,tongTienSauGiamGia:b.value})});if(T.ok)console.log("‚úÖ Coupon info update successful"),p("Th√¥ng tin khuy·∫øn m√£i ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!","success");else{console.log("‚ö†Ô∏è Coupon info update failed:",T.status);const j=await T.text();console.log("‚ùå Coupon update error:",j),console.log("üîÑ Trying final fallback: direct invoice update...");try{const C=await fetch(`${v.BASE_URL}/api/hoadon/${e.invoiceId}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({maKM:s||d.value.code,tienGiamGia:_.value,tongTienSauGiamGia:b.value,ghiChu:`√Åp d·ª•ng m√£ khuy·∫øn m√£i: ${d.value.code} - Gi·∫£m: ${M(_.value)}`})});if(C.ok)console.log("‚úÖ Final fallback successful with PATCH"),p("Th√¥ng tin khuy·∫øn m√£i ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t qua PATCH!","success");else{console.log("‚ùå Final fallback also failed:",C.status);const Se=await C.text();console.log("‚ùå Final error:",Se)}}catch(C){console.error("‚ùå Final fallback error:",C)}}}catch(T){console.error("‚ùå Coupon update error:",T)}}else{console.log("‚ùå Status update failed:",k.status);const T=await k.text();console.log("‚ùå Status error:",T)}}catch(k){console.error("‚ùå Fallback error:",k)}}}else console.log("‚ö†Ô∏è Cannot update invoice: Token missing"),console.log("üîë Token from cookie:",$())}catch(a){console.error("‚ùå Error updating invoice with coupon info:",a),console.error("‚ùå Error details:",{message:a.message,stack:a.stack,name:a.name})}else console.log("‚ÑπÔ∏è No coupon or invoiceId, skipping invoice update"),console.log("üîç Applied coupon:",d.value),console.log("üîç Order invoiceId:",e.invoiceId);console.log("üßπ Clearing cart after successful checkout...");try{await me(),console.log("‚úÖ Backend cart cleared successfully")}catch(a){console.warn("‚ö†Ô∏è Failed to clear backend cart:",a)}localStorage.removeItem("easymart-selected-items"),console.log("üßπ localStorage cleared"),await Ae(e)}catch{p("C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng. Vui l√≤ng th·ª≠ l·∫°i!","error")}finally{W.value=!1}},Ae=async t=>{const e=i.value.paymentMethod;switch(console.log("üíæ Saving order to localStorage:",{orderCode:t.orderCode,coupon:t.coupon,couponDiscount:t.summary?.couponDiscount,total:t.summary?.total,appliedCoupon:d.value}),localStorage.setItem("easymart-last-order",JSON.stringify(t)),e){case"Ti·ªÅn M·∫∑t":p(`ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${I.value}. B·∫°n s·∫Ω thanh to√°n khi nh·∫≠n h√†ng.`,"success");try{console.log('üîÑ Updating order status to "Pending Payment" for COD payment...');const a=$();if(a&&t.invoiceId){console.log("üîë Token found for status update:",a?"Present":"Missing"),console.log("üÜî Invoice ID for status update:",t.invoiceId);const o=await fetch(`${v.BASE_URL}/api/hoadon/${t.invoiceId}/trangthai/1`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(o.ok)console.log('‚úÖ Order status updated to "Pending Payment" successfully'),p("Tr·∫°ng th√°i ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!","success");else{console.log("‚ö†Ô∏è Failed to update order status, but order was created successfully");const r=await o.text();console.log("‚ùå Status update error response:",r),console.log("üîÑ Trying fallback: direct invoice update...");try{const s=await fetch(`${v.BASE_URL}/api/hoadon/${t.invoiceId}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({trangThai:1,ghiChu:"ƒê∆°n h√†ng COD - Ch·ªù thanh to√°n khi nh·∫≠n h√†ng"})});s.ok?(console.log("‚úÖ Fallback status update successful"),p("Tr·∫°ng th√°i ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t qua fallback!","success")):console.log("‚ö†Ô∏è Fallback also failed:",s.status)}catch(s){console.error("‚ùå Fallback error:",s)}}}else console.log("‚ö†Ô∏è Cannot update status: Token or Invoice ID missing"),console.log("üîë Token:",a?"Present":"Missing"),console.log("üÜî Invoice ID:",t.invoiceId)}catch(a){console.error("‚ùå Error updating order status:",a)}setTimeout(()=>{E.push({name:"PaymentSuccess",query:{orderCode:I.value,total:b.value,paymentMethod:e,orderStatus:"pending_payment"}})},2e3);return;case"Chuy·ªÉn Kho·∫£n":p(`ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${I.value}. Vui l√≤ng chuy·ªÉn kho·∫£n theo th√¥ng tin ƒë√£ cung c·∫•p.`,"success");try{console.log('üîÑ Updating order status to "Pending Payment" for bank transfer...');const a=$();if(a&&t.invoiceId){console.log("üîë Token found for status update:",a?"Present":"Missing"),console.log("üÜî Invoice ID for status update:",t.invoiceId);const o=await fetch(`${v.BASE_URL}/api/hoadon/${t.invoiceId}/trangthai/1`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(o.ok)console.log('‚úÖ Order status updated to "Pending Payment" successfully'),p("Tr·∫°ng th√°i ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!","success");else{console.log("‚ö†Ô∏è Failed to update order status, but order was created successfully");const r=await o.text();console.log("‚ùå Status update error response:",r)}}else console.log("‚ö†Ô∏è Cannot update status: Token or Invoice ID missing"),console.log("üîë Token:",a?"Present":"Missing"),console.log("üÜî Invoice ID:",t.invoiceId)}catch(a){console.error("‚ùå Error updating order status:",a)}setTimeout(()=>{E.push({name:"PaymentSuccess",query:{orderCode:I.value,total:b.value,paymentMethod:e,orderStatus:"pending_payment"}})},2e3);return;case"MoMo":p("ƒêang chuy·ªÉn ƒë·∫øn MoMo ƒë·ªÉ thanh to√°n...","info");try{console.log('üîÑ Updating order status to "Pending Payment" for MoMo...');const a=$();if(a&&t.invoiceId){console.log("üîë Token found for status update:",a?"Present":"Missing"),console.log("üÜî Invoice ID for status update:",t.invoiceId);const o=await fetch(`${v.BASE_URL}/api/hoadon/${t.invoiceId}/trangthai/1`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(o.ok)console.log('‚úÖ Order status updated to "Pending Payment" successfully');else{console.log("‚ö†Ô∏è Failed to update order status, but order was created successfully");const r=await o.text();console.log("‚ùå Status update error response:",r)}}else console.log("‚ö†Ô∏è Cannot update status: Token or Invoice ID missing"),console.log("üîë Token:",a?"Present":"Missing"),console.log("üÜî Invoice ID:",t.invoiceId)}catch(a){console.error("‚ùå Error updating order status:",a)}setTimeout(()=>{E.push({name:"PaymentSuccess",query:{orderCode:I.value,total:b.value,paymentMethod:e,orderStatus:"pending_payment"}})},2e3);return;case"ZaloPay":p("ƒêang chuy·ªÉn ƒë·∫øn ZaloPay ƒë·ªÉ thanh to√°n...","info");try{console.log('üîÑ Updating order status to "Pending Payment" for ZaloPay...');const a=$();if(a&&t.invoiceId){console.log("üîë Token found for status update:",a?"Present":"Missing"),console.log("üÜî Invoice ID for status update:",t.invoiceId);const o=await fetch(`${v.BASE_URL}/api/hoadon/${t.invoiceId}/trangthai/1`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(o.ok)console.log('‚úÖ Order status updated to "Pending Payment" successfully');else{console.log("‚ö†Ô∏è Failed to update order status, but order was created successfully");const r=await o.text();console.log("‚ùå Status update error response:",r)}}else console.log("‚ö†Ô∏è Cannot update status: Token or Invoice ID missing"),console.log("üîë Token:",a?"Present":"Missing"),console.log("üÜî Invoice ID:",t.invoiceId)}catch(a){console.error("‚ùå Error updating order status:",a)}setTimeout(()=>{E.push({name:"PaymentSuccess",query:{orderCode:I.value,total:b.value,paymentMethod:e,orderStatus:"pending_payment"}})},2e3);return;case"Th·∫ª T√≠n D·ª•ng":p("ƒêang chuy·ªÉn ƒë·∫øn c·ªïng thanh to√°n...","info");try{console.log('üîÑ Updating order status to "Pending Payment" for Credit Card...');const a=$();if(a&&t.invoiceId){console.log("üîë Token found for status update:",a?"Present":"Missing"),console.log("üÜî Invoice ID for status update:",t.invoiceId);const o=await fetch(`${v.BASE_URL}/api/hoadon/${t.invoiceId}/trangthai/1`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(o.ok)console.log('‚úÖ Order status updated to "Pending Payment" successfully');else{console.log("‚ö†Ô∏è Failed to update order status, but order was created successfully");const r=await o.text();console.log("‚ùå Status update error response:",r)}}else console.log("‚ö†Ô∏è Cannot update status: Token or Invoice ID missing"),console.log("üîë Token:",a?"Present":"Missing"),console.log("üÜî Invoice ID:",t.invoiceId)}catch(a){console.error("‚ùå Error updating order status:",a)}setTimeout(()=>{E.push({name:"PaymentSuccess",query:{orderCode:I.value,total:b.value,paymentMethod:e,orderStatus:"pending_payment"}})},2e3);return;case"VNPay":try{ee.value=!0,p("ƒêang chuy·ªÉn ƒë·∫øn VNPay ƒë·ªÉ thanh to√°n...","info");const a=$();if(!a){p("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n qua VNPay!","error");return}const o={vnp_OrderInfo:`Thanh to√°n ƒë∆°n h√†ng ${I.value}`,ordertype:"other",amount:Math.round(b.value).toString(),maHD:I.value.replace(/^(HD|EM)/,""),language:"vn",txt_billing_mobile:"0905123456",txt_billing_email:"nguyenvana@example.com",txt_billing_fullname:"Nguyen Van A",txt_inv_addr1:"123 Duong So 1, Quan 1, TP.HCM"};if(Object.keys(o).forEach(g=>{(o[g]===void 0||o[g]===null)&&(o[g]="")}),console.log("üí≥ Amount conversion:",{original:b.value,converted:o.amount,originalType:typeof b.value,convertedType:typeof o.amount}),console.log("üìã API Format Comparison:",{expected:{amount:"100000",amountType:"string"},actual:{amount:o.amount,amountType:typeof o.amount},match:typeof o.amount=="string"}),console.log("üìã Form Data vs Default Template:",{template:{txt_billing_mobile:"0905123456",txt_billing_email:"nguyenvana@example.com",txt_billing_fullname:"Nguyen Van A",txt_inv_addr1:"123 Duong So 1, Quan 1, TP.HCM"},actual:{txt_billing_mobile:o.txt_billing_mobile,txt_billing_email:o.txt_billing_email,txt_billing_fullname:o.txt_billing_fullname,txt_inv_addr1:o.txt_inv_addr1},note:"Using default values as per API template"}),console.log("üîç Pre-validation check:",{txt_billing_mobile:o.txt_billing_mobile,txt_billing_fullname:o.txt_billing_fullname,txt_inv_addr1:o.txt_inv_addr1,amount:o.amount,maHD:o.maHD,maHDType:typeof o.maHD,maHDLength:o.maHD?o.maHD.length:"N/A"}),console.log("üîç Validating txt_billing_mobile:",o.txt_billing_mobile,"Result:",!!o.txt_billing_mobile),!o.txt_billing_mobile||!o.txt_billing_fullname||!o.txt_inv_addr1)throw new Error("Th√¥ng tin giao h√†ng kh√¥ng ƒë·∫ßy ƒë·ªß ƒë·ªÉ thanh to√°n VNPay");if(console.log("üîç Validating amount:",o.amount,"Result:",!!(o.amount&&Number(o.amount)>0)),!o.amount||Number(o.amount)<=0)throw new Error("S·ªë ti·ªÅn thanh to√°n kh√¥ng h·ª£p l·ªá");if(console.log("üîç Validating maHD:",o.maHD,"Result:",!!(o.maHD&&o.maHD!=="NEW")),!o.maHD||o.maHD==="NEW")throw new Error("M√£ h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i!");console.log("üí≥ VNPay payment data:",o),console.log("üí≥ Original orderCode:",I.value),console.log("üí≥ Extracted maHD:",o.maHD),console.log("üí≥ Amount type:",typeof o.amount,"Value:",o.amount),console.log("üí≥ VNPay API endpoint:",`${v.BASE_URL}/api/thanhtoan/vnpay`),console.log("üí≥ VNPay token:",a?"Present":"Missing"),console.log("üí≥ Request body:",JSON.stringify(o,null,2));const r=await fetch(`${v.BASE_URL}/api/thanhtoan/vnpay`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(o)});if(!r.ok){const g=await r.json().catch(()=>({})),u=g.message||g.error||"Unknown error";throw console.error("‚ùå VNPay API error response:",g),new Error(`VNPay API error: ${r.status} - ${u}`)}const s=await r.json();console.log("üí≥ VNPay API response:",s),console.log("üí≥ VNPay response keys:",Object.keys(s)),console.log("üí≥ VNPay response data:",s.data),console.log("üí≥ VNPay response type:",typeof s),console.log("üí≥ VNPay data type:",typeof s.data),console.log("üí≥ VNPay data starts with http:",s.data&&typeof s.data=="string"?s.data.startsWith("http"):"N/A");let l=null;if(s?.data&&typeof s.data=="string"&&s.data.startsWith("http")?l=s.data:s?.data?.paymentUrl?l=s.data.paymentUrl:s?.paymentUrl?l=s.paymentUrl:s?.url?l=s.url:s?.vnp_PayUrl?l=s.vnp_PayUrl:s?.redirectUrl?l=s.redirectUrl:typeof s=="string"&&s.startsWith("http")&&(l=s),console.log("üí≥ Extracted payment URL:",l),l)console.log("üîÑ Redirecting to VNPay:",l),p("Chuy·ªÉn h∆∞·ªõng ƒë·∫øn VNPay...","success"),setTimeout(()=>{window.location.href=l},1e3);else throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c URL thanh to√°n t·ª´ VNPay API")}catch(a){console.error("‚ùå VNPay payment error:",a),p(`L·ªói thanh to√°n VNPay: ${a.message}`,"error"),setTimeout(()=>{p(`Thanh to√°n VNPay th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${I.value}`,"success"),E.push({name:"PaymentSuccess",query:{orderCode:I.value,total:b.value,paymentMethod:e}})},2e3)}finally{ee.value=!1}return;default:p(`ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${I.value}`,"success");try{console.log('üîÑ Updating order status to "Pending Payment" for default payment method...');const a=$();if(a&&t.invoiceId){console.log("üîë Token found for status update:",a?"Present":"Missing"),console.log("üÜî Invoice ID for status update:",t.invoiceId);const o=await fetch(`${v.BASE_URL}/api/hoadon/${t.invoiceId}/trangthai/1`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(o.ok)console.log('‚úÖ Order status updated to "Pending Payment" successfully');else{console.log("‚ö†Ô∏è Failed to update order status, but order was created successfully");const r=await o.text();console.log("‚ùå Status update error response:",r)}}else console.log("‚ö†Ô∏è Cannot update status: Token or Invoice ID missing"),console.log("üîë Token:",a?"Present":"Missing"),console.log("üÜî Invoice ID:",t.invoiceId)}catch(a){console.error("‚ùå Error updating order status:",a)}setTimeout(()=>{E.push({name:"PaymentSuccess",query:{orderCode:I.value,total:b.value,paymentMethod:e,orderStatus:"pending_payment"}})},2e3);return}},ce=async()=>{try{console.log("üì° Fetching shipping info from Shipping API..."),ie.value=!0;let t=D?.maKH||c.value?.customerInfo?.maKH||c.value?.maKH||c.value?.khachHang?.maKH;if(console.log("üîë Found maKH from sources:",{cart:D?.maKH,userCustomerInfo:c.value?.customerInfo?.maKH,userMaKH:c.value?.maKH,userKhachHang:c.value?.khachHang?.maKH,final:t}),D?.maKH)t=D.maKH,console.log("‚úÖ Using maKH from cart (most reliable):",t);else if(!t){console.log("üîç No maKH found from any source, trying API...");const g=await O();if(g)t=g,console.log("‚úÖ Got maKH from API:",t),c.value&&(c.value.customerInfo||(c.value.customerInfo={}),c.value.customerInfo.maKH=g,c.value.maKH=g,c.value.khachHang={maKH:g});else{console.log("‚ùå No maKH found from API, cannot fetch shipping info"),p("Kh√¥ng th·ªÉ x√°c ƒë·ªãnh th√¥ng tin kh√°ch h√†ng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!","warning");return}}const e=B();if(!e){console.log("‚ö†Ô∏è No token found, cannot fetch shipping info");return}let a=`${v.BASE_URL}/api/khachhang/${t}/shipping-info`;console.log("üîó Trying Shipping API endpoint first:",a);let o=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),r="Shipping API";if(!o.ok&&(console.log("‚ö†Ô∏è Shipping API failed:",o.status,"falling back to Profile API..."),a=`${v.BASE_URL}/api/khachhang/${t}/info`,console.log("üîÑ Fallback to Profile API endpoint:",a),o=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}}),r="Profile API (fallback)",!o.ok)){console.log("‚ö†Ô∏è Profile API also failed:",o.status);return}const s=await o.json();console.log(`üì• ${r} response:`,s);let l=null;s?.data?l=s.data:s?.result?l=s.result:s?.hoTen||s?.sdt||s?.diaChi?l=s:Array.isArray(s)&&(l=s[0]),l&&(console.log(`‚úÖ Data received from ${r}:`,l),console.log("üîç Available fields:",Object.keys(l)),console.log("üìù Current form values before update:",{fullName:i.value.fullName,phone:i.value.phone,email:i.value.email,address:i.value.address}),c.value?.customerInfo&&(c.value.customerInfo={...c.value.customerInfo,...l}),l.hoTen&&(i.value.fullName=l.hoTen),(l.sdt||l.soDienThoai)&&(i.value.phone=l.sdt||l.soDienThoai),l.diaChi&&(i.value.address=l.diaChi),l.email?i.value.email=l.email:l.nguoiDung?.email&&(i.value.email=l.nguoiDung.email),console.log("üìù Form values after update:",{fullName:i.value.fullName,phone:i.value.phone,email:i.value.email,address:i.value.address}),console.log(`‚úÖ Info updated from ${r}`))}catch(t){console.error("‚ùå Error fetching shipping info:",t)}finally{ie.value=!1}};return xe(async()=>{if(console.log("üöÄ Checkout page mounted"),console.log("üîê Checking authentication status..."),!X()){console.log("‚ùå Authentication failed, redirecting to login..."),p("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!","warning"),setTimeout(()=>{E.push("/login")},2e3);return}console.log("‚úÖ Authentication successful, proceeding..."),await le(),console.log("üîç Ensuring maKH is available before fetching shipping info...");let t=D?.maKH||c.value?.customerInfo?.maKH||c.value?.maKH||c.value?.khachHang?.maKH;if(!t){console.log("üîç No maKH found, getting from API immediately...");const o=await O();o&&(t=o,c.value&&(c.value.customerInfo||(c.value.customerInfo={}),c.value.customerInfo.maKH=o,c.value.maKH=o,c.value.khachHang={maKH:o}),console.log("‚úÖ Got maKH from API in onMounted:",t))}await ce();const e=localStorage.getItem("easymart-invoice"),a=localStorage.getItem("easymart-selected-items");if(e&&a){const o=JSON.parse(e),r=JSON.parse(a);if(console.log("üìã Nh·∫≠n h√≥a ƒë∆°n:",o),console.log("üõí Selected items:",r),console.log("üîç Invoice structure:",Object.keys(o)),I.value=`HD${o.maHD||o.orderId||"NEW"}`,o.chiTietHoaDon&&o.chiTietHoaDon.length>0?(console.log("‚úÖ S·ª≠ d·ª•ng chiTietHoaDon t·ª´ Orders.vue"),w.value=o.chiTietHoaDon.map(s=>({productId:s.maSP||s.productId,quantity:s.soLuong||s.quantity,product:{id:s.maSP||s.productId,name:s.tenSP||s.productName,price:s.donGiaBan||s.donGia||s.productPrice,image:J(s.maSP||s.productId)}}))):o.items&&o.items.length>0?(console.log("‚úÖ S·ª≠ d·ª•ng items t·ª´ Cart.vue/ProductDetail"),w.value=o.items.map(s=>({productId:s.maSP||s.productId,quantity:s.soLuong||s.quantity,product:{id:s.maSP||s.productId,name:s.tenSP||s.productName,price:s.donGiaBan||s.donGia||s.productPrice,image:J(s.maSP||s.productId)}}))):(console.log("‚ö†Ô∏è Kh√¥ng c√≥ items trong h√≥a ƒë∆°n, th·ª≠ fallback..."),w.value=D.value.filter(s=>r.includes(s.productId)).map(s=>{const l=ae.value.find(g=>g.id===s.productId);return l&&(l.image=J(s.productId)),{...s,product:l}}).filter(s=>s.product)),X(),o.coupon){console.log("üé´ Loading coupon from invoice data:",o.coupon);const s={code:o.coupon.code,description:o.coupon.description,discountType:o.coupon.discountType,discountValue:o.coupon.discountValue,minOrderValue:0,maxDiscount:o.coupon.discountValue*1e3,isActive:!0};d.value=s,H.value=o.coupon.code,console.log("‚úÖ Coupon applied from invoice:",d.value)}else{const s=localStorage.getItem("easymart-last-order");if(s){const l=JSON.parse(s);l.coupon&&l.coupon.code===o.maHD&&(console.log("üé´ Loading coupon from last order data:",l.coupon),d.value=l.coupon,H.value=l.coupon.code)}}await se()}else{if(I.value=be(),a){const o=JSON.parse(a);w.value=D.value.filter(r=>o.includes(r.productId)).map(r=>{const s=ae.value.find(l=>l.id===r.productId);return s&&(s.image=J(r.productId)),{...r,product:s}}).filter(r=>r.product)}X(),await se()}console.log("üìä Final selectedItems state:"),console.log("   - Length:",w.value.length),console.log("   - Items:",w.value),console.log("   - Invoice data:",e?JSON.parse(e):"None"),console.log("   - Stored selected items:",a),w.value.length===0?(console.warn("‚ö†Ô∏è No selected items found, redirecting to cart..."),p("Vui l√≤ng ch·ªçn s·∫£n ph·∫©m t·ª´ gi·ªè h√†ng ƒë·ªÉ thanh to√°n","warning"),setTimeout(()=>{E.push("/cart")},2e3)):console.log("‚úÖ Selected items loaded successfully, staying on checkout page")}),(t,e)=>{const a=Ee("router-link");return f(),m("div",Ge,[n("div",Ve,[n("nav",Re,[n("ol",Le,[n("li",Be,[F(a,{to:"/",class:"text-decoration-none"},{default:q(()=>e[8]||(e[8]=[n("i",{class:"fas fa-home"},null,-1),y(" Trang ch·ªß ")])),_:1,__:[8]})]),K.value?S("",!0):(f(),m("li",Oe,[F(a,{to:"/cart",class:"text-decoration-none"},{default:q(()=>e[9]||(e[9]=[n("i",{class:"fas fa-shopping-cart"},null,-1),y(" Gi·ªè h√†ng ")])),_:1,__:[9]})])),K.value?(f(),m("li",je,e[10]||(e[10]=[n("span",{class:"text-muted"},[n("i",{class:"fas fa-bolt"}),y(" Mua ngay ")],-1)]))):S("",!0),e[11]||(e[11]=n("li",{class:"breadcrumb-item active","aria-current":"page"},[n("i",{class:"fas fa-credit-card"}),y(" Thanh to√°n ")],-1))])]),n("div",Fe,[n("h2",qe,[e[12]||(e[12]=n("i",{class:"fas fa-credit-card text-primary me-2"},null,-1)),y(" "+h(K.value?"Thanh to√°n mua ngay":"Thanh to√°n ƒë∆°n h√†ng"),1)])]),w.value.length>0?(f(),m("div",ze,[n("div",Je,[n("div",We,[e[20]||(e[20]=n("div",{class:"card-header bg-primary text-white"},[n("h5",{class:"mb-0"},[n("i",{class:"fas fa-truck me-2"}),y(" Th√¥ng tin giao h√†ng ")])],-1)),n("div",Qe,[n("form",{onSubmit:$e(re,["prevent"])},[n("div",Ze,[n("div",Ye,[e[13]||(e[13]=n("label",{for:"fullName",class:"form-label"},"H·ªç v√† t√™n *",-1)),G(n("input",{type:"text",class:R(["form-control",{"is-invalid":P.value.fullName}]),id:"fullName","onUpdate:modelValue":e[0]||(e[0]=o=>i.value.fullName=o),required:""},null,2),[[L,i.value.fullName]]),P.value.fullName?(f(),m("div",Xe,h(P.value.fullName),1)):S("",!0)]),n("div",eo,[e[14]||(e[14]=n("label",{for:"phone",class:"form-label"},"S·ªë ƒëi·ªán tho·∫°i *",-1)),G(n("input",{type:"tel",class:R(["form-control",{"is-invalid":P.value.phone}]),id:"phone","onUpdate:modelValue":e[1]||(e[1]=o=>i.value.phone=o),required:""},null,2),[[L,i.value.phone]]),P.value.phone?(f(),m("div",oo,h(P.value.phone),1)):S("",!0)])]),n("div",no,[e[15]||(e[15]=n("label",{for:"email",class:"form-label"},"Email",-1)),G(n("input",{type:"email",class:R(["form-control",{"is-invalid":P.value.email}]),id:"email","onUpdate:modelValue":e[2]||(e[2]=o=>i.value.email=o)},null,2),[[L,i.value.email]]),P.value.email?(f(),m("div",to,h(P.value.email),1)):S("",!0)]),n("div",ao,[e[16]||(e[16]=n("label",{for:"address",class:"form-label"},"ƒê·ªãa ch·ªâ giao h√†ng *",-1)),G(n("textarea",{class:R(["form-control",{"is-invalid":P.value.address}]),id:"address",rows:"3","onUpdate:modelValue":e[3]||(e[3]=o=>i.value.address=o),placeholder:"S·ªë nh√†, t√™n ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë",required:""},null,2),[[L,i.value.address]]),P.value.address?(f(),m("div",so,h(P.value.address),1)):S("",!0)]),n("div",lo,[e[17]||(e[17]=n("label",{for:"notes",class:"form-label"},"Ghi ch√∫ ƒë∆°n h√†ng",-1)),G(n("textarea",{class:"form-control",id:"notes",rows:"2","onUpdate:modelValue":e[4]||(e[4]=o=>i.value.notes=o),placeholder:"Ghi ch√∫ v·ªÅ ƒë∆°n h√†ng, v√≠ d·ª•: th·ªùi gian hay ch·ªâ d·∫´n ƒë·ªãa ƒëi·ªÉm giao h√†ng chi ti·∫øt h∆°n."},null,512),[[L,i.value.notes]])]),N(z)?(f(),m("div",io,[n("div",ro,[F(a,{to:"/profile",class:"btn btn-outline-info btn-sm",title:"Chuy·ªÉn ƒë·∫øn trang Profile ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng tin"},{default:q(()=>e[18]||(e[18]=[n("i",{class:"fas fa-user-edit me-2"},null,-1),y(" C·∫≠p nh·∫≠t th√¥ng tin t·ª´ Profile ")])),_:1,__:[18]})]),e[19]||(e[19]=n("div",{class:"mt-2"},[n("small",{class:"text-muted"},[n("i",{class:"fas fa-info-circle me-1"}),y(" Th√¥ng tin giao h√†ng s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c ƒë·ªìng b·ªô v·ªõi Profile khi ƒë·∫∑t h√†ng ")])],-1))])):S("",!0)],32)])]),n("div",co,[e[35]||(e[35]=n("div",{class:"card-header bg-success text-white"},[n("h5",{class:"mb-0"},[n("i",{class:"fas fa-money-bill-wave me-2"}),y(" Ph∆∞∆°ng th·ª©c thanh to√°n ")])],-1)),n("div",uo,[oe.value?(f(),m("div",go,e[21]||(e[21]=[n("div",{class:"spinner-border text-success",role:"status"},[n("span",{class:"visually-hidden"},"ƒêang t·∫£i...")],-1),n("p",{class:"mt-2 text-muted"},"ƒêang t·∫£i ph∆∞∆°ng th·ª©c thanh to√°n...",-1)]))):Q.value.length>0?(f(),m("div",po,[(f(!0),m(ue,null,de(Q.value,o=>(f(),m("div",{key:o.maPTTT,class:"col-md-6 mb-3"},[n("div",ho,[G(n("input",{class:"form-check-input",type:"radio",name:"paymentMethod",id:o.maPTTT,value:o.tenPTTT,"onUpdate:modelValue":e[5]||(e[5]=r=>i.value.paymentMethod=r)},null,8,mo),[[ge,i.value.paymentMethod]]),n("label",{class:"form-check-label w-100",for:o.maPTTT},[n("div",vo,[n("i",{class:R([ye(o.tenPTTT),"me-3 fs-4"])},null,2),n("div",null,[n("strong",null,h(o.tenPTTT),1),n("div",yo,h(o.moTa),1),o.phiGiaoDich>0?(f(),m("div",ko," Ph√≠ giao d·ªãch: "+h(N(M)(o.phiGiaoDich)),1)):S("",!0)])])],8,fo)])]))),128))])):ne.value?(f(),m("div",To,[e[23]||(e[23]=n("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),e[24]||(e[24]=y(" Kh√¥ng th·ªÉ t·∫£i ph∆∞∆°ng th·ª©c thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i sau. ")),n("button",{onClick:le,class:"btn btn-sm btn-outline-warning ms-2"},e[22]||(e[22]=[n("i",{class:"fas fa-redo me-1"},null,-1),y("Th·ª≠ l·∫°i ")]))])):(f(),m("div",bo,[n("div",Io,[n("div",Po,[G(n("input",{class:"form-check-input",type:"radio",name:"paymentMethod",id:"cod",value:"Ti·ªÅn M·∫∑t","onUpdate:modelValue":e[6]||(e[6]=o=>i.value.paymentMethod=o),checked:""},null,512),[[ge,i.value.paymentMethod]]),e[25]||(e[25]=n("label",{class:"form-check-label w-100",for:"cod"},[n("div",{class:"d-flex align-items-center"},[n("i",{class:"fas fa-hand-holding-usd text-success me-3 fs-4"}),n("div",null,[n("strong",null,"Thanh to√°n khi nh·∫≠n h√†ng (COD)"),n("div",{class:"text-muted small"},"Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng")])])],-1))])])])),i.value.paymentMethod&&x.value?(f(),m("div",_o,[n("h6",wo,[e[26]||(e[26]=n("i",{class:"fas fa-info-circle me-2"},null,-1)),y(" Th√¥ng tin "+h(x.value.tenPTTT),1)]),n("div",Co,[n("div",Ao,[n("p",So,[e[27]||(e[27]=n("strong",null,"S·ªë ti·ªÅn:",-1)),y(" "+h(N(M)(b.value)),1)]),n("p",Mo,[e[28]||(e[28]=n("strong",null,"M√£ ƒë∆°n h√†ng:",-1)),y(" "+h(I.value),1)]),x.value.phiGiaoDich>0?(f(),m("p",Do,[e[29]||(e[29]=n("strong",null,"Ph√≠ giao d·ªãch:",-1)),y(" "+h(N(M)(x.value.phiGiaoDich)),1)])):S("",!0)]),n("div",Ho,[n("p",xo,[n("small",null,[e[30]||(e[30]=n("strong",null,"H∆∞·ªõng d·∫´n:",-1)),y(" "+h(ke(x.value.tenPTTT)),1)])])])]),x.value.tenPTTT==="Chuy·ªÉn Kho·∫£n"?(f(),m("div",Ko,[e[34]||(e[34]=n("h6",{class:"text-primary mb-2"},"Th√¥ng tin chuy·ªÉn kho·∫£n",-1)),n("div",No,[e[33]||(e[33]=n("div",{class:"col-md-6"},[n("p",{class:"mb-1"},[n("strong",null,"Ng√¢n h√†ng:"),y(" Vietcombank")]),n("p",{class:"mb-1"},[n("strong",null,"S·ªë t√†i kho·∫£n:"),y(" 1234567890")]),n("p",{class:"mb-1"},[n("strong",null,"Ch·ªß t√†i kho·∫£n:"),y(" EASYMART COMPANY")])],-1)),n("div",Eo,[n("p",$o,[e[31]||(e[31]=n("strong",null,"N·ªôi dung:",-1)),y(" THANHTOAN "+h(I.value),1)]),e[32]||(e[32]=n("p",{class:"mb-0 text-danger"},[n("small",null,[n("strong",null,"L∆∞u √Ω:"),y(" Vui l√≤ng chuy·ªÉn kho·∫£n ƒë√∫ng n·ªôi dung ƒë·ªÉ ƒë∆°n h√†ng ƒë∆∞·ª£c x·ª≠ l√Ω nhanh ch√≥ng.")])],-1))])])])):S("",!0)])):S("",!0)])])]),n("div",Uo,[n("div",Go,[e[44]||(e[44]=n("div",{class:"card-header bg-warning text-dark"},[n("h5",{class:"mb-0"},[n("i",{class:"fas fa-receipt me-2"}),y(" ƒê∆°n h√†ng c·ªßa b·∫°n ")])],-1)),n("div",Vo,[n("div",Ro,[(f(!0),m(ue,null,de(w.value,o=>(f(),m("div",{key:o.productId,class:"order-item d-flex align-items-center mb-3 pb-3 border-bottom"},[n("img",{src:o.product?.image,alt:o.product?.name,class:"order-item-image me-3"},null,8,Lo),n("div",Bo,[n("h6",Oo,h(o.product?.name),1),n("div",jo,[n("span",Fo,h(N(M)(o.product?.price||0))+" x "+h(o.quantity),1),n("span",qo,h(N(M)((o.product?.price||0)*o.quantity)),1)])])]))),128))]),n("div",zo,[n("div",Jo,[n("span",null,"T·∫°m t√≠nh ("+h(te.value)+" s·∫£n ph·∫©m):",1),n("span",null,h(N(M)(U.value)),1)]),x.value&&x.value.phiGiaoDich>0?(f(),m("div",Wo,[n("span",null,"Ph√≠ giao d·ªãch ("+h(x.value.tenPTTT)+"):",1),n("span",Qo,h(N(M)(x.value.phiGiaoDich)),1)])):S("",!0),n("div",Zo,[n("div",Yo,[G(n("input",{type:"text",class:"form-control form-control-sm",placeholder:"Nh·∫≠p m√£ khuy·∫øn m√£i","onUpdate:modelValue":e[7]||(e[7]=o=>H.value=o),disabled:d.value},null,8,Xo),[[L,H.value]]),n("button",{class:"btn btn-outline-primary btn-sm",onClick:Pe,disabled:!H.value.trim()||d.value||Z.value},[Z.value?(f(),m("span",on,e[36]||(e[36]=[n("i",{class:"fas fa-spinner fa-spin"},null,-1)]))):(f(),m("span",nn,h(d.value?"ƒê√£ √°p d·ª•ng":"√Åp d·ª•ng"),1))],8,en)]),d.value?(f(),m("div",tn,[n("div",an,[n("div",null,[n("small",sn,[e[37]||(e[37]=n("i",{class:"fas fa-ticket-alt me-1"},null,-1)),y(" "+h(d.value.code),1)]),n("div",ln,h(d.value.description),1)]),n("button",{class:"btn btn-sm",style:{background:"linear-gradient(135deg, #ff6b6b, #ee5a5a)",color:"white",border:"none"},onClick:_e,title:"X√≥a m√£ khuy·∫øn m√£i"},e[38]||(e[38]=[n("i",{class:"fas fa-times"},null,-1)]))])])):S("",!0),_.value>0?(f(),m("div",rn,[n("span",null,"Gi·∫£m gi√° ("+h(d.value?.code)+"):",1),n("span",null,"-"+h(N(M)(_.value)),1)])):S("",!0)]),e[43]||(e[43]=n("hr",null,null,-1)),n("div",cn,[e[39]||(e[39]=n("strong",{class:"fs-5"},"T·ªïng c·ªông:",-1)),n("strong",un,h(N(M)(b.value)),1)]),n("button",{type:"button",class:"btn btn-primary w-100 mb-2 py-2",onClick:re,disabled:W.value||!Te.value},[W.value?(f(),m("span",gn,e[40]||(e[40]=[n("i",{class:"fas fa-spinner fa-spin me-2"},null,-1),y(" ƒêang x·ª≠ l√Ω... ")]))):ee.value?(f(),m("span",pn,e[41]||(e[41]=[n("i",{class:"fas fa-spinner fa-spin me-2"},null,-1),y(" ƒêang chuy·ªÉn ƒë·∫øn VNPay... ")]))):(f(),m("span",hn,e[42]||(e[42]=[n("i",{class:"fas fa-check me-2"},null,-1),y(" ƒê·∫∑t h√†ng ")])))],8,dn),F(a,{to:K.value?"/":"/cart",class:"btn btn-outline-secondary w-100"},{default:q(()=>[n("i",{class:R([K.value?"fas fa-home":"fas fa-arrow-left","me-2"])},null,2),y(" "+h(K.value?"V·ªÅ trang ch·ªß":"Quay l·∫°i gi·ªè h√†ng"),1)]),_:1},8,["to"])])])])])])):(f(),m("div",mn,[n("div",fn,[n("div",vn,[e[45]||(e[45]=n("div",{class:"empty-checkout-icon mb-4"},[n("i",{class:"fas fa-exclamation-triangle fa-5x text-warning"})],-1)),e[46]||(e[46]=n("h3",{class:"text-muted mb-3"},"Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n",-1)),n("p",yn,h(K.value?"Vui l√≤ng quay l·∫°i trang s·∫£n ph·∫©m ƒë·ªÉ mua h√†ng":"Vui l√≤ng quay l·∫°i gi·ªè h√†ng v√† ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n"),1),F(a,{to:K.value?"/":"/cart",class:"btn btn-primary btn-lg"},{default:q(()=>[n("i",{class:R([K.value?"fas fa-home":"fas fa-arrow-left","me-2"])},null,2),y(" "+h(K.value?"V·ªÅ trang ch·ªß":"Quay l·∫°i gi·ªè h√†ng"),1)]),_:1},8,["to"])])])]))])])}}},In=Me(kn,[["__scopeId","data-v-ddf274ba"]]);export{In as default};
