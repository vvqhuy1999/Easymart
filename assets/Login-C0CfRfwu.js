import{_ as L,r,i as M,s as V,p as P,c as u,a as t,d,g,t as y,f as h,w as N,v as k,x as T,L as R,M as q,k as f,l as _,m as B,o as c}from"./index-YAIzo0op.js";import{G as D,F as U}from"./FacebookSignIn-bIobS7pE.js";const $={class:"d-flex justify-content-center align-items-center",style:{"min-height":"80vh",background:"#f8fafc"}},E={class:"card shadow p-4 border-0",style:{"max-width":"400px",width:"100%","border-radius":"1.5rem"}},j={key:0,class:"text-center mb-3"},z={key:1,class:"alert alert-info",role:"alert"},J={key:2,class:"alert alert-danger",role:"alert"},Q={key:3,class:"alert alert-success",role:"alert"},W={class:"mb-3"},H={class:"input-group"},K={class:"mb-3"},X={class:"input-group"},Y=["type"],Z={class:"mb-3 form-check"},ee=["disabled"],te={key:0,class:"fas fa-sign-in-alt me-2"},ae={key:1,class:"spinner-border spinner-border-sm me-2",role:"status"},se={class:"mb-3"},le={class:"mb-3"},oe={__name:"Login",setup(ne){const m=P(),{login:S,loginWithFacebook:C,handleOAuth2Callback:I}=V(),p=r(""),b=r(""),x=r(!1),v=r(!1),a=r(!1),l=r(""),n=r(""),w=r(!1);M(async()=>{const o=localStorage.getItem("easymart-redirect-after-login");w.value=o==="/checkout";const i=new URLSearchParams(window.location.search).get("code");if(i){console.log("Detected OAuth2 callback with code:",i),a.value=!0,n.value="Đang xử lý đăng nhập OAuth2...";try{const s=await I();if(s&&s.success){n.value=`Chào mừng ${s.user.name}! Đăng nhập thành công. Đang chuyển hướng...`,window.history.replaceState({},document.title,window.location.pathname);const G=localStorage.getItem("easymart-redirect-after-login");localStorage.removeItem("easymart-redirect-after-login"),setTimeout(()=>{m.push(G||"/")},1500)}else s&&s.needsRegistration?(l.value=s.error,s.userInfo&&(sessionStorage.setItem("pending-oauth-user-info",JSON.stringify(s.userInfo)),setTimeout(()=>{m.push("/register?oauth=pending")},2e3))):s&&!s.success&&(l.value=s.error||"OAuth2 callback thất bại")}catch(s){console.error("OAuth2 callback error:",s),l.value="Có lỗi xảy ra khi xử lý OAuth2 callback"}finally{a.value=!1}}});async function A(){l.value="",n.value="",a.value=!0;try{const o=await S(p.value,b.value);if(o.success){n.value=`Chào mừng ${o.user.name}! Đang chuyển hướng...`;const e=localStorage.getItem("easymart-redirect-after-login");localStorage.removeItem("easymart-redirect-after-login"),setTimeout(()=>{m.push(e||"/")},1500)}else l.value=o.error||"Đăng nhập thất bại"}catch{l.value="Có lỗi xảy ra, vui lòng thử lại"}finally{a.value=!1}}async function F(o){l.value="",n.value="",a.value=!0;try{if(!o.success){l.value=o.error||"Đăng nhập với Google thất bại",a.value=!1;return}if(o.redirect){n.value=o.message||"Đang chuyển hướng tới Google OAuth2...";return}if(o.credential){l.value="Vui lòng sử dụng OAuth2 flow mới",a.value=!1;return}l.value="Đăng nhập với Google thất bại",a.value=!1}catch(e){console.error("Google login error:",e),l.value="Có lỗi xảy ra khi đăng nhập với Google, vui lòng thử lại",a.value=!1}}async function O(o){l.value="",n.value="",a.value=!0;try{if(!o.success){l.value=o.error||"Đăng nhập với Facebook thất bại";return}const e=await C(o.credential);if(e.success){if(e.redirect){n.value=e.message||"Đang chuyển hướng tới Facebook OAuth2...";return}else if(e.user){n.value=`Chào mừng ${e.user.name}! Đang chuyển hướng...`;const i=localStorage.getItem("easymart-redirect-after-login");localStorage.removeItem("easymart-redirect-after-login"),setTimeout(()=>{m.push(i||"/")},1500)}}else e.needsRegistration?(l.value=e.error,sessionStorage.setItem("pending-facebook-credential",o.credential),setTimeout(()=>{m.push("/register?facebook=pending")},2e3)):l.value=e.error||"Đăng nhập với Facebook thất bại"}catch(e){console.error("Facebook login error:",e),l.value="Có lỗi xảy ra khi đăng nhập với Facebook, vui lòng thử lại"}finally{n.value.includes("chuyển hướng tới Facebook OAuth2")||(a.value=!1)}}return(o,e)=>{const i=B("router-link");return c(),u("div",null,[t("div",$,[t("div",E,[e[16]||(e[16]=t("h2",{class:"mb-4 text-center text-primary fw-bold"},"Đăng nhập",-1)),a.value?(c(),u("div",j,e[4]||(e[4]=[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Đang đăng nhập...")],-1),t("p",{class:"mt-2 text-muted"},"Đang xử lý...",-1)]))):d("",!0),w.value?(c(),u("div",z,e[5]||(e[5]=[t("i",{class:"fas fa-info-circle me-2"},null,-1),g(" Vui lòng đăng nhập để tiến hành thanh toán! ")]))):d("",!0),l.value?(c(),u("div",J,[e[6]||(e[6]=t("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),g(y(l.value),1)])):d("",!0),n.value?(c(),u("div",Q,[e[7]||(e[7]=t("i",{class:"fas fa-check-circle me-2"},null,-1)),g(y(n.value),1)])):d("",!0),t("form",{onSubmit:N(A,["prevent"]),class:h({"d-none":a.value})},[t("div",W,[e[9]||(e[9]=t("label",{for:"email",class:"form-label"},"Email",-1)),t("div",H,[e[8]||(e[8]=t("span",{class:"input-group-text"},[t("i",{class:"fas fa-envelope"})],-1)),k(t("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>p.value=s),type:"email",class:"form-control",id:"email",required:"",autocomplete:"username",placeholder:"Nhập email của bạn"},null,512),[[T,p.value]])])]),t("div",K,[e[11]||(e[11]=t("label",{for:"password",class:"form-label"},"Mật khẩu",-1)),t("div",X,[e[10]||(e[10]=t("span",{class:"input-group-text"},[t("i",{class:"fas fa-lock"})],-1)),k(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>b.value=s),type:v.value?"text":"password",class:"form-control",id:"password",required:"",autocomplete:"current-password",placeholder:"Nhập mật khẩu"},null,8,Y),[[R,b.value]]),t("button",{type:"button",class:"btn btn-outline-secondary",onClick:e[2]||(e[2]=s=>v.value=!v.value)},[t("i",{class:h(v.value?"fas fa-eye-slash":"fas fa-eye")},null,2)])])]),t("div",Z,[k(t("input",{type:"checkbox",class:"form-check-input",id:"rememberMe","onUpdate:modelValue":e[3]||(e[3]=s=>x.value=s)},null,512),[[q,x.value]]),e[12]||(e[12]=t("label",{class:"form-check-label",for:"rememberMe"}," Ghi nhớ đăng nhập ",-1))]),t("button",{type:"submit",class:"btn btn-primary w-100 fw-bold",disabled:a.value},[a.value?d("",!0):(c(),u("i",te)),a.value?(c(),u("span",ae)):d("",!0),g(" "+y(a.value?"Đang đăng nhập...":"Đăng nhập"),1)],8,ee)],34),e[17]||(e[17]=t("div",{class:"text-center my-3"},[t("div",{class:"position-relative"},[t("hr"),t("span",{class:"position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted"},"hoặc")])],-1)),t("div",se,[f(D,{loading:a.value,onGoogleLogin:F},null,8,["loading"])]),t("div",le,[f(U,{loading:a.value,onFacebookLogin:O},null,8,["loading"])]),t("div",{class:h(["text-center mt-3",{"d-none":a.value}])},[e[14]||(e[14]=t("span",null,"Bạn chưa có tài khoản?",-1)),f(i,{to:"/register",class:"ms-1 text-primary"},{default:_(()=>e[13]||(e[13]=[g("Đăng ký")])),_:1,__:[13]})],2),t("div",{class:h(["text-center mt-2",{"d-none":a.value}])},[f(i,{to:"/forgot-password",class:"text-muted text-decoration-none"},{default:_(()=>e[15]||(e[15]=[t("i",{class:"fas fa-question-circle me-1"},null,-1),g("Quên mật khẩu? ")])),_:1,__:[15]})],2)])])])}}},ue=L(oe,[["__scopeId","data-v-12d45b8d"]]);export{ue as default};
