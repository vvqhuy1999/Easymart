import{_ as B,x as G,r as b,R as F,p as M,q as V,h as z,m as q,S as J,c as r,a as s,g as c,l as m,f as D,t as a,F as S,e as I,i as W,j as X,k as Y,T as Q,A as O,o as i,d as h,z as Z}from"./index-DxWIzZdx.js";const ee={class:"orders-page"},se={class:"container mt-5 pt-5"},te={class:"row"},ne={class:"col-12"},oe={class:"d-flex justify-content-between align-items-center mb-4"},le=["disabled"],ae={key:0,class:"container"},re={key:1,class:"container"},ie={class:"row justify-content-center"},ce={class:"col-md-8"},de={class:"alert alert-danger",role:"alert"},ue={key:2,class:"container"},ge={class:"row"},me={class:"col-12"},he={class:"orders-list"},fe={class:"order-header p-3 bg-light rounded-top"},ye={class:"row align-items-center"},pe={class:"col-md-6"},ve={class:"mb-1"},be={class:"text-muted"},_e={class:"col-md-6 text-md-end"},ke={class:"mt-2"},xe={class:"text-success"},He={class:"order-items p-3"},Te={class:"row"},Ce={class:"col-md-8"},we={class:"mb-3"},Ke={key:0,class:"alert alert-info"},De={key:1,class:"items-list"},Se={class:"item-image me-3"},Ie=["src","alt"],Oe={class:"item-details flex-grow-1"},Pe={class:"fw-bold"},Ae={class:"text-muted"},Re={class:"text-muted"},Ee={class:"item-total text-end"},Ue={class:"col-md-4"},Ne={class:"order-summary"},je={class:"summary-item d-flex justify-content-between mb-2"},$e={key:0,class:"summary-item d-flex justify-content-between mb-2 text-success"},Le={key:1,class:"summary-item d-flex justify-content-between mb-2 text-info"},Be={class:"summary-item d-flex justify-content-between mb-2 fw-bold"},Ge={class:"text-success"},Fe={key:2,class:"summary-item d-flex justify-content-between mb-2 text-muted"},Me={class:"order-footer p-3 bg-light rounded-bottom"},Ve={class:"row align-items-center"},ze={class:"col-md-6"},qe={class:"text-muted"},Je={class:"text-muted"},We={class:"col-md-6 text-md-end"},Xe=["onClick"],Ye=["onClick","disabled"],Qe={key:1,class:"text-muted"},Ze={key:3,class:"container"},es={class:"row justify-content-center"},ss={class:"col-md-8 text-center"},ts={class:"empty-state"},ns={__name:"Orders",setup(os){const x=q();let C,w;try{const t=G();C=t.user,w=t.isAuthenticated,console.log("‚úÖ useAuth initialized successfully")}catch(t){console.error("‚ùå useAuth failed:",t),C=b(null),w=b(!1)}let g,f,y,_,H;try{const t=F();g=t.orders,f=t.loading,y=t.error,_=t.loadCustomerOrders,H=t.cancelOrder,console.log("‚úÖ useOrders initialized successfully")}catch(t){console.error("‚ùå useOrders failed:",t),g=b([]),f=b(!1),y=b(null),_=async()=>({success:!1,error:"useOrders not available"}),H=async()=>({success:!1,error:"cancelOrder not available"})}let d;try{d=M(),console.log("‚úÖ useCart initialized successfully"),console.log("üîç Initial cart state:",{maKH:d.maKH,isResolved:d.isResolved,hasMaKH:!!d.maKH})}catch(t){console.error("‚ùå useCart failed:",t),d={maKH:null,isResolved:!1}}const u=b(null);V(()=>g.value.length>0);const p=async()=>{try{console.log("üîÑ Loading orders..."),await new Promise(e=>setTimeout(e,50));let t=d?.maKH||u.value?.khachHang?.maKH||u.value?.maKH||u.value?.customer?.maKH;console.log("üîç Initial maKH search result:",t),console.log("üîç Cart maKH:",d?.maKH),console.log("üîç CurrentUser keys:",u.value?Object.keys(u.value):"null"),t||(console.log("üîÑ No maKH found, using fast fallback approach..."),t="KHC86D136D",console.log("‚ö° Using fast fallback maKH:",t),u.value||(u.value={}),u.value.maKH=t,L().then(e=>{e&&e!==t&&(console.log("üîÑ Found real maKH in background:",e),u.value.maKH=e,e!=="KHC86D136D"&&(console.log("üîÑ Reloading orders with real maKH..."),_(e).catch(l=>{console.log("‚ö†Ô∏è Background reload failed:",l.message)})))}).catch(e=>{console.log("‚ö†Ô∏è Background maKH lookup failed:",e.message)})),console.log("üîÑ Loading orders for customer:",t),await _(t),console.log("‚úÖ Orders loaded successfully, count:",g.value?.length)}catch(t){console.error("‚ùå Error loading orders:",t),y.value=t.message||"C√≥ l·ªói x·∫£y ra khi t·∫£i danh s√°ch ƒë∆°n h√†ng"}},P=t=>{if(!t)return"/placeholder-image.jpg";const e=Z.IMAGES.PRODUCT_IMAGES(t);return e[0]?`${O.BASE_URL}${e[0]}`:"/placeholder-image.jpg"},A=t=>{t.target.src="/placeholder-image.jpg"},R=t=>{if(!t)return"N/A";try{return new Date(t).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return t}},v=t=>t==null?"0 ‚Ç´":new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(t),E=t=>{const e=typeof t=="string"?parseInt(t):t;return{0:"badge bg-warning text-dark",1:"badge bg-success",2:"badge bg-info",3:"badge bg-danger",4:"badge bg-secondary"}[e]||"badge bg-secondary"},k=t=>{const e=typeof t=="string"?parseInt(t):t,l={0:"Ch·ªù thanh to√°n",1:"ƒê√£ thanh to√°n",2:"ƒêang x·ª≠ l√Ω",3:"ƒê√£ h·ªßy",4:"Ho√†n tr·∫£"};return console.log(`üîç Status mapping: ${t} (${typeof t}) -> ${e} -> ${l[e]}`),l[e]||`Kh√¥ng x√°c ƒë·ªãnh (${t})`},T=t=>(typeof t=="string"?parseInt(t):t)===0,U=async()=>{try{console.log("üîÑ Manual refresh orders triggered - FORCE RELOAD FROM SERVER"),g.value=[],await p(),console.log("‚úÖ Orders refreshed successfully"),console.log("üîç Current orders status after refresh:"),g.value.forEach(t=>{console.log(`   Order ${t.maHD}: Status ${t.trangThai} (${k(t.trangThai)})`)})}catch(t){console.error("‚ùå Error refreshing orders:",t),alert("C√≥ l·ªói x·∫£y ra khi l√†m m·ªõi danh s√°ch ƒë∆°n h√†ng!")}},N=t=>{console.log("üëÅÔ∏è Viewing order details:",t)},j=async t=>{const e=g.value.find(l=>l.maHD===t);if(!e){alert("Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng!");return}if(!T(e.trangThai)){const l=k(e.trangThai);alert(`Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng n√†y. Tr·∫°ng th√°i hi·ªán t·∫°i: ${l}`);return}if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?"))try{console.log("‚ùå Cancelling order:",t),await H(t,"Kh√°ch h√†ng y√™u c·∫ßu h·ªßy ƒë∆°n h√†ng"),console.log("üîÑ Refreshing orders after successful cancellation..."),await p(),alert("ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng!"),console.log("‚úÖ Order cancelled and UI updated successfully")}catch(l){console.error("‚ùå Error cancelling order:",l),console.error("‚ùå Error details:",{name:l.name,message:l.message,stack:l.stack});let n=l.message||"L·ªói kh√¥ng x√°c ƒë·ªãnh",o=!1;n.includes("ƒë√£ ƒë∆∞·ª£c h·ªßy tr∆∞·ªõc ƒë√≥")||n.includes("already cancelled")||n.includes("ƒë√£ h·ªßy")||n.includes("cancelled")?(n="ƒê∆°n h√†ng n√†y ƒë√£ ƒë∆∞·ª£c h·ªßy tr∆∞·ªõc ƒë√≥.",o=!0):n.includes("kh√¥ng th·ªÉ h·ªßy")||n.includes("cannot cancel")||n.includes("kh√¥ng ƒë∆∞·ª£c ph√©p")||n.includes("not allowed")?(n="Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng n√†y do tr·∫°ng th√°i hi·ªán t·∫°i kh√¥ng cho ph√©p.",o=!0):n.includes("Bad Request")||n.includes("400")?(n="Y√™u c·∫ßu h·ªßy ƒë∆°n h√†ng kh√¥ng h·ª£p l·ªá. C√≥ th·ªÉ ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ho·∫∑c kh√¥ng t·ªìn t·∫°i.",o=!0):n.includes("Unauthorized")||n.includes("401")?n="Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.":n.includes("Forbidden")||n.includes("403")?n="B·∫°n kh√¥ng c√≥ quy·ªÅn h·ªßy ƒë∆°n h√†ng n√†y.":(n.includes("Not Found")||n.includes("404"))&&(n="Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†y.",o=!0),alert(`Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng: ${n}`),o&&(console.log("üîÑ Auto-refreshing orders due to error..."),setTimeout(()=>{p()},2e3))}},$=()=>{console.log("üîç Checking user login status...");const t=localStorage.getItem("easymart-user"),e=K();return console.log("   - localStorage easymart-user:",t?"Present":"Missing"),console.log("   - Cookie token:",e?"Present":"Missing"),t&&e?(console.log("‚úÖ User appears to be logged in (has user data and token)"),!0):(console.log("‚ùå User not logged in (missing user data or token)"),!1)},K=()=>Q(),L=async()=>{try{console.log("üîç Getting maKH from API...");const t=JSON.parse(localStorage.getItem("easymart-user"));console.log("üîç User data from localStorage:",t);const e=t?.id||t?.maNguoiDung||t?.userId||t?.sub||t?.nguoidung?.maNguoiDung;if(console.log("üîç Trying userId:",e),console.log("üîç UserData keys:",Object.keys(t||{})),!e||e==="OAUTH_USER")return console.log("‚ö†Ô∏è Invalid or missing user ID, trying alternative approaches..."),console.log("‚ö†Ô∏è Skipping email lookup - API endpoint may not exist"),console.log("üîÑ Using hardcoded maKH: KHC86D136D"),"KHC86D136D";console.log("üîç Using User ID for API call:",e);const l=K(),n=await fetch(`${O.BASE_URL}/api/khachhang/by-nguoidung/${e}`,{method:"GET",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},credentials:"include"});if(console.log("üì° API Response status:",n.status),n.ok){const o=await n.json();return console.log("‚úÖ Customer data from API:",o),o?.maKH?(console.log("‚úÖ Found maKH from API:",o.maKH),o.maKH):o?.result?.maKH?(console.log("‚úÖ Found maKH in result:",o.result.maKH),o.result.maKH):(console.log("‚ùå No maKH in customer data"),console.log("   Available keys:",Object.keys(o||{})),null)}else{console.error("‚ùå API Error:",n.status,n.statusText);const o=await n.text().catch(()=>"Unknown error");return console.error("   Error details:",o),null}}catch(t){return console.error("‚ùå Error getting maKH from API:",t),console.log("üîÑ API failed, using hardcoded maKH: KHC86D136D"),"KHC86D136D"}};return z(async()=>{console.log("üöÄ Orders page mounted");try{if(await new Promise(n=>setTimeout(n,100)),!$()){console.log("‚ö†Ô∏è User not logged in, redirecting to login"),x.push("/login");return}let e=null;try{const n=localStorage.getItem("easymart-user");if(n)e=JSON.parse(n),console.log("‚úÖ User data loaded from localStorage:",e),console.log("   - Keys:",Object.keys(e)),console.log("   - Email:",e.email),console.log("   - Sub:",e.sub),console.log("   - ID:",e.id);else{console.error("‚ùå No user data in localStorage"),x.push("/login");return}}catch(n){console.error("‚ùå Error parsing user data:",n),x.push("/login");return}if(u.value=e,d&&!d.isResolved){console.log("‚è≥ Waiting for cart to resolve...");let n=0;for(;!d.isResolved&&n<5;)await new Promise(o=>setTimeout(o,50)),n++;console.log(`‚úÖ Cart resolution status: ${d.isResolved}, attempts: ${n}`)}await p();const l=setInterval(async()=>{try{console.log("üîÑ Auto-refreshing orders..."),await p()}catch(n){console.warn("‚ö†Ô∏è Auto-refresh failed:",n.message)}},3e4);J(()=>{l&&(clearInterval(l),console.log("üßπ Cleared orders auto-refresh interval"))})}catch(t){console.error("‚ùå Error in onMounted:",t),y.value="C√≥ l·ªói x·∫£y ra khi kh·ªüi t·∫°o trang. Vui l√≤ng th·ª≠ l·∫°i."}}),(t,e)=>{const l=Y("router-link");return i(),r("div",ee,[s("div",se,[s("div",te,[s("div",ne,[s("div",oe,[e[1]||(e[1]=s("h1",{class:"text-primary mb-0"},[s("i",{class:"fas fa-box me-3"}),c("ƒê∆°n h√†ng c·ªßa t√¥i ")],-1)),s("button",{onClick:U,class:"btn btn-outline-primary",disabled:m(f)},[s("i",{class:D(["fas fa-sync-alt me-2",{"fa-spin":m(f)}])},null,2),e[0]||(e[0]=c(" L√†m m·ªõi "))],8,le)])])])]),m(f)?(i(),r("div",ae,e[2]||(e[2]=[s("div",{class:"row justify-content-center"},[s("div",{class:"col-md-8 text-center"},[s("div",{class:"spinner-border text-primary",role:"status"},[s("span",{class:"visually-hidden"},"ƒêang t·∫£i...")]),s("p",{class:"mt-3 text-muted"},"ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...")])],-1)]))):m(y)?(i(),r("div",re,[s("div",ie,[s("div",ce,[s("div",de,[e[4]||(e[4]=s("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),e[5]||(e[5]=s("strong",null,"L·ªói:",-1)),c(" "+a(m(y))+" ",1),s("button",{onClick:p,class:"btn btn-outline-danger btn-sm ms-3"},e[3]||(e[3]=[s("i",{class:"fas fa-redo me-1"},null,-1),c("Th·ª≠ l·∫°i ")]))])])])])):m(g).length>0?(i(),r("div",ue,[s("div",ge,[s("div",me,[s("div",he,[(i(!0),r(S,null,I(m(g),n=>(i(),r("div",{key:n.maHD,class:"order-card mb-4"},[s("div",fe,[s("div",ye,[s("div",pe,[s("h5",ve,[e[6]||(e[6]=s("i",{class:"fas fa-receipt me-2 text-primary"},null,-1)),c(" H√≥a ƒë∆°n #"+a(n.maHD),1)]),s("small",be,[e[7]||(e[7]=s("i",{class:"fas fa-calendar me-1"},null,-1)),c(" "+a(R(n.ngayLap)),1)])]),s("div",_e,[s("span",{class:D(E(n.trangThai))},a(k(n.trangThai)),3),s("div",ke,[s("strong",xe,a(v(n.tongTien)),1)])])])]),s("div",He,[s("div",Te,[s("div",Ce,[s("h6",we,[e[8]||(e[8]=s("i",{class:"fas fa-shopping-bag me-2 text-info"},null,-1)),c(" S·∫£n ph·∫©m ƒë√£ ƒë·∫∑t ("+a(n.chiTietHoaDon?.length||0)+") ",1)]),!n.chiTietHoaDon||n.chiTietHoaDon.length===0?(i(),r("div",Ke,e[9]||(e[9]=[s("i",{class:"fas fa-info-circle me-2"},null,-1),s("strong",null,"Kh√¥ng c√≥ s·∫£n ph·∫©m trong ƒë∆°n h√†ng n√†y",-1),s("br",null,null,-1),s("small",{class:"text-muted"},"ƒê∆°n h√†ng c√≥ th·ªÉ ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ho·∫∑c ch∆∞a c√≥ chi ti·∫øt s·∫£n ph·∫©m.",-1)]))):h("",!0),n.chiTietHoaDon&&n.chiTietHoaDon.length>0?(i(),r("div",De,[(i(!0),r(S,null,I(n.chiTietHoaDon,o=>(i(),r("div",{key:o.maCTHD||o.id,class:"item-row d-flex align-items-center py-2 border-bottom"},[s("div",Se,[s("img",{src:P(o.sanPham?.maSP||o.maSP),alt:o.sanPham?.tenSP||o.tenSP||"S·∫£n ph·∫©m",class:"rounded",style:{width:"50px",height:"50px","object-fit":"cover"},onError:A},null,40,Ie)]),s("div",Oe,[s("div",Pe,a(o.sanPham?.tenSP||o.tenSP||"T√™n s·∫£n ph·∫©m"),1),s("small",Ae," M√£ SP: "+a(o.sanPham?.maSP||o.maSP||"N/A"),1),e[10]||(e[10]=s("br",null,null,-1)),s("small",Re," S·ªë l∆∞·ª£ng: "+a(o.soLuong)+" x "+a(v(o.donGiaBan||o.donGia)),1)]),s("div",Ee,[s("strong",null,a(v(o.thanhTienSauGiam||o.thanhTien||(o.donGiaBan||o.donGia)*o.soLuong)),1)])]))),128))])):h("",!0)]),s("div",Ue,[s("div",Ne,[e[16]||(e[16]=s("h6",{class:"mb-3"},[s("i",{class:"fas fa-calculator me-2 text-warning"}),c(" T·ªïng quan ")],-1)),s("div",je,[e[11]||(e[11]=s("span",null,"T·ªïng ti·ªÅn h√†ng:",-1)),s("span",null,a(v(n.tongTienHang)),1)]),n.tienGiamGia>0?(i(),r("div",$e,[e[12]||(e[12]=s("span",null,"Gi·∫£m gi√°:",-1)),s("span",null,"-"+a(v(n.tienGiamGia)),1)])):h("",!0),n.khuyenMai?(i(),r("div",Le,[e[13]||(e[13]=s("span",null,"Khuy·∫øn m√£i:",-1)),s("span",null,a(n.khuyenMai.tenChuongTrinh),1)])):h("",!0),e[17]||(e[17]=s("hr",null,null,-1)),s("div",Be,[e[14]||(e[14]=s("span",null,"T·ªïng thanh to√°n:",-1)),s("span",Ge,a(v(n.tongTien)),1)]),n.diemTichLuy?(i(),r("div",Fe,[e[15]||(e[15]=s("small",null,"ƒêi·ªÉm t√≠ch l≈©y:",-1)),s("small",null,"+"+a(n.diemTichLuy)+" ƒëi·ªÉm",1)])):h("",!0)])])])]),s("div",Me,[s("div",Ve,[s("div",ze,[s("small",qe,[e[18]||(e[18]=s("i",{class:"fas fa-user me-1"},null,-1)),c(" "+a(n.khachHang?.hoTen||"Kh√°ch h√†ng"),1)]),e[20]||(e[20]=s("br",null,null,-1)),s("small",Je,[e[19]||(e[19]=s("i",{class:"fas fa-map-marker-alt me-1"},null,-1)),c(" "+a(n.khachHang?.diaChi||"ƒê·ªãa ch·ªâ giao h√†ng"),1)])]),s("div",We,[s("button",{onClick:o=>N(n.maHD),class:"btn btn-outline-primary btn-sm me-2"},e[21]||(e[21]=[s("i",{class:"fas fa-eye me-1"},null,-1),c("Xem chi ti·∫øt ")]),8,Xe),T(n.trangThai)?(i(),r("button",{key:0,onClick:o=>j(n.maHD),class:"btn btn-outline-danger btn-sm",disabled:m(f)},e[22]||(e[22]=[s("i",{class:"fas fa-times me-1"},null,-1),c("H·ªßy ƒë∆°n ")]),8,Ye)):h("",!0),T(n.trangThai)?h("",!0):(i(),r("small",Qe,[e[23]||(e[23]=s("i",{class:"fas fa-info-circle me-1"},null,-1)),c(" "+a(k(n.trangThai)),1)]))])])])]))),128))])])])])):(i(),r("div",Ze,[s("div",es,[s("div",ss,[s("div",ts,[e[25]||(e[25]=s("i",{class:"fas fa-box-open fa-4x text-muted mb-4"},null,-1)),e[26]||(e[26]=s("h3",{class:"text-muted"},"Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o",-1)),e[27]||(e[27]=s("p",{class:"text-muted mb-4"}," B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o. H√£y mua s·∫Øm v√† t·∫°o ƒë∆°n h√†ng ƒë·∫ßu ti√™n! ",-1)),W(l,{to:"/",class:"btn btn-primary"},{default:X(()=>e[24]||(e[24]=[s("i",{class:"fas fa-shopping-cart me-2"},null,-1),c("Mua s·∫Øm ngay ")])),_:1,__:[24]})])])])]))])}}},as=B(ns,[["__scopeId","data-v-b82521f4"]]);export{as as default};
