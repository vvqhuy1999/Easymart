import{_ as Q,s as W,p as Y,r as v,h as m,G as ss,i as es,c as f,a as e,y as M,t as h,f as S,g as p,v as g,R as F,d as y,w as H,x as $,b as as,N as E,B as K,o as b}from"./index-pi3KkAaC.js";const ts={class:"profile-page"},os={class:"container py-5"},ls={class:"row"},ns={class:"col-lg-3 mb-4"},is={class:"card shadow-sm border-0"},rs={class:"card-body text-center"},ds={class:"position-relative d-inline-block mb-3"},us=["src","alt"],cs={class:"mb-1"},vs={class:"text-muted mb-0"},hs={class:"text-muted"},ms={class:"card shadow-sm border-0 mt-3"},ps={class:"card-body"},fs={class:"row text-center"},gs={class:"col-6"},bs={class:"border-end"},ys={class:"text-primary mb-0"},ws={class:"col-6"},ks={class:"text-success mb-0"},Ps={class:"mt-2 text-center"},xs={class:"badge bg-info"},_s={class:"col-lg-9"},Ts={class:"card shadow-sm border-0"},Ds={class:"card-header bg-white border-bottom"},Ns={class:"nav nav-tabs card-header-tabs",role:"tablist"},Cs={class:"nav-item"},As={class:"nav-item"},Ss={class:"card-body"},$s={class:"tab-content"},Us={key:0,class:"alert alert-warning mb-3"},Is={key:1,class:"alert alert-success alert-dismissible fade show",role:"alert"},Es={key:2,class:"alert alert-danger alert-dismissible fade show",role:"alert"},Ks={class:"card mb-4"},Rs={class:"card-body"},Ms={class:"row"},Fs={class:"col-md-6 mb-3"},Hs={class:"input-group"},Vs={class:"col-md-6 mb-3"},Bs={class:"input-group"},js={class:"col-md-6 mb-3"},Os={class:"input-group"},qs={class:"col-md-6 mb-3"},zs={class:"input-group"},Ls={class:"card mb-4"},Gs={class:"card-body"},Js={class:"row"},Zs={class:"col-12 mb-3"},Xs={class:"input-group"},Qs={class:"d-flex gap-2"},Ws=["disabled"],Ys={key:0,class:"fas fa-save me-2"},se={key:1,class:"spinner-border spinner-border-sm me-2",role:"status"},ee={class:"tab-content"},ae={key:0,class:"alert alert-success alert-dismissible fade show",role:"alert",style:{"background-color":"#d4edda !important","border-color":"#c3e6cb !important",color:"#155724 !important"}},te={key:1,class:"alert alert-danger alert-dismissible fade show",role:"alert",style:{"background-color":"#f8d7da !important","border-color":"#f5c6cb !important",color:"#721c24 !important"}},oe={class:"row"},le={class:"col-md-6"},ne={class:"mb-3"},ie={class:"input-group"},re=["type"],de={class:"mb-3"},ue={class:"input-group"},ce=["type"],ve={class:"mb-3"},he={class:"input-group"},me=["type"],pe={class:"d-flex gap-2"},fe=["disabled"],ge={key:0,class:"fas fa-key me-2"},be={key:1,class:"spinner-border spinner-border-sm me-2",role:"status"},ye={__name:"Profile",setup(we){const U=Y(),{user:i,isLoggedIn:V,validateProfileAccess:D}=W(),I=()=>document.cookie.split("; ").find(a=>a.startsWith("easymart-token="))?.split("=")[1];V.value||U.push("/login");const w=v("shipping"),t=v({name:"",email:"",phone:"",birthDate:"",address:""}),r=v({currentPassword:"",newPassword:"",confirmPassword:""}),k=v(!1),P=v(!1),x=v(""),_=v(""),T=v(""),c=v(""),N=v(!1),C=v(!1),A=v(!1),l=m(()=>i.value?.customerInfo||{}),B=m(()=>l.value.hoTen||l.value.tenNguoiDung||i.value?.name||"User"),j=m(()=>i.value?.email||"No email"),O=m(()=>l.value.ngayTao||l.value.ngayDangKy||i.value?.joinDate);m(()=>l.value.tongDonHang||i.value?.totalOrders||0),m(()=>l.value.tongChiTieu||i.value?.totalSpent||0);const q=m(()=>t.value.name||t.value.phone||t.value.birthDate||t.value.address),z=m(()=>l.value.hoTen||l.value.sdt||l.value.ngaySinh||l.value.diaChi);m(()=>!l.value.sdt||!l.value.ngaySinh||!l.value.diaChi||!t.value.address||!t.value.phone);const L=m(()=>{let a=0;return l.value.hoTen&&a++,l.value.sdt&&a++,l.value.ngaySinh&&a++,l.value.diaChi&&a++,t.value.address&&a++,t.value.phone&&a++,a});m(()=>Math.round(L.value/5*100));const G=a=>{if(!a)return"Chưa có thông tin";try{let s;if(typeof a=="string")s=new Date(a);else if(a instanceof Date)s=a;else return"Chưa có thông tin";return isNaN(s.getTime())?"Chưa có thông tin":s.toLocaleDateString("vi-VN")}catch(s){return console.error("Date formatting error:",s),"Chưa có thông tin"}},J=async()=>{_.value="",x.value="",k.value=!0;try{console.log("📝 Profile form data before update:",t.value);const a=l.value?.maKH;if(!a)throw new Error("Không tìm thấy mã khách hàng!");const s={hoTen:t.value.name,sdt:t.value.phone,ngaySinh:t.value.birthDate,diaChi:t.value.address,taiKhoan:i.value?.email};console.log("📤 Update data prepared:",s),console.log("📱 Phone number being sent:",t.value.phone),console.log("🏷️ Name being sent:",t.value.name),console.log("📍 Address being sent:",t.value.address),console.log("📅 Birth date being sent:",t.value.birthDate),console.log("🔑 maKH being used:",a);const o=I();if(!o)throw new Error("Không có token xác thực!");const u=`${K.BASE_URL}/api/khachhang/${a}/update-info`;console.log("🔗 Update endpoint:",u);const n=await fetch(u,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(s)});if(!n.ok){const R=await n.json().catch(()=>({}));throw new Error(`HTTP error! status: ${n.status}, message: ${R.message||"Unknown error"}`)}const d=await n.json();console.log("📥 Update response:",d),d?.success||d?.result?.success||d?.message?.includes("thành công")?(console.log("✅ Update successful, refreshing user data..."),x.value=d.message||"Thông tin giao hàng đã được cập nhật thành công!",i.value&&i.value.customerInfo&&(i.value.customerInfo.hoTen=t.value.name,i.value.customerInfo.sdt=t.value.phone,i.value.customerInfo.ngaySinh=t.value.birthDate,i.value.customerInfo.diaChi=t.value.address),setTimeout(()=>{x.value=""},3e3),console.log("✅ Profile updated successfully")):(console.log("⚠️ Update response format unexpected:",d),_.value=d.message||d.error||"Có lỗi xảy ra khi cập nhật thông tin giao hàng!")}catch(a){console.error("❌ Profile update error:",a),_.value="Có lỗi xảy ra khi cập nhật thông tin giao hàng: "+a.message}finally{k.value=!1}},Z=async()=>{if(c.value="",T.value="",r.value.newPassword!==r.value.confirmPassword){c.value="Mật khẩu mới không khớp!";return}if(r.value.newPassword.length<6){c.value="Mật khẩu mới phải có ít nhất 6 ký tự!";return}if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*?&]{6,}$/.test(r.value.newPassword)){c.value="Mật khẩu phải chứa cả chữ và số!";return}if(r.value.newPassword===r.value.currentPassword){c.value="Mật khẩu mới không được giống mật khẩu hiện tại!";return}P.value=!0;try{const s=I();if(!s){c.value="Không có token xác thực!";return}const o=await fetch(`${K.BASE_URL}/api/nguoidung/change-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({oldPassword:r.value.currentPassword,newPassword:r.value.newPassword,confirmPassword:r.value.confirmPassword})}),u=await o.json();o.ok?u.success||u.message?.includes("thành công")||u.message?.includes("success")?(T.value="Mật khẩu đã được thay đổi thành công!",r.value.currentPassword="",r.value.newPassword="",r.value.confirmPassword="",N.value=!1,C.value=!1,A.value=!1,setTimeout(()=>{T.value=""},3e3)):c.value=u.message||u.error||"Có lỗi xảy ra khi thay đổi mật khẩu!":c.value=u.message||u.error||`HTTP Error: ${o.status} ${o.statusText}`}catch(s){console.error("Change password error:",s),c.value="Có lỗi xảy ra khi thay đổi mật khẩu!"}finally{P.value=!1}};ss(l,a=>{if(a&&Object.keys(a).length>0){console.log("👀 customerInfo changed:",a);const s={name:a.hoTen||a.tenNguoiDung||"",email:i.value?.email||"",phone:a.sdt||a.soDienThoai||a.phone||"",birthDate:a.ngaySinh||"",address:a.diaChi||a.address||""};console.log("🔄 Mapped data from customerInfo:",s),t.value={...t.value,...s},console.log("🔄 Form auto-updated from customerInfo:",t.value)}},{immediate:!0,deep:!0});const X=async()=>{try{console.log("📡 Fetching profile info from new API...");const a=l.value?.maKH||i.value?.customerInfo?.maKH;if(!a)return console.log("⚠️ No maKH found, falling back to validateProfileAccess"),await D();const s=I();if(!s)throw new Error("Không có token xác thực!");const o=`${K.BASE_URL}/api/khachhang/${a}/info`;console.log("🔗 Fetching from endpoint:",o);const u=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});if(!u.ok){const R=await u.json().catch(()=>({}));return console.log("⚠️ New API failed, falling back to validateProfileAccess"),await D()}const n=await u.json();console.log("📥 New API response:",n),console.log("📥 New API response type:",typeof n),console.log("📥 New API response keys:",Object.keys(n||{}));let d=null;if(n?.data)d=n.data,console.log("✅ Found data in infoResult.data");else if(n?.result)d=n.result,console.log("✅ Found data in infoResult.result");else if(n?.hoTen||n?.sdt||n?.diaChi)d=n,console.log("✅ Found data directly in infoResult");else if(Array.isArray(n))d=n[0],console.log("✅ Found data in infoResult[0] (array response)");else return console.log("⚠️ New API response format analysis:"),console.log("  - infoResult:",n),console.log("  - infoResult.constructor:",n?.constructor?.name),console.log("  - infoResult.toString():",n?.toString()),console.log("⚠️ New API response format unexpected, falling back to validateProfileAccess"),await D();return d?(console.log("🔄 New customer data received:",d),console.log("🔄 New customer data keys:",Object.keys(d||{})),i.value?.customerInfo&&(i.value.customerInfo={...i.value.customerInfo,...d},console.log("✅ Customer info updated in user state")),{success:!0,data:d}):(console.log("⚠️ Could not extract data from new API response, falling back to validateProfileAccess"),await D())}catch(a){return console.error("❌ Error fetching profile info:",a),console.log("🔄 Falling back to validateProfileAccess due to error"),await D()}};return es(async()=>{try{console.log("🚀 Profile page mounted, starting validation...");const a=await X();if(a.success)if(console.log("✅ Profile fetched successfully"),console.log("👤 Current customerInfo:",l.value),l.value&&Object.keys(l.value).length>0){const s={name:l.value.hoTen||l.value.tenNguoiDung||"",email:i.value?.email||"",phone:l.value.sdt||l.value.soDienThoai||l.value.phone||"",birthDate:l.value.ngaySinh||"",address:l.value.diaChi||l.value.address||""};t.value={...t.value,...s},console.log("📝 Form populated with customer data:",t.value),console.log("🏷️ Name field value:",t.value.name),console.log("📱 Phone field value:",t.value.phone),console.log("📍 Address field value:",t.value.address),console.log("📅 Birth date field value:",t.value.birthDate)}else console.log("⚠️ customerInfo is empty or undefined");else console.error("❌ Profile fetch failed:",a.error),U.push("/login")}catch(a){console.error("❌ Profile initialization error:",a),U.push("/login")}}),(a,s)=>(b(),f("div",ts,[e("div",os,[e("div",ls,[e("div",ns,[e("div",is,[e("div",rs,[e("div",ds,[e("img",{src:M(i)?.avatar||"https://via.placeholder.com/80",class:"rounded-circle",width:"80",height:"80",alt:M(i)?.name||"User"},null,8,us),s[17]||(s[17]=e("button",{class:"btn btn-sm btn-primary rounded-circle position-absolute bottom-0 end-0",style:{width:"24px",height:"24px",padding:"0"}},[e("i",{class:"fas fa-camera",style:{"font-size":"0.7rem"}})],-1))]),e("h5",cs,h(B.value),1),e("p",vs,h(j.value),1),e("small",hs,"Tham gia từ "+h(G(O.value)),1)])]),e("div",ms,[e("div",ps,[s[20]||(s[20]=e("h6",{class:"card-title"},"Thông tin khách hàng",-1)),e("div",fs,[e("div",gs,[e("div",bs,[e("h6",ys,h(l.value?.maKH||"N/A"),1),s[18]||(s[18]=e("small",{class:"text-muted"},"Mã KH",-1))])]),e("div",ws,[e("h6",ks,h(l.value?.diemTichLuy||0),1),s[19]||(s[19]=e("small",{class:"text-muted"},"Điểm tích lũy",-1))])]),e("div",Ps,[e("span",xs,h(l.value?.loaiKhachHang||"Thường"),1)])])])]),e("div",_s,[e("div",Ts,[e("div",Ds,[e("ul",Ns,[e("li",Cs,[e("button",{class:S(["nav-link",{active:w.value==="shipping"}]),onClick:s[0]||(s[0]=o=>w.value="shipping")},s[21]||(s[21]=[e("i",{class:"fas fa-shipping-fast me-2"},null,-1),p("Thông tin giao hàng ")]),2)]),e("li",As,[e("button",{class:S(["nav-link",{active:w.value==="password"}]),onClick:s[1]||(s[1]=o=>w.value="password")},s[22]||(s[22]=[e("i",{class:"fas fa-lock me-2"},null,-1),p("Đổi mật khẩu ")]),2)])])]),e("div",Ss,[g(e("div",$s,[s[41]||(s[41]=e("h5",{class:"mb-4"},"Thông tin giao hàng",-1)),!z.value&&!q.value?(b(),f("div",Us,s[23]||(s[23]=[e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1),e("strong",null,"Chưa có thông tin giao hàng",-1),e("br",null,null,-1),p(" Vui lòng nhập thông tin giao hàng của bạn. ")]))):y("",!0),x.value?(b(),f("div",Is,[s[24]||(s[24]=e("i",{class:"fas fa-check-circle me-2"},null,-1)),p(h(x.value)+" ",1),e("button",{type:"button",class:"btn-close",onClick:s[2]||(s[2]=o=>x.value="")})])):y("",!0),_.value?(b(),f("div",Es,[s[25]||(s[25]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),p(h(_.value)+" ",1),e("button",{type:"button",class:"btn-close",onClick:s[3]||(s[3]=o=>_.value="")})])):y("",!0),e("form",{onSubmit:H(J,["prevent"])},[e("div",Ks,[s[36]||(s[36]=e("div",{class:"card-header bg-light"},[e("h6",{class:"mb-0"},[e("i",{class:"fas fa-user me-2 text-primary"}),p(" Thông tin cá nhân ")])],-1)),e("div",Rs,[e("div",Ms,[e("div",Fs,[s[27]||(s[27]=e("label",{for:"name",class:"form-label"},"Họ và tên *",-1)),e("div",Hs,[s[26]||(s[26]=e("span",{class:"input-group-text"},[e("i",{class:"fas fa-user"})],-1)),g(e("input",{"onUpdate:modelValue":s[4]||(s[4]=o=>t.value.name=o),type:"text",class:"form-control",id:"name",required:"",placeholder:"Nhập họ và tên"},null,512),[[$,t.value.name]])])]),e("div",Vs,[s[29]||(s[29]=e("label",{for:"email",class:"form-label"},"Email *",-1)),e("div",Bs,[s[28]||(s[28]=e("span",{class:"input-group-text"},[e("i",{class:"fas fa-envelope"})],-1)),g(e("input",{"onUpdate:modelValue":s[5]||(s[5]=o=>t.value.email=o),type:"email",class:"form-control",id:"email",required:"",placeholder:"Nhập email",disabled:""},null,512),[[$,t.value.email]])]),s[30]||(s[30]=e("small",{class:"text-muted"},"Email không thể thay đổi",-1))]),e("div",js,[s[32]||(s[32]=e("label",{for:"phone",class:"form-label"},"Số điện thoại *",-1)),e("div",Os,[s[31]||(s[31]=e("span",{class:"input-group-text"},[e("i",{class:"fas fa-phone"})],-1)),g(e("input",{"onUpdate:modelValue":s[6]||(s[6]=o=>t.value.phone=o),type:"tel",class:"form-control",id:"phone",required:"",placeholder:"Nhập số điện thoại"},null,512),[[$,t.value.phone]])]),s[33]||(s[33]=e("small",{class:"text-muted"},"Số điện thoại để liên lạc khi giao hàng",-1))]),e("div",qs,[s[35]||(s[35]=e("label",{for:"birthDate",class:"form-label"},"Ngày sinh",-1)),e("div",zs,[s[34]||(s[34]=e("span",{class:"input-group-text"},[e("i",{class:"fas fa-calendar"})],-1)),g(e("input",{"onUpdate:modelValue":s[7]||(s[7]=o=>t.value.birthDate=o),type:"date",class:"form-control",id:"birthDate"},null,512),[[$,t.value.birthDate]])])])])])]),e("div",Ls,[s[40]||(s[40]=e("div",{class:"card-header bg-light"},[e("h6",{class:"mb-0"},[e("i",{class:"fas fa-map-marker-alt me-2 text-success"}),p(" Địa chỉ giao hàng ")])],-1)),e("div",Gs,[e("div",Js,[e("div",Zs,[s[38]||(s[38]=e("label",{for:"address",class:"form-label"},"Địa chỉ chi tiết *",-1)),e("div",Xs,[s[37]||(s[37]=e("span",{class:"input-group-text"},[e("i",{class:"fas fa-map-marker-alt"})],-1)),g(e("textarea",{"onUpdate:modelValue":s[8]||(s[8]=o=>t.value.address=o),class:"form-control",id:"address",rows:"3",required:"",placeholder:"Nhập địa chỉ chi tiết (số nhà, tên đường, phường/xã, quận/huyện, tỉnh/thành phố)"},null,512),[[$,t.value.address]])]),s[39]||(s[39]=e("small",{class:"text-muted"},"Ví dụ: 123 Đường ABC, Phường XYZ, Quận 1, TP. Hồ Chí Minh",-1))])])])]),e("div",Qs,[e("button",{type:"submit",class:"btn btn-primary",disabled:k.value},[k.value?y("",!0):(b(),f("i",Ys)),k.value?(b(),f("span",se)):y("",!0),p(" "+h(k.value?"Đang cập nhật...":"Cập nhật thông tin giao hàng"),1)],8,Ws)])],32)],512),[[F,w.value==="shipping"]]),g(e("div",ee,[s[52]||(s[52]=e("h5",{class:"mb-4"},"Đổi mật khẩu",-1)),T.value?(b(),f("div",ae,[s[42]||(s[42]=e("i",{class:"fas fa-check-circle me-2"},null,-1)),p(h(T.value)+" ",1),e("button",{type:"button",class:"btn-close",onClick:s[9]||(s[9]=o=>T.value="")})])):y("",!0),c.value?(b(),f("div",te,[s[43]||(s[43]=e("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),p(h(c.value)+" ",1),e("button",{type:"button",class:"btn-close",onClick:s[10]||(s[10]=o=>c.value="")})])):y("",!0),e("form",{onSubmit:H(Z,["prevent"])},[e("div",oe,[e("div",le,[e("div",ne,[s[45]||(s[45]=e("label",{for:"currentPassword",class:"form-label"},"Mật khẩu hiện tại *",-1)),e("div",ie,[s[44]||(s[44]=e("span",{class:"input-group-text"},[e("i",{class:"fas fa-lock"})],-1)),g(e("input",{"onUpdate:modelValue":s[11]||(s[11]=o=>r.value.currentPassword=o),type:N.value?"text":"password",class:"form-control",id:"currentPassword",required:"",placeholder:"Nhập mật khẩu hiện tại"},null,8,re),[[E,r.value.currentPassword]]),e("button",{type:"button",class:"btn btn-outline-secondary",onClick:s[12]||(s[12]=o=>N.value=!N.value)},[e("i",{class:S(N.value?"fas fa-eye-slash":"fas fa-eye")},null,2)])])]),e("div",de,[s[47]||(s[47]=e("label",{for:"newPassword",class:"form-label"},"Mật khẩu mới *",-1)),e("div",ue,[s[46]||(s[46]=e("span",{class:"input-group-text"},[e("i",{class:"fas fa-lock"})],-1)),g(e("input",{"onUpdate:modelValue":s[13]||(s[13]=o=>r.value.newPassword=o),type:C.value?"text":"password",class:"form-control",id:"newPassword",required:"",placeholder:"Nhập mật khẩu mới",minlength:"6"},null,8,ce),[[E,r.value.newPassword]]),e("button",{type:"button",class:"btn btn-outline-secondary",onClick:s[14]||(s[14]=o=>C.value=!C.value)},[e("i",{class:S(C.value?"fas fa-eye-slash":"fas fa-eye")},null,2)])]),s[48]||(s[48]=e("div",{class:"form-text"},"Mật khẩu phải có ít nhất 6 ký tự",-1))]),e("div",ve,[s[50]||(s[50]=e("label",{for:"confirmPassword",class:"form-label"},"Xác nhận mật khẩu mới *",-1)),e("div",he,[s[49]||(s[49]=e("span",{class:"input-group-text"},[e("i",{class:"fas fa-lock"})],-1)),g(e("input",{"onUpdate:modelValue":s[15]||(s[15]=o=>r.value.confirmPassword=o),type:A.value?"text":"password",class:"form-control",id:"confirmPassword",required:"",placeholder:"Nhập lại mật khẩu mới"},null,8,me),[[E,r.value.confirmPassword]]),e("button",{type:"button",class:"btn btn-outline-secondary",onClick:s[16]||(s[16]=o=>A.value=!A.value)},[e("i",{class:S(A.value?"fas fa-eye-slash":"fas fa-eye")},null,2)])])])]),s[51]||(s[51]=as('<div class="col-md-6" data-v-c7682163><div class="card bg-light border-0 h-100" data-v-c7682163><div class="card-body" data-v-c7682163><h6 class="card-title" data-v-c7682163><i class="fas fa-shield-alt text-primary me-2" data-v-c7682163></i>Bảo mật mật khẩu </h6><ul class="list-unstyled mb-0" data-v-c7682163><li class="mb-2" data-v-c7682163><i class="fas fa-check text-success me-2" data-v-c7682163></i> Sử dụng ít nhất 6 ký tự </li><li class="mb-2" data-v-c7682163><i class="fas fa-check text-success me-2" data-v-c7682163></i> Kết hợp chữ và số </li><li class="mb-2" data-v-c7682163><i class="fas fa-check text-success me-2" data-v-c7682163></i> Không sử dụng thông tin cá nhân </li><li class="mb-0" data-v-c7682163><i class="fas fa-check text-success me-2" data-v-c7682163></i> Thay đổi định kỳ </li></ul></div></div></div>',1))]),e("div",pe,[e("button",{type:"submit",class:"btn btn-primary",disabled:P.value},[P.value?y("",!0):(b(),f("i",ge)),P.value?(b(),f("span",be)):y("",!0),p(" "+h(P.value?"Đang cập nhật...":"Đổi mật khẩu"),1)],8,fe)])],32)],512),[[F,w.value==="password"]])])])])])])]))}},Pe=Q(ye,[["__scopeId","data-v-c7682163"]]);export{Pe as default};
