import{_ as Z,x as tt,r as k,R as nt,p as st,q as B,h as et,m as at,S as lt,c as i,a as n,g as r,l as p,f as h,t as o,d as f,F as G,e as U,i as ot,j as it,k as rt,T as K,A as I,o as c,z as ct}from"./index-tOYkc5Yr.js";const ut={class:"orders-page"},dt={class:"container mt-5 pt-5"},ht={class:"row"},gt={class:"col-12"},mt={class:"d-flex justify-content-between align-items-center mb-4"},ft={class:"d-flex gap-2"},pt=["disabled"],yt={class:"order-tabs mb-4"},vt={class:"nav nav-pills nav-fill"},bt={class:"nav-item"},kt={class:"nav-item"},_t={class:"nav-item"},Tt={class:"nav-item"},xt={key:0,class:"container"},Ht={key:1,class:"container"},wt={class:"row justify-content-center"},Ct={class:"col-md-8"},St={class:"alert alert-danger",role:"alert"},Kt={key:2,class:"container"},It={class:"row"},Dt={class:"col-12"},Pt={class:"tab-info mb-3"},At={class:"alert alert-info d-flex align-items-center"},Ot={key:0,class:"text-center py-5"},Et={class:"text-muted"},$t={class:"text-muted"},Bt={key:0},Lt={key:1},jt={key:2},Nt={key:3},Rt={key:1,class:"orders-list"},Mt={class:"order-header p-3 bg-light rounded-top"},Gt={class:"row align-items-center"},Ut={class:"col-md-6"},Vt={class:"mb-1"},Ft={class:"text-muted"},zt={class:"text-muted"},qt={class:"col-md-6 text-md-end"},Jt={class:"mt-2"},Xt={class:"text-success"},Yt={class:"order-items p-3"},Qt={class:"row"},Wt={class:"col-md-8"},Zt={class:"mb-3"},tn={key:0,class:"alert alert-info"},nn={key:1,class:"items-list"},sn={class:"item-image me-3"},en=["src","alt"],an={class:"item-details flex-grow-1"},ln={class:"fw-bold"},on={class:"text-muted"},rn={class:"text-muted"},cn={class:"item-total text-end"},un={class:"col-md-4"},dn={class:"order-summary"},hn={class:"summary-item d-flex justify-content-between mb-2"},gn={key:0,class:"summary-item d-flex justify-content-between mb-2 text-success"},mn={key:1,class:"summary-item d-flex justify-content-between mb-2 text-info"},fn={class:"summary-item d-flex justify-content-between mb-2 fw-bold"},pn={class:"text-success"},yn={key:2,class:"summary-item d-flex justify-content-between mb-2 text-muted"},vn={class:"order-footer p-3 bg-light rounded-bottom"},bn={class:"row align-items-center"},kn={class:"col-md-6"},_n={class:"text-muted"},Tn={class:"text-muted"},xn={class:"col-md-6 text-md-end"},Hn=["onClick","disabled"],wn=["onClick","disabled"],Cn={key:2,class:"text-muted"},Sn={key:3,class:"container"},Kn={class:"row justify-content-center"},In={class:"col-md-8 text-center"},Dn={class:"empty-state"},Pn={__name:"Orders",setup(An){const x=at();let L,j;try{const s=tt();L=s.user,j=s.isAuthenticated}catch(s){console.error("❌ useAuth failed:",s),L=k(null),j=k(!1)}let u,y,v,D,P;try{const s=nt();u=s.orders,y=s.loading,v=s.error,D=s.loadCustomerOrders,P=s.cancelOrder}catch(s){console.error("❌ useOrders failed:",s),u=k([]),y=k(!1),v=k(null),D=async()=>({success:!1,error:"useOrders not available"}),P=async()=>({success:!1,error:"cancelOrder not available"})}let A;try{A=st()}catch(s){console.error("❌ useCart failed:",s),A={maKH:null,isResolved:!1}}const g=k(null),m=k("pending");B(()=>u.value.length>0);const O=B(()=>{if(!u.value||u.value.length===0)return[];switch(m.value){case"pending":return u.value.filter(s=>(typeof s.trangThai=="string"?parseInt(s.trangThai):s.trangThai)===0);case"paid":return u.value.filter(s=>(typeof s.trangThai=="string"?parseInt(s.trangThai):s.trangThai)===1);case"completed":return u.value.filter(s=>(typeof s.trangThai=="string"?parseInt(s.trangThai):s.trangThai)===2);case"cancelled":return u.value.filter(s=>(typeof s.trangThai=="string"?parseInt(s.trangThai):s.trangThai)===3);default:return u.value.filter(s=>(typeof s.trangThai=="string"?parseInt(s.trangThai):s.trangThai)===0)}}),H=B(()=>{if(!u.value||u.value.length===0)return{pending:0,paid:0,completed:0,cancelled:0};const s={pending:0,paid:0,completed:0,cancelled:0};return u.value.forEach(t=>{switch(typeof t.trangThai=="string"?parseInt(t.trangThai):t.trangThai){case 0:s.pending++;break;case 1:s.paid++;break;case 2:s.completed++;break;case 3:s.cancelled++;break}}),s}),E=(s,t)=>s?.maKH?s.maKH:s?.customer?.maKH?s.customer.maKH:s?.result?.maKH?s.result.maKH:s?.data?.maKH?s.data.maKH:null,N=async()=>{try{const s=JSON.parse(localStorage.getItem("easymart-user"));if(!s)return null;if(s?.email)try{const l=K(),e=await fetch(`${I.BASE_URL}/api/khachhang/by-email/${encodeURIComponent(s.email)}`,{method:"GET",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},credentials:"include"});if(e.ok){const d=await e.json(),a=E(d,"email");if(a)return a}}catch{}const t=s?.id||s?.sub||s?.maNguoiDung;if(t&&t!=="OAUTH_USER")try{const l=K(),e=await fetch(`${I.BASE_URL}/api/khachhang/by-nguoidung/${t}`,{method:"GET",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},credentials:"include"});if(e.ok){const d=await e.json(),a=E(d,"User ID API");if(a)return a}}catch{}try{const l=K(),e=await fetch(`${I.BASE_URL}/api/khachhang/current`,{method:"GET",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},credentials:"include"});if(e.ok){const d=await e.json(),a=E(d,"current endpoint");if(a)return a}}catch{}return null}catch(s){return console.error("❌ Error getting maKH from API:",s),null}},b=async()=>{try{let s=A?.maKH||g.value?.maKH||g.value?.khachHang?.maKH;if(!s){const t=await N();if(t)s=t,g.value&&(g.value.maKH=t,g.value.khachHang={maKH:t});else{v.value="Không thể xác định thông tin khách hàng. Vui lòng đăng nhập lại hoặc cập nhật thông tin cá nhân trong trang Profile.";return}}await D(s)}catch(s){console.error("❌ Error loading orders:",s),v.value=s.message||"Có lỗi xảy ra khi tải danh sách đơn hàng"}},V=()=>{x.push("/profile")},R=async()=>{try{const s=await N();return s?(g.value&&(g.value.maKH=s,g.value.khachHang={maKH:s}),await b(),!0):!1}catch(s){return console.error("❌ Error refreshing customer info:",s),!1}},F=s=>{if(!s)return"/placeholder-image.jpg";const t=ct.IMAGES.PRODUCT_IMAGES(s);return t[0]?`${I.BASE_URL}${t[0]}`:"/placeholder-image.jpg"},z=s=>{s.target.src="/placeholder-image.jpg"},q=s=>{if(!s)return"N/A";try{return new Date(s).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return s}},_=s=>s==null?"0 ₫":new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(s),J=s=>{const t=typeof s=="string"?parseInt(s):s;return{0:"badge bg-warning text-dark",1:"badge bg-success",2:"badge bg-info",3:"badge bg-danger",4:"badge bg-secondary"}[t]||"badge bg-secondary"},$=s=>{const t=typeof s=="string"?parseInt(s):s;return{0:"Chờ thanh toán",1:"Đã thanh toán",2:"Đang xử lý",3:"Đã hủy",4:"Hoàn trả"}[t]||`Không xác định (${s})`},w=s=>(typeof s=="string"?parseInt(s):s)===0,X=async()=>{try{u.value=[],await b()}catch(s){console.error("❌ Error refreshing orders:",s),alert("Có lỗi xảy ra khi làm mới danh sách đơn hàng!")}},T=s=>{m.value=s},C=s=>m.value===s?"nav-link active":"nav-link",S=s=>{const t="badge rounded-pill ms-2";switch(s){case"pending":return`${t} bg-warning text-dark`;case"paid":return`${t} bg-success`;case"completed":return`${t} bg-info`;case"cancelled":return`${t} bg-danger`;default:return`${t} bg-warning text-dark`}},M=s=>{switch(s){case"pending":return"chờ thanh toán";case"paid":return"đã thanh toán";case"completed":return"hoàn thành";case"cancelled":return"đã hủy";default:return"chờ thanh toán"}},Y=async s=>{try{if(!s){alert("Không có mã đơn hàng để checkout!");return}const t=u.value.find(l=>l.maHD===s);if(t){if(t.trangThai!==0){alert("Chỉ có thể checkout đơn hàng đang chờ thanh toán!");return}const l={maHD:t.maHD,tongTien:t.tongTien,chiTietHoaDon:t.chiTietHoaDon||t.chiTietList||[],timestamp:new Date().toISOString(),source:"orders-page"},e=(t.chiTietHoaDon||t.chiTietList||[]).map(d=>d.sanPham?.maSP||d.maSP).filter(Boolean);localStorage.setItem("easymart-invoice",JSON.stringify(l)),localStorage.setItem("easymart-selected-items",JSON.stringify(e)),console.log("✅ Saved to localStorage:",{invoice:l,selectedItems:e}),x.push("/checkout")}else alert("Không tìm thấy thông tin đơn hàng!")}catch(t){console.error("❌ Error during checkout:",t),alert("Không thể chuyển đến trang checkout. Vui lòng thử lại!")}},Q=async s=>{const t=u.value.find(l=>l.maHD===s);if(!t){alert("Không tìm thấy đơn hàng!");return}if(!w(t.trangThai)){const l=$(t.trangThai);alert(`Không thể hủy đơn hàng này. Trạng thái hiện tại: ${l}`);return}if(confirm("Bạn có chắc chắn muốn hủy đơn hàng này?"))try{console.log("❌ Cancelling order:",s),await P(s,"Khách hàng yêu cầu hủy đơn hàng"),console.log("🔄 Refreshing orders after successful cancellation..."),await b(),alert("Đã hủy đơn hàng thành công!"),console.log("✅ Order cancelled and UI updated successfully")}catch(l){console.error("❌ Error cancelling order:",l);let e=l.message||"Lỗi không xác định",d=!1;e.includes("đã được hủy trước đó")||e.includes("already cancelled")||e.includes("đã hủy")||e.includes("cancelled")?(e="Đơn hàng này đã được hủy trước đó.",d=!0):e.includes("không thể hủy")||e.includes("cannot cancel")||e.includes("không được phép")||e.includes("not allowed")?(e="Không thể hủy đơn hàng này do trạng thái hiện tại không cho phép.",d=!0):e.includes("Bad Request")||e.includes("400")?(e="Yêu cầu hủy đơn hàng không hợp lệ. Có thể đơn hàng đã được xử lý hoặc không tồn tại.",d=!0):e.includes("Unauthorized")||e.includes("401")?e="Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.":e.includes("Forbidden")||e.includes("403")?e="Bạn không có quyền hủy đơn hàng này.":(e.includes("Not Found")||e.includes("404"))&&(e="Không tìm thấy đơn hàng này.",d=!0),alert(`Không thể hủy đơn hàng: ${e}`),d&&(console.log("🔄 Auto-refreshing orders due to error..."),setTimeout(()=>{b()},2e3))}},W=()=>{const s=localStorage.getItem("easymart-user"),t=K();return s&&t};return et(async()=>{try{if(!W()){x.push("/login");return}const t=JSON.parse(localStorage.getItem("easymart-user")||"null");if(!t){x.push("/login");return}g.value=t,await R()||await b();const e=setInterval(async()=>{try{await b()}catch(a){console.warn("⚠️ Auto-refresh failed:",a.message)}},3e4);lt(()=>{e&&clearInterval(e)})}catch(s){console.error("❌ Error in onMounted:",s),v.value="Có lỗi xảy ra khi khởi tạo trang. Vui lòng thử lại."}}),(s,t)=>{const l=rt("router-link");return c(),i("div",ut,[n("div",dt,[n("div",ht,[n("div",gt,[n("div",mt,[t[6]||(t[6]=n("h1",{class:"text-primary mb-0"},[n("i",{class:"fas fa-box me-3"}),r("Đơn hàng của tôi ")],-1)),n("div",ft,[n("button",{onClick:X,class:"btn btn-outline-primary",disabled:p(y)},[n("i",{class:h(["fas fa-sync-alt me-2",{"fa-spin":p(y)}])},null,2),t[5]||(t[5]=r(" Làm mới "))],8,pt)])]),n("div",yt,[n("ul",vt,[n("li",bt,[n("button",{class:h(C("pending")),onClick:t[0]||(t[0]=e=>T("pending"))},[t[7]||(t[7]=n("i",{class:"fas fa-clock me-2"},null,-1)),t[8]||(t[8]=r("Chờ thanh toán ")),n("span",{class:h(S("pending"))},o(H.value.pending),3)],2)]),n("li",kt,[n("button",{class:h(C("paid")),onClick:t[1]||(t[1]=e=>T("paid"))},[t[9]||(t[9]=n("i",{class:"fas fa-check-circle me-2"},null,-1)),t[10]||(t[10]=r("Đã thanh toán ")),n("span",{class:h(S("paid"))},o(H.value.paid),3)],2)]),n("li",_t,[n("button",{class:h(C("completed")),onClick:t[2]||(t[2]=e=>T("completed"))},[t[11]||(t[11]=n("i",{class:"fas fa-shipping-fast me-2"},null,-1)),t[12]||(t[12]=r("Hoàn thành ")),n("span",{class:h(S("completed"))},o(H.value.completed),3)],2)]),n("li",Tt,[n("button",{class:h(C("cancelled")),onClick:t[3]||(t[3]=e=>T("cancelled"))},[t[13]||(t[13]=n("i",{class:"fas fa-times-circle me-2"},null,-1)),t[14]||(t[14]=r("Đã hủy ")),n("span",{class:h(S("cancelled"))},o(H.value.cancelled),3)],2)])])])])])]),p(y)?(c(),i("div",xt,t[15]||(t[15]=[n("div",{class:"row justify-content-center"},[n("div",{class:"col-md-8 text-center"},[n("div",{class:"spinner-border text-primary",role:"status"},[n("span",{class:"visually-hidden"},"Đang tải...")]),n("p",{class:"mt-3 text-muted"},"Đang tải danh sách đơn hàng...")])],-1)]))):p(v)?(c(),i("div",Ht,[n("div",wt,[n("div",Ct,[n("div",St,[t[19]||(t[19]=n("i",{class:"fas fa-exclamation-triangle me-2"},null,-1)),t[20]||(t[20]=n("strong",null,"Lỗi:",-1)),r(" "+o(p(v))+" ",1),n("div",{class:"mt-3"},[n("button",{onClick:b,class:"btn btn-outline-danger btn-sm me-2"},t[16]||(t[16]=[n("i",{class:"fas fa-redo me-1"},null,-1),r("Thử lại ")])),n("button",{onClick:R,class:"btn btn-outline-info btn-sm me-2"},t[17]||(t[17]=[n("i",{class:"fas fa-sync-alt me-1"},null,-1),r("Làm mới thông tin khách hàng ")])),n("button",{onClick:V,class:"btn btn-primary btn-sm"},t[18]||(t[18]=[n("i",{class:"fas fa-user-edit me-1"},null,-1),r("Cập nhật thông tin cá nhân ")]))])])])])])):p(u).length>0?(c(),i("div",Kt,[n("div",It,[n("div",Dt,[n("div",Pt,[n("div",At,[t[21]||(t[21]=n("i",{class:"fas fa-info-circle me-2"},null,-1)),n("span",null,[r(" Hiển thị "+o(O.value.length)+" đơn hàng ",1),n("strong",null,o(M(m.value)),1)])])]),O.value.length===0?(c(),i("div",Ot,[t[23]||(t[23]=n("i",{class:"fas fa-inbox fa-3x text-muted mb-3"},null,-1)),n("h4",Et,"Không có đơn hàng "+o(M(m.value).toLowerCase()),1),n("p",$t,[m.value==="pending"?(c(),i("span",Bt,"Bạn chưa có đơn hàng nào đang chờ thanh toán.")):m.value==="paid"?(c(),i("span",Lt,"Bạn chưa có đơn hàng nào đã thanh toán.")):m.value==="completed"?(c(),i("span",jt,"Bạn chưa có đơn hàng nào hoàn thành.")):m.value==="cancelled"?(c(),i("span",Nt,"Bạn chưa có đơn hàng nào bị hủy.")):f("",!0)]),n("button",{onClick:t[4]||(t[4]=e=>T("pending")),class:"btn btn-outline-primary"},t[22]||(t[22]=[n("i",{class:"fas fa-clock me-2"},null,-1),r("Xem đơn hàng chờ thanh toán ")]))])):(c(),i("div",Rt,[(c(!0),i(G,null,U(O.value,(e,d)=>(c(),i("div",{key:e.maHD,class:"order-card mb-4"},[n("div",Mt,[n("div",Gt,[n("div",Ut,[n("h5",Vt,[t[24]||(t[24]=n("i",{class:"fas fa-receipt me-2 text-primary"},null,-1)),r(" Hóa đơn #"+o(d+1),1)]),n("small",Ft,[t[25]||(t[25]=n("i",{class:"fas fa-calendar me-1"},null,-1)),r(" "+o(q(e.ngayLap)),1)]),t[27]||(t[27]=n("br",null,null,-1)),n("small",zt,[t[26]||(t[26]=n("i",{class:"fas fa-hashtag me-1"},null,-1)),r(" Mã: "+o(e.maHD),1)])]),n("div",qt,[n("span",{class:h(J(e.trangThai))},o($(e.trangThai)),3),n("div",Jt,[n("strong",Xt,o(_(e.tongTien)),1)])])])]),n("div",Yt,[n("div",Qt,[n("div",Wt,[n("h6",Zt,[t[28]||(t[28]=n("i",{class:"fas fa-shopping-bag me-2 text-info"},null,-1)),r(" Sản phẩm đã đặt ("+o(e.chiTietHoaDon?.length||0)+") ",1)]),!e.chiTietHoaDon||e.chiTietHoaDon.length===0?(c(),i("div",tn,t[29]||(t[29]=[n("i",{class:"fas fa-info-circle me-2"},null,-1),n("strong",null,"Không có sản phẩm trong đơn hàng này",-1),n("br",null,null,-1),n("small",{class:"text-muted"},"Đơn hàng có thể đã được xử lý hoặc chưa có chi tiết sản phẩm.",-1)]))):f("",!0),e.chiTietHoaDon&&e.chiTietHoaDon.length>0?(c(),i("div",nn,[(c(!0),i(G,null,U(e.chiTietHoaDon,a=>(c(),i("div",{key:a.maCTHD||a.id,class:"item-row d-flex align-items-center py-2 border-bottom"},[n("div",sn,[n("img",{src:F(a.sanPham?.maSP||a.maSP),alt:a.sanPham?.tenSP||a.tenSP||"Sản phẩm",class:"rounded",style:{width:"50px",height:"50px","object-fit":"cover"},onError:z},null,40,en)]),n("div",an,[n("div",ln,o(a.sanPham?.tenSP||a.tenSP||"Tên sản phẩm"),1),n("small",on," Mã SP: "+o(a.sanPham?.maSP||a.maSP||"N/A"),1),t[30]||(t[30]=n("br",null,null,-1)),n("small",rn," Số lượng: "+o(a.soLuong)+" x "+o(_(a.donGiaBan||a.donGia)),1)]),n("div",cn,[n("strong",null,o(_(a.thanhTienSauGiam||a.thanhTien||(a.donGiaBan||a.donGia)*a.soLuong)),1)])]))),128))])):f("",!0)]),n("div",un,[n("div",dn,[t[36]||(t[36]=n("h6",{class:"mb-3"},[n("i",{class:"fas fa-calculator me-2 text-warning"}),r(" Tổng quan ")],-1)),n("div",hn,[t[31]||(t[31]=n("span",null,"Tổng tiền hàng:",-1)),n("span",null,o(_(e.tongTienHang)),1)]),e.tienGiamGia>0?(c(),i("div",gn,[t[32]||(t[32]=n("span",null,"Giảm giá:",-1)),n("span",null,"-"+o(_(e.tienGiamGia)),1)])):f("",!0),e.khuyenMai?(c(),i("div",mn,[t[33]||(t[33]=n("span",null,"Khuyến mãi:",-1)),n("span",null,o(e.khuyenMai.tenChuongTrinh),1)])):f("",!0),t[37]||(t[37]=n("hr",null,null,-1)),n("div",fn,[t[34]||(t[34]=n("span",null,"Tổng thanh toán:",-1)),n("span",pn,o(_(e.tongTien)),1)]),e.diemTichLuy?(c(),i("div",yn,[t[35]||(t[35]=n("small",null,"Điểm tích lũy:",-1)),n("small",null,"+"+o(e.diemTichLuy)+" điểm",1)])):f("",!0)])])])]),n("div",vn,[n("div",bn,[n("div",kn,[n("small",_n,[t[38]||(t[38]=n("i",{class:"fas fa-user me-1"},null,-1)),r(" "+o(e.khachHang?.hoTen||"Khách hàng"),1)]),t[40]||(t[40]=n("br",null,null,-1)),n("small",Tn,[t[39]||(t[39]=n("i",{class:"fas fa-map-marker-alt me-1"},null,-1)),r(" "+o(e.khachHang?.diaChi||"Địa chỉ giao hàng"),1)])]),n("div",xn,[w(e.trangThai)?(c(),i("button",{key:0,onClick:a=>Y(e.maHD),class:"btn btn-success btn-sm me-2",disabled:p(y)},t[41]||(t[41]=[n("i",{class:"fas fa-credit-card me-1"},null,-1),r("Checkout ")]),8,Hn)):f("",!0),w(e.trangThai)?(c(),i("button",{key:1,onClick:a=>Q(e.maHD),class:"btn btn-outline-danger btn-sm",disabled:p(y)},t[42]||(t[42]=[n("i",{class:"fas fa-times me-1"},null,-1),r("Hủy đơn ")]),8,wn)):f("",!0),w(e.trangThai)?f("",!0):(c(),i("small",Cn,[t[43]||(t[43]=n("i",{class:"fas fa-info-circle me-1"},null,-1)),r(" "+o($(e.trangThai)),1)]))])])])]))),128))]))])])])):(c(),i("div",Sn,[n("div",Kn,[n("div",In,[n("div",Dn,[t[45]||(t[45]=n("i",{class:"fas fa-box-open fa-4x text-muted mb-4"},null,-1)),t[46]||(t[46]=n("h3",{class:"text-muted"},"Chưa có đơn hàng nào",-1)),t[47]||(t[47]=n("p",{class:"text-muted mb-4"}," Bạn chưa có đơn hàng nào. Hãy mua sắm và tạo đơn hàng đầu tiên! ",-1)),ot(l,{to:"/",class:"btn btn-primary"},{default:it(()=>t[44]||(t[44]=[n("i",{class:"fas fa-shopping-cart me-2"},null,-1),r("Mua sắm ngay ")])),_:1,__:[44]})])])])]))])}}},En=Z(Pn,[["__scopeId","data-v-51d35564"]]);export{En as default};
